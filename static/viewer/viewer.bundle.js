import*as tt from"/lib/family-tree.esm.js";var ve=document.getElementById("status"),_=document.getElementById("personDetails"),T=document.getElementById("personSearch"),Le=document.getElementById("personSearchHint"),Ae=document.querySelector('[data-role="viewer-search"]'),_e=document.querySelector('[data-role="viewer-search-empty"]'),w=_==null?void 0:_.querySelector(".detail-list"),P=_==null?void 0:_.querySelector(".summary"),te=_==null?void 0:_.querySelector(".empty"),Ue="#FamilyChart",ie=document.getElementById("viewerAncestryDepth"),se=document.getElementById("viewerProgenyDepth"),ae=document.getElementById("viewerMiniTree"),oe=document.getElementById("viewerDuplicateToggle"),le=document.querySelector('[data-role="dataset-meta"]'),Xe=document.querySelector('[data-role="visible-count"]'),Ye=document.querySelector('[data-role="branch-count"]'),Ge=document.querySelector('[data-role="total-count"]');function Fe(e){return e==null?"":String(e).trim().toLowerCase()}function ut(e){if(!Array.isArray(e))return[];let t=new Set,r=[];return e.forEach(n=>{if(typeof n!="string")return;let i=n.trim();if(!i)return;let o=Fe(i);t.has(o)||(t.add(o),r.push(i))}),r}function me(e){return typeof e=="string"?e.trim():""}function nt(e={}){let t=e.data||{},r=me(t["first name"]),n=me(t["last name"]),i=r||n?[r,n].filter(Boolean).join(" ").trim():e.id?`Profil ${e.id}`:"Profil sans nom",o=me(t.birthday);return o?`${i} (${o})`:i}function dt(e){if(!e||typeof e.id!="string"||!e.id.trim())return null;let t=nt(e),r=new Set,n=[],i=new Set,o=l=>{if(typeof l!="string")return;let u=l.trim();u&&r.add(u)},a=l=>{if(typeof l!="string")return;let u=l.trim();u&&(i.has(u)||(i.add(u),n.push(u)))};o(t),o(String(e.id));let s=e.data&&typeof e.data=="object"?e.data:{};Object.entries(s).forEach(([l,u])=>{if(typeof u!="string")return;let d=u.trim();if(!d)return;o(d);let p=Fe(l);if(p==="birthday"){a(d);return}if(p==="death"){a(`\u271D ${d}`);return}if(p==="maiden name"){a(`(${d})`);return}if(p==="occupation"){a(d);return}(p==="location"||p==="residence"||p==="birthplace"||p==="deathplace")&&a(d)});let f=Array.from(r).map(l=>l.replace(/\s+/g," ").trim()).filter(Boolean).join(" | ");return{label:t,value:e.id,searchText:f,optionHtml:l=>{let u=n.length?`<small>${n.join(" \xB7 ")}</small>`:"";return`<div>${l.label_html||l.label}${u?`<div class="f3-autocomplete-meta">${u}</div>`:""}</div>`}}}function ft(e){if(!Array.isArray(e))return[];let t=[],r=new Set;return e.forEach(n=>{if(!n||!n.id||r.has(n.id))return;let i=dt(n);i&&(t.push(i),r.add(n.id))}),t.sort((n,i)=>n.label.localeCompare(i.label,"fr",{sensitivity:"base"})),t}function ue(e){Ae&&(e?Ae.dataset.state=String(e):delete Ae.dataset.state,_e&&(e==="error"?_e.textContent="Impossible de charger la recherche pour le moment.":_e.textContent="Aucune personne disponible pour le moment."))}var Qe=["first name","last name","birthday","death","gender","avatar","bio"],Je={"first name":"Pr\xE9nom","last name":"Nom",nickname:"Surnom","maiden name":"Nom de jeune fille",birthday:"Date de naissance",death:"Date de D\xE9c\xE8s",gender:"Genre",location:"Localisation",birthplace:"Lieu de naissance",deathplace:"Lieu de d\xE9c\xE8s",occupation:"Profession",bio:"Biographie",notes:"Notes",email:"Email",phone:"T\xE9l\xE9phone",avatar:"Avatar"},pt={M:"Masculin",F:"F\xE9minin",O:"Autre",X:"Non binaire"},V="Non renseign\xE9",De=[["first name","last name"],["birthday"]],A=Object.freeze({transitionTime:200,cardXSpacing:240,cardYSpacing:140,orientation:"vertical",showSiblingsOfMain:!0,singleParentEmptyCard:!0,singleParentEmptyCardLabel:"Inconnu",ancestryDepth:4,progenyDepth:4,miniTree:!0,duplicateBranchToggle:!0,cardDisplay:De.map(e=>[...e]),mainId:null}),mt=4,ht=12,m=null,E=null,c={...A},ce=0,B=!1,g={mainId:null,ancestryDepth:A.ancestryDepth,progenyDepth:A.progenyDepth,includeSiblings:!0,includeSpouses:!0},G=null,Y={total:0,returned:0,includeSiblings:!0,includeSpouses:!0},ne=null,pe=null,X=null,Me=[],be=[],de=[],ee={source:"initial",label:null},he=new Map,Ie=null,re={visible:-1,branch:-1,total:-1},Ce={message:"",type:""};function yt(e){let r=(Array.isArray(e)?e:[]).slice(0,2).map(n=>ut(Array.isArray(n)?n:[]));for(;r.length<2;)r.push([]);return r}function Pe(e){if(Array.isArray(e))return{data:e,config:{},meta:{}};if(e&&typeof e=="object"){let t=e.meta&&typeof e.meta=="object"?e.meta:{};if(Array.isArray(e.data)){let r=e.config||e.settings||{};return{data:e.data,config:r,meta:t}}if(Array.isArray(e.tree)){let r=e.config||e.settings||{};return{data:e.tree,config:r,meta:t}}}return{data:[],config:{},meta:{}}}function gt(e={}){var b,I,C,M,j,J,x,k,R,v,K,$,W,N,Z,h,F,S,q,H,L,z,U,je,xe,ke,Re,qe,He,ze;if(!e||typeof e!="object")return{};let t={},r=(b=e.transitionTime)!=null?b:e.transition_time;typeof r=="number"&&Number.isFinite(r)&&(t.transitionTime=r);let n=(C=(I=e.cardXSpacing)!=null?I:e.card_x_spacing)!=null?C:e.node_separation;typeof n=="number"&&Number.isFinite(n)&&(t.cardXSpacing=n);let i=(j=(M=e.cardYSpacing)!=null?M:e.card_y_spacing)!=null?j:e.level_separation;typeof i=="number"&&Number.isFinite(i)&&(t.cardYSpacing=i);let o=e.orientation;o==="horizontal"||o==="vertical"?t.orientation=o:typeof e.is_horizontal=="boolean"&&(t.orientation=e.is_horizontal?"horizontal":"vertical");let a=(J=e.showSiblingsOfMain)!=null?J:e.show_siblings_of_main;typeof a=="boolean"&&(t.showSiblingsOfMain=a);let s=(x=e.singleParentEmptyCard)!=null?x:e.single_parent_empty_card;typeof s=="boolean"&&(t.singleParentEmptyCard=s);let f=(k=e.singleParentEmptyCardLabel)!=null?k:e.single_parent_empty_card_label;typeof f=="string"&&f.trim().length>0&&(t.singleParentEmptyCardLabel=f.trim());let l=(R=e.cardDisplay)!=null?R:e.card_display;if(Array.isArray(l)||l&&typeof l=="object"){let O=l;l&&!Array.isArray(l)&&typeof l=="object"&&(O=[(h=(Z=(N=(W=($=(K=(v=l[0])!=null?v:l[0])!=null?K:l.row1)!=null?$:l.row_1)!=null?W:l.ligne1)!=null?N:l.line1)!=null?Z:l.first)!=null?h:[],(U=(z=(L=(H=(q=(S=(F=l[1])!=null?F:l[1])!=null?S:l.row2)!=null?q:l.row_2)!=null?H:l.ligne2)!=null?L:l.line2)!=null?z:l.second)!=null?U:[]]),t.cardDisplay=yt(O)}let u=(ke=(xe=(je=e.mainId)!=null?je:e.main_id)!=null?xe:e.mainPersonId)!=null?ke:e.main_person_id;typeof u=="string"&&u.trim().length>0&&(t.mainId=u.trim());let d=(Re=e.ancestryDepth)!=null?Re:e.ancestry_depth;if(d===null)t.ancestryDepth=null;else if(d!==void 0){let O=Number(d);Number.isFinite(O)&&O>=0&&(t.ancestryDepth=Math.floor(O))}let p=(qe=e.progenyDepth)!=null?qe:e.progeny_depth;if(p===null)t.progenyDepth=null;else if(p!==void 0){let O=Number(p);Number.isFinite(O)&&O>=0&&(t.progenyDepth=Math.floor(O))}let y=(He=e.miniTree)!=null?He:e.mini_tree;typeof y=="boolean"&&(t.miniTree=y);let D=(ze=e.duplicateBranchToggle)!=null?ze:e.duplicate_branch_toggle;return typeof D=="boolean"&&(t.duplicateBranchToggle=D),t}function bt(e,t){let r=gt(t),n={...A,...r},i=r.cardDisplay;return n.cardDisplay=i&&i.length?i.map(o=>[...o]):De.map(o=>[...o]),e.setTransitionTime(n.transitionTime),e.setCardXSpacing(n.cardXSpacing),e.setCardYSpacing(n.cardYSpacing),e.setShowSiblingsOfMain(n.showSiblingsOfMain),n.orientation==="horizontal"?e.setOrientationHorizontal():e.setOrientationVertical(),e.setSingleParentEmptyCard(n.singleParentEmptyCard,{label:n.singleParentEmptyCardLabel}),typeof n.ancestryDepth=="number"&&Number.isFinite(n.ancestryDepth)?e.setAncestryDepth(n.ancestryDepth):e.setAncestryDepth(null),typeof n.progenyDepth=="number"&&Number.isFinite(n.progenyDepth)?e.setProgenyDepth(n.progenyDepth):e.setProgenyDepth(null),e.setDuplicateBranchToggle(n.duplicateBranchToggle!==!1),n}function Ke(e){if(e!=="auto"){if(e==="all"||e===null)return"all";if(typeof e=="number"&&Number.isFinite(e)&&e>=0)return String(Math.floor(e))}}function Dt(e){let t=new URLSearchParams;t.set("mode","subtree"),e.mainId&&typeof e.mainId=="string"&&t.set("mainId",e.mainId);let r=Ke(e.ancestryDepth);r!==void 0&&t.set("ancestryDepth",r);let n=Ke(e.progenyDepth);return n!==void 0&&t.set("progenyDepth",n),e.includeSiblings!==void 0&&t.set("includeSiblings",e.includeSiblings?"true":"false"),e.includeSpouses!==void 0&&t.set("includeSpouses",e.includeSpouses?"true":"false"),t.toString()}function Se(e){let t=!!e;le&&le.classList.toggle("is-loading",t),T&&T.classList.toggle("is-loading",t)}function rt(){ne&&(ne.abort(),ne=null)}function Oe(e,t=0,r=t){let n=e&&typeof e=="object"?e:{},i=Number.isFinite(n.total)?Math.max(0,Math.floor(n.total)):Math.max(0,Math.floor(t)),o=Number.isFinite(n.returned)?Math.max(0,Math.floor(n.returned)):Math.max(0,Math.floor(r)),a=n.ancestryDepth===null?null:Number.isFinite(n.ancestryDepth)?Math.max(0,Math.floor(n.ancestryDepth)):void 0,s=n.progenyDepth===null?null:Number.isFinite(n.progenyDepth)?Math.max(0,Math.floor(n.progenyDepth)):void 0;return{total:i,returned:o,includeSiblings:n.includeSiblings!==!1,includeSpouses:n.includeSpouses!==!1,ancestryDepth:a,progenyDepth:s}}function St(e){return G?["mainId","ancestryDepth","progenyDepth","includeSiblings","includeSpouses"].some(r=>{let n=G[r],i=e[r];return!(n===i||n===null&&i===void 0||n===void 0&&i===null)}):!0}function Et(e){let t=typeof e.label=="string"&&e.label.trim()?e.label.trim():`Profil ${e.id}`,r=new Set,n=[],i=new Set,o=u=>{if(typeof u!="string")return;let d=u.trim();d&&r.add(d)},a=u=>{if(typeof u!="string")return;let d=u.trim();if(!d)return;let p=d.toLowerCase();i.has(p)||(i.add(p),n.push(d))},s=(u,d)=>{if(typeof d!="string")return;let p=d.trim();if(!p)return;o(p);let y=Fe(u);if(y==="birthday"){a(p);return}if(y==="death"){a(`\u271D ${p}`);return}if(y==="maiden name"){a(`(${p})`);return}if(y==="location"||y==="residence"||y==="birthplace"||y==="deathplace"){a(p);return}};o(t),o(String(e.id||"")),typeof e.searchText=="string"&&e.searchText.trim()&&e.searchText.split("|").forEach(u=>o(u)),s("birthday",e.birthday),s("death",e.death),s("location",e.location),s("residence",e.residence),s("maiden name",e.maidenName),e.fields&&typeof e.fields=="object"&&Object.entries(e.fields).forEach(([u,d])=>{s(u,d)});let f=Array.from(r).map(u=>u.replace(/\s+/g," ").trim()).filter(Boolean),l=f.length?f.join(" | "):t;return{label:t,value:e.id,searchText:l,optionHtml:u=>{let d=u.label_html||u.label,p=n.length?`<small>${n.join(" \xB7 ")}</small>`:"";return`<div>${d}${p?`<div class="f3-autocomplete-meta">${p}</div>`:""}</div>`}}}function Pt(e){if(!e||!Array.isArray(e.persons))return[];let t=e.persons.filter(r=>r&&typeof r.id=="string").map(r=>Et(r));return t.sort((r,n)=>r.label.localeCompare(n.label,"fr",{sensitivity:"base"})),t}function $e(){let e=new Map,t=n=>{if(!n||!n.value)return;if(!e.has(n.value)){e.set(n.value,{...n});return}let i=e.get(n.value),o=r(i.searchText,n.searchText);o&&(i.searchText=o),typeof i.optionHtml!="function"&&typeof n.optionHtml=="function"&&(i.optionHtml=n.optionHtml)},r=(n,i)=>{let o=new Set,a=s=>{typeof s=="string"&&s.split("|").forEach(f=>{let l=f.trim();l&&o.add(l)})};return a(n),a(i),o.size?Array.from(o).join(" | "):n||i||""};be.forEach(t),Me.forEach(t),de=Array.from(e.values()),de.sort((n,i)=>n.label.localeCompare(i.label,"fr",{sensitivity:"base"})),m&&ye(m)}function Tt(e){if(!e||!e.store||typeof e.store.getData!="function"){be=[],$e();return}try{let t=e.store.getData();be=ft(t)}catch(t){console.warn("[viewer] Impossible de reconstruire l\u2019index local de recherche",t),be=[]}$e()}function vt(e){ue(e),T&&(e?T.dataset.state=String(e):T.dataset.state="")}async function it(e=!1){if(!e&&X)return X;if(!e&&pe)return pe;vt("loading");let t=new AbortController,r=fetch("/api/tree/summary",{cache:"no-store",signal:t.signal}).then(n=>{if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()}).then(n=>(X=n,he=new Map,Array.isArray(n==null?void 0:n.persons)&&n.persons.forEach(i=>{i&&typeof i.id=="string"&&he.set(i.id,i)}),Me=Pt(n),ue(Me.length?"ready":"empty"),$e(),X)).catch(n=>{if(n.name==="AbortError")return X;throw console.error("Impossible de charger l'index de recherche",n),ue("error"),n}).finally(()=>{pe===r&&(pe=null)});return pe=r,r}function ye(e){if(!e||!e.personSearch)return;let t=Array.isArray(de)?de:[];e.personSearch.setOptionsGetter(()=>t),t.length?ue("ready"):X&&ue("empty")}function Q(e,t="info"){ve&&(Ce.message===e&&Ce.type===t||(Ce={message:e,type:t},ve.textContent=e,ve.dataset.status=t))}function We(e,t){return e==="auto"?"auto":e==="all"||e===null?"all":typeof e=="number"&&Number.isFinite(e)&&e>=0?String(Math.floor(e)):typeof t=="number"&&Number.isFinite(t)&&t>=0?String(Math.floor(t)):t==="auto"?"auto":t==="all"||t===null?"all":"auto"}function Ze(e,t){if(!e)return t;let r=e.value;if(r==="auto")return"auto";if(r==="all"||r==="")return"all";let n=Number(r);return Number.isFinite(n)&&n>=0?Math.floor(n):t}function Be(e){ie&&(ie.value=We(e.ancestryDepth,A.ancestryDepth)),se&&(se.value=We(e.progenyDepth,A.progenyDepth)),ae&&(ae.checked=e.miniTree!==!1),oe&&(oe.checked=e.duplicateBranchToggle!==!1)}function we(){if(Ie!==null)return;Ie=(typeof requestAnimationFrame=="function"?requestAnimationFrame:t=>setTimeout(t,16))(()=>{var n,i,o,a,s;Ie=null;let t=(s=(a=(o=(i=(n=m==null?void 0:m.store)==null?void 0:n.getTree)==null?void 0:i.call(n))==null?void 0:o.data)==null?void 0:a.length)!=null?s:0,r=Number.isFinite(Y.returned)?Y.returned:t;re.visible===t&&re.branch===r&&re.total===ce||(re.visible=t,re.branch=r,re.total=ce,Xe&&(Xe.textContent=String(t)),Ye&&(Ye.textContent=String(r)),Ge&&(Ge.textContent=String(ce)),le&&(le.dataset.visible=String(t),le.dataset.total=String(ce),le.dataset.branch=String(r)))})}function Ee({treePosition:e="inherit",initial:t=!1}={}){if(!m)return;typeof c.ancestryDepth=="number"&&Number.isFinite(c.ancestryDepth)?m.setAncestryDepth(c.ancestryDepth):m.setAncestryDepth(null),typeof c.progenyDepth=="number"&&Number.isFinite(c.progenyDepth)?m.setProgenyDepth(c.progenyDepth):m.setProgenyDepth(null),m.setDuplicateBranchToggle(c.duplicateBranchToggle!==!1),E&&typeof E.setMiniTree=="function"&&E.setMiniTree(c.miniTree!==!1),B=!0,Be(c),B=!1;let r="inherit";(e==="fit"||e==="main_to_middle")&&(r=e),m.updateTree({initial:t,tree_position:r}),we()}function Lt(){ie==null||ie.addEventListener("change",()=>{var r,n;if(B)return;let e=(n=(r=c.ancestryDepth)!=null?r:A.ancestryDepth)!=null?n:null,t=Ze(ie,e);t!==c.ancestryDepth&&(c={...c,ancestryDepth:t},fe({ancestryDepth:t},{reason:"ancestry-depth-change",source:"controls",reposition:!1,treePosition:"inherit",preservePreferences:!0}))}),se==null||se.addEventListener("change",()=>{var r,n;if(B)return;let e=(n=(r=c.progenyDepth)!=null?r:A.progenyDepth)!=null?n:null,t=Ze(se,e);t!==c.progenyDepth&&(c={...c,progenyDepth:t},fe({progenyDepth:t},{reason:"progeny-depth-change",source:"controls",reposition:!1,treePosition:"inherit",preservePreferences:!0}))}),ae==null||ae.addEventListener("change",()=>{if(B)return;let e=ae.checked,t=c.miniTree!==!1;e!==t&&(c={...c,miniTree:e},Ee({treePosition:"inherit"}))}),oe==null||oe.addEventListener("change",()=>{if(B)return;let e=oe.checked,t=c.duplicateBranchToggle!==!1;e!==t&&(c={...c,duplicateBranchToggle:e},Ee({treePosition:"inherit"}))})}Lt();function ge(e){if(!e||typeof e!="string")return null;if(he&&he.has(e)){let t=he.get(e);if(t&&typeof t.label=="string"&&t.label.trim())return t.label.trim()}return null}function Ve(e){return e==="auto"?"auto (progressif)":e==="all"||e===null?"sans limite":typeof e=="number"&&Number.isFinite(e)?e===0?"profil seul":`${Math.floor(e)}`:"auto (progressif)"}function At(e){let t=Ve(e.ancestryDepth),r=Ve(e.progenyDepth);return`Ancetres: ${t}, Descendants: ${r}`}async function fe(e={},t={}){let r={...g,...e};if(!St(r)&&!t.force){ee={source:t.source||ee.source,label:t.selectedLabel||ee.label};return}g={...r},ee={source:t.source||"system",label:t.selectedLabel||ge(r.mainId)||ee.label};let n=t.loadingLabel||(t.source==="search"?"Recherche de la branche...":"Chargement de la branche...");Q(n,"loading"),Se(!0);let i=new AbortController;rt(),ne=i;let o=r.ancestryDepth==="auto"||r.ancestryDepth===null,a=r.progenyDepth==="auto"||r.progenyDepth===null,s=!t.disableProgressive&&(o||a);try{s?await _t(r,{...t,controller:i}):await st(r,{...t,controller:i})}finally{ne===i&&(ne=null,Se(!1))}}async function _t(e,t={}){var p,y,D,b,I,C,M,j,J,x,k,R;let r=t.controller,n=e.ancestryDepth==="auto"||e.ancestryDepth===null,i=e.progenyDepth==="auto"||e.progenyDepth===null,o=Number.isFinite(t.progressiveStep)&&t.progressiveStep>0?Math.floor(t.progressiveStep):mt,a=Math.max(1,o),s={...e};if(n){let v=Number.isFinite(A.ancestryDepth)?Math.max(0,A.ancestryDepth):a;s.ancestryDepth=Math.max(a,v)}if(i){let v=Number.isFinite(A.progenyDepth)?Math.max(0,A.progenyDepth):a;s.progenyDepth=Math.max(a,v)}let f={...e,ancestryDepth:n?"auto":e.ancestryDepth,progenyDepth:i?"auto":e.progenyDepth},l=0,u=(I=(b=(D=(y=(p=m==null?void 0:m.store)==null?void 0:p.getTree)==null?void 0:y.call(p))==null?void 0:D.data)==null?void 0:b.length)!=null?I:0,d=!1;for(;l<ht;){if(l+=1,(C=r==null?void 0:r.signal)!=null&&C.aborted)return;if(n||i){let h=[];n&&h.push(`anc\xEAtres \u2264 ${s.ancestryDepth}`),i&&h.push(`descendants \u2264 ${s.progenyDepth}`),h.length&&Q(`Chargement progressif (${h.join(", ")})...`,"loading")}let v=l===1,K=v?t.treePosition!==void 0?t.treePosition:t.reposition===!1?"inherit":t.source==="search"?"main_to_middle":"inherit":"inherit",$=await st(s,{...t,controller:r,progressiveBatch:!0,reposition:v?t.reposition:!1,treePosition:K});if(!$||$.aborted)return;if($.error){d=!0;break}let W=$.meta||{},N=(R=(k=(x=(J=(j=(M=m==null?void 0:m.store)==null?void 0:M.getTree)==null?void 0:j.call(M))==null?void 0:J.data)==null?void 0:x.length)!=null?k:W.returned)!=null?R:u,Z=N-u;if(u=N,Z<=0)break;n&&(s.ancestryDepth+=a),i&&(s.progenyDepth+=a)}d||(G={...f},g={...g,...f},c&&(c={...c},n&&(c.ancestryDepth="auto"),i&&(c.progenyDepth="auto"),B=!0,Be(c),B=!1))}async function st(e,t={}){let r=t.controller||new AbortController;t.controller||(rt(),ne=r);let n=Dt(e);try{let i=await fetch(`/api/tree?${n}`,{cache:"no-store",signal:r.signal});if(!i.ok)throw new Error(`HTTP ${i.status}`);let o=await i.json();if(r.signal.aborted)return{aborted:!0};let a=Pe(o),s=Array.isArray(a.data)?a.data:[],f=Oe(a.meta,s.length);return!s.length&&t.reason==="initial"&&!t.allowEmpty?(await at({...t,preservePreferences:!1,loadingLabel:"Chargement complet de l'arbre...",source:t.source||"system"}),{aborted:!1,meta:f}):(G={...e},It({data:s,config:a.config,meta:f},{...t,params:e}),{aborted:!1,meta:f})}catch(i){return i.name==="AbortError"?{aborted:!0,error:i}:(console.error("Erreur de chargement de sous-arbre",i),Q(`Erreur: ${i&&i.message||"chargement interrompu"}`,"error"),{aborted:!1,error:i})}}function at(e={}){let t=e.loadingLabel||"Chargement complet de l'arbre...";return Q(t,"loading"),Se(!0),fetch("/api/tree",{cache:"no-store"}).then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}).then(r=>{var s,f,l;let n=Pe(r),i=Array.isArray(n.data)?n.data:[],o=Oe(n.meta,i.length);Y=o,ce=o.total;let a=e.mainId||(typeof((s=n.config)==null?void 0:s.mainId)=="string"?n.config.mainId:null)||((l=(f=i[0])==null?void 0:f.id)!=null?l:null);a&&(g={...g,mainId:a}),G=null,ct({data:i,config:n.config,meta:o},{preservePreferences:e.preservePreferences!==!1,treePosition:e.treePosition||"fit",source:e.source||"system",selectedLabel:e.selectedLabel,mainId:a})}).catch(r=>{console.error("Erreur lors du chargement complet de l'arbre",r),Q(`Erreur: ${r&&r.message||"chargement impossible"}`,"error")}).finally(()=>{Se(!1)})}function It(e,t={}){var d,p,y,D,b,I,C;let{data:r,config:n,meta:i}=Pe(e),o=Array.isArray(r)?r:[],a=Oe(i,o.length);Y=a,ce=a.total;let s=t.params||{},f=s.mainId||(typeof(n==null?void 0:n.mainId)=="string"?n.mainId:null)||((y=(p=(d=o[0])==null?void 0:d.id)!=null?p:g.mainId)!=null?y:null);g={...g,mainId:f,ancestryDepth:(D=s.ancestryDepth)!=null?D:g.ancestryDepth,progenyDepth:(b=s.progenyDepth)!=null?b:g.progenyDepth,includeSiblings:(I=s.includeSiblings)!=null?I:g.includeSiblings,includeSpouses:(C=s.includeSpouses)!=null?C:g.includeSpouses};let l=t.selectedLabel||ge(f),u=t.treePosition!==void 0?t.treePosition:t.reposition===!1?"inherit":t.source==="search"?"main_to_middle":"inherit";ct({data:o,config:n,meta:a},{preservePreferences:t.preservePreferences!==!1,treePosition:u,source:t.source||ee.source,selectedLabel:l,mainId:f})}function Ct(){!_||!te||!w||!P||(P.textContent="",P.classList.add("hidden"),te.textContent="S\xE9lectionnez une personne pour afficher les informations.",te.classList.remove("hidden"),w.innerHTML="",we())}function Te(e={}){return[e["first name"],e["last name"]].filter(Boolean).join(" ").trim()}function Mt(e){return e==null?!1:typeof e=="string"?e.trim().length>0:Array.isArray(e)?e.length>0:typeof e=="object"?Object.keys(e).length>0:!0}function $t(e={}){let t=e||{},r=Qe.map(i=>({field:i,value:t[i],mandatory:!0})),n=new Set(Qe);return Object.entries(t).forEach(([i,o])=>{ot(i)||n.has(i)||Mt(o)&&r.push({field:i,value:o,mandatory:!1})}),r}function ot(e){return typeof e!="string"?!1:e.startsWith("union date__ref__")||e.startsWith("union place__ref__")}function Nt(e){var o;if(!e||!e.data)return[];let t=e.data||{},r=new Set;(Array.isArray((o=e.rels)==null?void 0:o.spouses)?e.rels.spouses:[]).forEach(a=>{a&&r.add(a)}),Object.keys(t).forEach(a=>{if(!ot(a))return;let[,s]=a.split("__ref__");s&&r.add(s)});let i=[];return r.forEach(a=>{var d,p;if(!a)return;let s=me(t[`union date__ref__${a}`]),f=me(t[`union place__ref__${a}`]),l=(p=(d=m==null?void 0:m.store)==null?void 0:d.getDatum)==null?void 0:p.call(d,a),u=l?nt(l):`Profil ${a}`;i.push({id:a,name:u,unionDate:s,unionPlace:f})}),i}function Ft(e){if(!w)return 0;let t=Nt(e);if(!t.length)return 0;let r=document.createElement("article");r.className="detail-item detail-unions";let n=document.createElement("span");n.className="detail-label",n.textContent=t.length>1?"Unions":"Union",r.append(n);let i=document.createElement("div");return i.className="detail-value union-list",t.forEach(o=>{let a=document.createElement("div");a.className="union-entry";let s=document.createElement("p");s.className="union-name",s.textContent=o.name,a.append(s),a.append(et("Date d'union",o.unionDate)),a.append(et("Lieu d'union",o.unionPlace)),i.append(a)}),r.append(i),w.append(r),t.length}function et(e,t){let r=document.createElement("p");r.className="union-row";let n=document.createElement("span");n.className="union-row-label",n.textContent=`${e} :`;let i=document.createElement("span");return i.className="union-row-value",t?i.textContent=t:(i.classList.add("empty"),i.textContent=V),r.append(n,i),r}function Ot(e){if(!e)return"";let t=e.toLowerCase();return Je[t]?Je[t]:t.replace(/\b\w/g,r=>r.toUpperCase())}function Bt(e){return e.map(t=>typeof t=="string"?t.trim():typeof t=="object"&&t!==null?JSON.stringify(t):String(t)).filter(Boolean).join(", ")}function wt(e,t){if(t===void 0)return{text:V,empty:!0};if(e==="avatar"){let i=(t||"").toString().trim();return i?{type:"avatar",url:i}:{text:V,empty:!0}}if(e==="gender"&&typeof t=="string")return{text:pt[t.toUpperCase()]||t};if(t===null)return{text:V,empty:!0};if(Array.isArray(t))return t.length?{text:Bt(t)}:{text:V,empty:!0};if(typeof t=="object"){let i=JSON.stringify(t,null,2);return i?{text:i,pre:!0}:{text:V,empty:!0}}let r=String(t).trim();if(!r)return{text:V,empty:!0};let n=r.includes(`
`)||r.length>80;return{text:r,pre:n}}function jt(e,t){if(!w)return;let r=document.createElement("article");r.className="detail-item";let n=document.createElement("span");if(n.className="detail-label",n.textContent=Ot(e),r.append(n),t.type==="avatar"){let o=document.createElement("div");o.className="avatar-preview";let a=document.createElement("img");a.src=t.url,a.alt=`Avatar de ${(P==null?void 0:P.textContent)||"la personne s\xE9lectionn\xE9e"}`,a.loading="lazy";let s=document.createElement("a");s.href=t.url,s.target="_blank",s.rel="noopener",s.textContent="Ouvrir l\u2019image",o.append(a,s),r.append(o),w.append(r);return}let i=document.createElement("div");i.className="detail-value",t.pre&&i.classList.add("preformatted"),t.empty&&i.classList.add("empty"),i.textContent=t.text,r.append(i),w.append(r)}function lt(e){if(!_||!w||!te||!P)return;let t=(e==null?void 0:e.data)||{};w.innerHTML="";let r=Te(t),n=[];t.birthday&&n.push(`N\xE9(e) : ${t.birthday}`),t.death&&n.push(`D\xE9c\xE8s : ${t.death}`),r?(P.textContent=n.length?`${r} \xB7 ${n.join(" \xB7 ")}`:r,P.classList.remove("hidden")):n.length?(P.textContent=n.join(" \xB7 "),P.classList.remove("hidden")):(P.textContent="",P.classList.add("hidden"));let i=$t(t),o=0;i.forEach(a=>{let s=wt(a.field,a.value);s.empty||(jt(a.field,s),o+=1)}),o+=Ft(e),o===0?(te.textContent="Aucune information suppl\xE9mentaire disponible.",te.classList.remove("hidden")):te.classList.add("hidden")}function Ne(e,t="card"){if(!e)return;let r=Te(e.data||{})||`Profil ${e.id}`;if(lt(e),m&&(m.updateMainId(e.id),Ee({treePosition:"inherit",initial:!1})),Q(`${t==="search"?"Resultat":"Selection"} : ${r}`,"info"),t==="search"){let i=T==null?void 0:T.querySelector("input");i&&(i.value="",i.blur())}fe({mainId:e.id},{source:t,treePosition:t==="search"?"main_to_middle":"inherit",reposition:t==="search",preservePreferences:!0,selectedLabel:r,loadingLabel:`${t==="search"?"Recherche":"Selection"} : ${r}...`})}function xt(e){if(!T)return;T.innerHTML="";let t=de&&de.length?"ready":X&&X.length===0?"empty":"loading";ue(t),e.setPersonDropdown(i=>{let o=i.data||{},a=Te(o)||"Profil sans nom",s=[];return o.birthday&&s.push(o.birthday),o.death&&s.push(`\u271D ${o.death}`),s.length?`${a} (${s.join(" \xB7 ")})`:a},{cont:T,placeholder:"Rechercher (nom, date, lieu, etc.)",onSelect:i=>{var s,f;let o=(f=(s=e.store)==null?void 0:s.getDatum)==null?void 0:f.call(s,i);if(o){Ne(o,"search");return}let a=ge(i)||`Profil ${i}`;fe({mainId:i},{source:"search",treePosition:"main_to_middle",reposition:!0,preservePreferences:!0,selectedLabel:a,loadingLabel:`Recherche : ${a}...`})}});let r=T.querySelector(".f3-autocomplete-items");if(r){let i=()=>{let a=r.childElementCount>0;r.classList.toggle("is-empty",!a),a?r.tabIndex=0:r.removeAttribute("tabindex")};i(),new MutationObserver(i).observe(r,{childList:!0})}let n=T.querySelector("input");n&&(n.id="personSearchInput",n.setAttribute("placeholder","Rechercher (nom, date, lieu, etc.)"),Le&&Le.id&&n.setAttribute("aria-describedby",Le.id)),ye(e),it().then(()=>{ye(e)}).catch(()=>{})}function ct(e,t={}){var x,k,R,v,K,$,W,N,Z;let r=document.querySelector(Ue);if(!r)throw new Error("Conteneur du graphique introuvable");let n=e&&e.data!==void 0?e:Pe(e),i=Array.isArray(n.data)?n.data:[],o=n.config||{},a=!m;a&&(r.innerHTML=""),Ct(),m?m.updateData(i):m=tt.createChart(Ue,i);let s=m,f=bt(s,o),l={...f,mainId:t.mainId||f.mainId||c.mainId||null,ancestryDepth:g.ancestryDepth,progenyDepth:g.progenyDepth,duplicateBranchToggle:t.preservePreferences&&c?c.duplicateBranchToggle!==!1:f.duplicateBranchToggle,miniTree:t.preservePreferences&&c?c.miniTree!==!1:f.miniTree!==!1,cardDisplay:f.cardDisplay&&f.cardDisplay.length?f.cardDisplay.map(h=>[...h]):De.map(h=>[...h])};t.preservePreferences&&c&&(l.cardDisplay=c.cardDisplay&&c.cardDisplay.length?c.cardDisplay.map(h=>[...h]):l.cardDisplay,l.transitionTime=(x=c.transitionTime)!=null?x:l.transitionTime,l.cardXSpacing=(k=c.cardXSpacing)!=null?k:l.cardXSpacing,l.cardYSpacing=(R=c.cardYSpacing)!=null?R:l.cardYSpacing,l.singleParentEmptyCard=(v=c.singleParentEmptyCard)!=null?v:l.singleParentEmptyCard,l.singleParentEmptyCardLabel=(K=c.singleParentEmptyCardLabel)!=null?K:l.singleParentEmptyCardLabel,l.orientation=($=c.orientation)!=null?$:l.orientation),c={...l},c.mainId=l.mainId;let u=c.cardDisplay&&c.cardDisplay.length?c.cardDisplay.map(h=>[...h]):De.map(h=>[...h]);E||(E=s.setCardHtml()),typeof E.setCardDisplay=="function"&&E.setCardDisplay(u),typeof E.setMiniTree=="function"&&E.setMiniTree(c.miniTree!==!1),typeof E.setOnCardClick=="function"&&E.setOnCardClick((h,F)=>{var H,L,z;let S=(H=F==null?void 0:F.data)==null?void 0:H.id;if(!S)return;let q=(z=(L=s.store)==null?void 0:L.getDatum)==null?void 0:z.call(L,S);if(q)Ne(q,"card");else{let U=ge(S)||`Profil ${S}`;fe({mainId:S},{source:"card",treePosition:"inherit",reposition:!1,preservePreferences:!0,selectedLabel:U,loadingLabel:`Selection : ${U}...`})}}),typeof E.setOnMiniTreeClick=="function"&&E.setOnMiniTreeClick((h,F)=>{var H,L,z;let S=(H=F==null?void 0:F.data)==null?void 0:H.id;if(!S)return;let q=(z=(L=s.store)==null?void 0:L.getDatum)==null?void 0:z.call(L,S);if(q)Ne(q,"card");else{let U=ge(S)||`Profil ${S}`;fe({mainId:S},{source:"card",treePosition:"inherit",reposition:!1,preservePreferences:!0,selectedLabel:U,loadingLabel:`Selection : ${U}...`})}}),s.setDuplicateBranchToggle(c.duplicateBranchToggle!==!1),B=!0,Be(c),B=!1,c.mainId&&s.updateMainId(c.mainId),Tt(s),a?xt(s):ye(s);let d=t.preservePreferences===!1,y=t.treePosition||(t.source==="search"?"main_to_middle":a?"fit":"inherit");Ee({treePosition:y,initial:d});let D=(W=s.getMainDatum)==null?void 0:W.call(s),b=((Z=(N=s.store)==null?void 0:N.getMainId)==null?void 0:Z.call(N))||c.mainId;b&&b!==c.mainId&&(c.mainId=b),b&&(g.mainId=b,G&&(G={...G,mainId:b})),D&&lt(D),we();let I=Number.isFinite(Y.returned)?Y.returned:i.length,C=Number.isFinite(Y.total)?Y.total:i.length,M=D?Te(D.data||{})||`Profil ${D.id}`:t.selectedLabel||"Branche courante",j=t.source==="search"?"Resultat":t.source==="card"?"Selection":"Branche",J=At(c);Q(`${j} : ${M} - ${I} profil(s) dans la branche / ${C} au total - ${J}`,"success"),ee={source:t.source||j.toLowerCase(),label:M},it().then(()=>{ye(s)}).catch(()=>{})}at({preservePreferences:!1,source:"system"}).catch(()=>{Q("Impossible de charger les donn\xE9es","error")});
//# sourceMappingURL=viewer.bundle.js.map
