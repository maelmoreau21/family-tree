import*as Ze from"/lib/family-tree.esm.js";var ve=document.getElementById("status"),C=document.getElementById("personDetails"),L=document.getElementById("personSearch"),_e=document.getElementById("personSearchHint"),Ie=document.querySelector('[data-role="viewer-search"]'),Te=document.querySelector('[data-role="viewer-search-empty"]'),w=C==null?void 0:C.querySelector(".detail-list"),P=C==null?void 0:C.querySelector(".summary"),ee=C==null?void 0:C.querySelector(".empty"),He="#FamilyChart",oe=document.getElementById("viewerAncestryDepth"),ae=document.getElementById("viewerProgenyDepth"),le=document.getElementById("viewerMiniTree"),ce=document.querySelector('[data-role="dataset-meta"]'),ze=document.querySelector('[data-role="visible-count"]'),Ue=document.querySelector('[data-role="branch-count"]'),Ye=document.querySelector('[data-role="total-count"]');function ne(e){return e==null?"":String(e).trim().toLowerCase()}function De(e){return ne(e).replace(/[\s_-]+/g,"")}function lt(e){if(!Array.isArray(e))return[];let t=new Set,r=[];return e.forEach(n=>{if(typeof n!="string")return;let i=n.trim();if(!i)return;let a=ne(i);t.has(a)||(t.add(a),r.push(i))}),r}function he(e){return typeof e=="string"?e.trim():""}function Ve(e={}){let t=e.data||{},r=he(t["first name"]),n=he(t["last name"]),i=r||n?[r,n].filter(Boolean).join(" ").trim():e.id?`Profil ${e.id}`:"Profil sans nom",a=he(t.birthday);return a?`${i} (${a})`:i}function ct(e){if(!e||typeof e.id!="string"||!e.id.trim())return null;let t=Ve(e),r=new Set,n=[],i=new Set,a=l=>{if(typeof l!="string")return;let u=l.trim();u&&r.add(u)},o=l=>{if(typeof l!="string")return;let u=l.trim();u&&(i.has(u)||(i.add(u),n.push(u)))};a(t),a(String(e.id));let s=e.data&&typeof e.data=="object"?e.data:{};Object.entries(s).forEach(([l,u])=>{if(typeof u!="string")return;let p=u.trim();if(!p)return;a(p);let d=ne(l);if(d==="birthday"){o(p);return}if(d==="death"){o(`\u271D ${p}`);return}if(d==="maiden name"){o(`(${p})`);return}if(d==="occupation"){o(p);return}(d==="location"||d==="residence"||d==="birthplace"||d==="deathplace")&&o(p)});let f=Array.from(r).map(l=>l.replace(/\s+/g," ").trim()).filter(Boolean).join(" | ");return{label:t,value:e.id,searchText:f,optionHtml:l=>{let u=n.length?`<small>${n.join(" \xB7 ")}</small>`:"";return`<div>${l.label_html||l.label}${u?`<div class="f3-autocomplete-meta">${u}</div>`:""}</div>`}}}function ut(e){if(!Array.isArray(e))return[];let t=[],r=new Set;return e.forEach(n=>{if(!n||!n.id||r.has(n.id))return;let i=ct(n);i&&(t.push(i),r.add(n.id))}),t.sort((n,i)=>n.label.localeCompare(i.label,"fr",{sensitivity:"base"})),t}function fe(e){Ie&&(e?Ie.dataset.state=String(e):delete Ie.dataset.state,Te&&(e==="error"?Te.textContent="Impossible de charger la recherche pour le moment.":Te.textContent="Aucune personne disponible pour le moment."))}var Xe=["first name","first names","last name","birthday","death","gender","avatar","bio"],et=new Set(["phone","email","notes","occupation","location","residence","nickname"]),Ge={"first name":"Pr\xE9nom","first names":"Pr\xE9noms",firstnames:"Pr\xE9noms",first_names:"Pr\xE9noms","last name":"Nom",nickname:"Surnom","maiden name":"Nom de jeune fille",birthday:"Date de naissance",death:"Date de D\xE9c\xE8s",gender:"Genre",location:"Localisation",birthplace:"Lieu de naissance",deathplace:"Lieu de d\xE9c\xE8s",occupation:"Profession",bio:"Biographie",notes:"Notes",email:"Email",phone:"T\xE9l\xE9phone",avatar:"Avatar"},ft={M:"Masculin",F:"F\xE9minin",O:"Autre",X:"Non binaire"},Z="Non renseign\xE9",Ee=[["first name","last name"],["birthday"]],_=Object.freeze({transitionTime:200,cardXSpacing:240,cardYSpacing:140,orientation:"vertical",showSiblingsOfMain:!0,singleParentEmptyCard:!0,singleParentEmptyCardLabel:"Inconnu",ancestryDepth:4,progenyDepth:4,miniTree:!0,cardDisplay:Ee.map(e=>[...e]),mainId:null}),dt=4,pt=12,m=null,E=null,c={..._},ue=0,x=!1,y={mainId:null,ancestryDepth:_.ancestryDepth,progenyDepth:_.progenyDepth,includeSiblings:!0,includeSpouses:!0},Q=null,G={total:0,returned:0,includeSiblings:!0,includeSpouses:!0},te=null,me=null,X=null,$e=[],Se=[],de=[],V={source:"initial",label:null},ye=new Map,Ce=null,se={visible:-1,branch:-1,total:-1},Me={message:"",type:""};function mt(e){let r=(Array.isArray(e)?e:[]).slice(0,2).map(n=>lt(Array.isArray(n)?n:[]));for(;r.length<2;)r.push([]);return r}function Le(e){if(Array.isArray(e))return{data:e,config:{},meta:{}};if(e&&typeof e=="object"){let t=e.meta&&typeof e.meta=="object"?e.meta:{};if(Array.isArray(e.data)){let r=e.config||e.settings||{};return{data:e.data,config:r,meta:t}}if(Array.isArray(e.tree)){let r=e.config||e.settings||{};return{data:e.tree,config:r,meta:t}}}return{data:[],config:{},meta:{}}}function ht(e={}){var h,b,I,T,M,k,re,ie,R,q,A,W,$,K,B,j,N,D,F,S,H,z,v,U,Y,ke,Re,qe,Be;if(!e||typeof e!="object")return{};let t={},r=(h=e.transitionTime)!=null?h:e.transition_time;typeof r=="number"&&Number.isFinite(r)&&(t.transitionTime=r);let n=(I=(b=e.cardXSpacing)!=null?b:e.card_x_spacing)!=null?I:e.node_separation;typeof n=="number"&&Number.isFinite(n)&&(t.cardXSpacing=n);let i=(M=(T=e.cardYSpacing)!=null?T:e.card_y_spacing)!=null?M:e.level_separation;typeof i=="number"&&Number.isFinite(i)&&(t.cardYSpacing=i);let a=e.orientation;a==="horizontal"||a==="vertical"?t.orientation=a:typeof e.is_horizontal=="boolean"&&(t.orientation=e.is_horizontal?"horizontal":"vertical");let o=(k=e.showSiblingsOfMain)!=null?k:e.show_siblings_of_main;typeof o=="boolean"&&(t.showSiblingsOfMain=o);let s=(re=e.singleParentEmptyCard)!=null?re:e.single_parent_empty_card;typeof s=="boolean"&&(t.singleParentEmptyCard=s);let f=(ie=e.singleParentEmptyCardLabel)!=null?ie:e.single_parent_empty_card_label;typeof f=="string"&&f.trim().length>0&&(t.singleParentEmptyCardLabel=f.trim());let l=(R=e.cardDisplay)!=null?R:e.card_display;if(Array.isArray(l)||l&&typeof l=="object"){let O=l;l&&!Array.isArray(l)&&typeof l=="object"&&(O=[(j=(B=(K=($=(W=(A=(q=l[0])!=null?q:l[0])!=null?A:l.row1)!=null?W:l.row_1)!=null?$:l.ligne1)!=null?K:l.line1)!=null?B:l.first)!=null?j:[],(v=(z=(H=(S=(F=(D=(N=l[1])!=null?N:l[1])!=null?D:l.row2)!=null?F:l.row_2)!=null?S:l.ligne2)!=null?H:l.line2)!=null?z:l.second)!=null?v:[]]),t.cardDisplay=mt(O)}let u=(ke=(Y=(U=e.mainId)!=null?U:e.main_id)!=null?Y:e.mainPersonId)!=null?ke:e.main_person_id;typeof u=="string"&&u.trim().length>0&&(t.mainId=u.trim());let p=(Re=e.ancestryDepth)!=null?Re:e.ancestry_depth;if(p===null)t.ancestryDepth=null;else if(p!==void 0){let O=Number(p);Number.isFinite(O)&&O>=0&&(t.ancestryDepth=Math.floor(O))}let d=(qe=e.progenyDepth)!=null?qe:e.progeny_depth;if(d===null)t.progenyDepth=null;else if(d!==void 0){let O=Number(d);Number.isFinite(O)&&O>=0&&(t.progenyDepth=Math.floor(O))}let g=(Be=e.miniTree)!=null?Be:e.mini_tree;return typeof g=="boolean"&&(t.miniTree=g),t}function yt(e,t){let r=ht(t),n={..._,...r},i=r.cardDisplay;return n.cardDisplay=i&&i.length?i.map(a=>[...a]):Ee.map(a=>[...a]),e.setTransitionTime(n.transitionTime),e.setCardXSpacing(n.cardXSpacing),e.setCardYSpacing(n.cardYSpacing),e.setShowSiblingsOfMain(n.showSiblingsOfMain),n.orientation==="horizontal"?e.setOrientationHorizontal():e.setOrientationVertical(),e.setSingleParentEmptyCard(n.singleParentEmptyCard,{label:n.singleParentEmptyCardLabel}),typeof n.ancestryDepth=="number"&&Number.isFinite(n.ancestryDepth)?e.setAncestryDepth(n.ancestryDepth):e.setAncestryDepth(null),typeof n.progenyDepth=="number"&&Number.isFinite(n.progenyDepth)?e.setProgenyDepth(n.progenyDepth):e.setProgenyDepth(null),n}function Qe(e){if(e!=="auto"){if(e==="all"||e===null)return"all";if(typeof e=="number"&&Number.isFinite(e)&&e>=0)return String(Math.floor(e))}}function gt(e){let t=new URLSearchParams;t.set("mode","subtree"),e.mainId&&typeof e.mainId=="string"&&t.set("mainId",e.mainId);let r=Qe(e.ancestryDepth);r!==void 0&&t.set("ancestryDepth",r);let n=Qe(e.progenyDepth);return n!==void 0&&t.set("progenyDepth",n),e.includeSiblings!==void 0&&t.set("includeSiblings",e.includeSiblings?"true":"false"),e.includeSpouses!==void 0&&t.set("includeSpouses",e.includeSpouses?"true":"false"),t.toString()}function Pe(e){let t=!!e;ce&&ce.classList.toggle("is-loading",t),L&&L.classList.toggle("is-loading",t)}function tt(){te&&(te.abort(),te=null)}function Oe(e,t=0,r=t){let n=e&&typeof e=="object"?e:{},i=Number.isFinite(n.total)?Math.max(0,Math.floor(n.total)):Math.max(0,Math.floor(t)),a=Number.isFinite(n.returned)?Math.max(0,Math.floor(n.returned)):Math.max(0,Math.floor(r)),o=n.ancestryDepth===null?null:Number.isFinite(n.ancestryDepth)?Math.max(0,Math.floor(n.ancestryDepth)):void 0,s=n.progenyDepth===null?null:Number.isFinite(n.progenyDepth)?Math.max(0,Math.floor(n.progenyDepth)):void 0;return{total:i,returned:a,includeSiblings:n.includeSiblings!==!1,includeSpouses:n.includeSpouses!==!1,ancestryDepth:o,progenyDepth:s}}function bt(e){return Q?["mainId","ancestryDepth","progenyDepth","includeSiblings","includeSpouses"].some(r=>{let n=Q[r],i=e[r];return!(n===i||n===null&&i===void 0||n===void 0&&i===null)}):!0}function Dt(e){let t=typeof e.label=="string"&&e.label.trim()?e.label.trim():`Profil ${e.id}`,r=new Set,n=[],i=new Set,a=u=>{if(typeof u!="string")return;let p=u.trim();p&&r.add(p)},o=u=>{if(typeof u!="string")return;let p=u.trim();if(!p)return;let d=p.toLowerCase();i.has(d)||(i.add(d),n.push(p))},s=(u,p)=>{if(typeof p!="string")return;let d=p.trim();if(!d)return;let g=ne(u);if(et.has(g))return;a(d);let h=ne(u);if(h==="birthday"){o(d);return}if(h==="death"){o(`\u271D ${d}`);return}if(h==="maiden name"){o(`(${d})`);return}if(h==="location"||h==="residence"||h==="birthplace"||h==="deathplace"){o(d);return}};a(t),a(String(e.id||"")),typeof e.searchText=="string"&&e.searchText.trim()&&e.searchText.split("|").forEach(u=>a(u)),s("birthday",e.birthday),s("death",e.death),s("location",e.location),s("residence",e.residence),s("maiden name",e.maidenName),e.fields&&typeof e.fields=="object"&&Object.entries(e.fields).forEach(([u,p])=>{s(u,p)});let f=Array.from(r).map(u=>u.replace(/\s+/g," ").trim()).filter(Boolean),l=f.length?f.join(" | "):t;return{label:t,value:e.id,searchText:l,optionHtml:u=>{let p=u.label_html||u.label,d=n.length?`<small>${n.join(" \xB7 ")}</small>`:"";return`<div>${p}${d?`<div class="f3-autocomplete-meta">${d}</div>`:""}</div>`}}}function St(e){if(!e||!Array.isArray(e.persons))return[];let t=e.persons.filter(r=>r&&typeof r.id=="string").map(r=>Dt(r));return t.sort((r,n)=>r.label.localeCompare(n.label,"fr",{sensitivity:"base"})),t}function Ne(){let e=new Map,t=n=>{if(!n||!n.value)return;if(!e.has(n.value)){e.set(n.value,{...n});return}let i=e.get(n.value),a=r(i.searchText,n.searchText);a&&(i.searchText=a),typeof i.optionHtml!="function"&&typeof n.optionHtml=="function"&&(i.optionHtml=n.optionHtml)},r=(n,i)=>{let a=new Set,o=s=>{typeof s=="string"&&s.split("|").forEach(f=>{let l=f.trim();l&&a.add(l)})};return o(n),o(i),a.size?Array.from(a).join(" | "):n||i||""};Se.forEach(t),$e.forEach(t),de=Array.from(e.values()),de.sort((n,i)=>n.label.localeCompare(i.label,"fr",{sensitivity:"base"})),m&&ge(m)}function Et(e){if(!e||!e.store||typeof e.store.getData!="function"){Se=[],Ne();return}try{let t=e.store.getData();Se=ut(t)}catch(t){console.warn("[viewer] Impossible de reconstruire l\u2019index local de recherche",t),Se=[]}Ne()}function Pt(e){fe(e),L&&(e?L.dataset.state=String(e):L.dataset.state="")}async function nt(e=!1){if(!e&&X)return X;if(!e&&me)return me;Pt("loading");let t=new AbortController,r=fetch("/api/tree/summary",{cache:"no-store",signal:t.signal}).then(n=>{if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()}).then(n=>(X=n,ye=new Map,Array.isArray(n==null?void 0:n.persons)&&n.persons.forEach(i=>{i&&typeof i.id=="string"&&ye.set(i.id,i)}),$e=St(n),fe($e.length?"ready":"empty"),Ne(),X)).catch(n=>{if(n.name==="AbortError")return X;throw console.error("Impossible de charger l'index de recherche",n),fe("error"),n}).finally(()=>{me===r&&(me=null)});return me=r,r}function ge(e){if(!e||!e.personSearch)return;let t=Array.isArray(de)?de:[];e.personSearch.setOptionsGetter(()=>t),t.length?fe("ready"):X&&fe("empty")}function J(e,t="info"){ve&&(Me.message===e&&Me.type===t||(Me={message:e,type:t},ve.textContent=e,ve.dataset.status=t))}function Je(e,t){return e==="auto"?"auto":e==="all"||e===null?"all":typeof e=="number"&&Number.isFinite(e)&&e>=0?String(Math.floor(e)):typeof t=="number"&&Number.isFinite(t)&&t>=0?String(Math.floor(t)):t==="auto"?"auto":t==="all"||t===null?"all":"auto"}function We(e,t){if(!e)return t;let r=e.value;if(r==="auto")return"auto";if(r==="all"||r==="")return"all";let n=Number(r);return Number.isFinite(n)&&n>=0?Math.floor(n):t}function je(e){oe&&(oe.value=Je(e.ancestryDepth,_.ancestryDepth)),ae&&(ae.value=Je(e.progenyDepth,_.progenyDepth)),le&&(le.checked=e.miniTree!==!1)}function we(){if(Ce!==null)return;Ce=(typeof requestAnimationFrame=="function"?requestAnimationFrame:t=>setTimeout(t,16))(()=>{var n,i,a,o,s;Ce=null;let t=(s=(o=(a=(i=(n=m==null?void 0:m.store)==null?void 0:n.getTree)==null?void 0:i.call(n))==null?void 0:a.data)==null?void 0:o.length)!=null?s:0,r=Number.isFinite(G.returned)?G.returned:t;se.visible===t&&se.branch===r&&se.total===ue||(se.visible=t,se.branch=r,se.total=ue,ze&&(ze.textContent=String(t)),Ue&&(Ue.textContent=String(r)),Ye&&(Ye.textContent=String(ue)),ce&&(ce.dataset.visible=String(t),ce.dataset.total=String(ue),ce.dataset.branch=String(r)))})}function xe({treePosition:e="inherit",initial:t=!1}={}){if(!m)return;typeof c.ancestryDepth=="number"&&Number.isFinite(c.ancestryDepth)?m.setAncestryDepth(c.ancestryDepth):m.setAncestryDepth(null),typeof c.progenyDepth=="number"&&Number.isFinite(c.progenyDepth)?m.setProgenyDepth(c.progenyDepth):m.setProgenyDepth(null),E&&typeof E.setMiniTree=="function"&&E.setMiniTree(c.miniTree!==!1),x=!0,je(c),x=!1;let r="inherit";(e==="fit"||e==="main_to_middle")&&(r=e),m.updateTree({initial:t,tree_position:r}),we()}function Lt(){oe==null||oe.addEventListener("change",()=>{var r,n;if(x)return;let e=(n=(r=c.ancestryDepth)!=null?r:_.ancestryDepth)!=null?n:null,t=We(oe,e);t!==c.ancestryDepth&&(c={...c,ancestryDepth:t},pe({ancestryDepth:t},{reason:"ancestry-depth-change",source:"controls",reposition:!1,treePosition:"inherit",preservePreferences:!0}))}),ae==null||ae.addEventListener("change",()=>{var r,n;if(x)return;let e=(n=(r=c.progenyDepth)!=null?r:_.progenyDepth)!=null?n:null,t=We(ae,e);t!==c.progenyDepth&&(c={...c,progenyDepth:t},pe({progenyDepth:t},{reason:"progeny-depth-change",source:"controls",reposition:!1,treePosition:"inherit",preservePreferences:!0}))}),le==null||le.addEventListener("change",()=>{if(x)return;let e=le.checked,t=c.miniTree!==!1;e!==t&&(c={...c,miniTree:e},xe({treePosition:"inherit"}))})}Lt();function be(e){if(!e||typeof e!="string")return null;if(ye&&ye.has(e)){let t=ye.get(e);if(t&&typeof t.label=="string"&&t.label.trim())return t.label.trim()}return null}async function pe(e={},t={}){let r={...y,...e};if(!bt(r)&&!t.force){V={source:t.source||V.source,label:t.selectedLabel||V.label};return}y={...r},V={source:t.source||"system",label:t.selectedLabel||be(r.mainId)||V.label};let n=t.loadingLabel||(t.source==="search"?"Recherche de la branche...":"Chargement de la branche...");J(n,"loading"),Pe(!0);let i=new AbortController;tt(),te=i;let a=r.ancestryDepth==="auto"||r.ancestryDepth===null,o=r.progenyDepth==="auto"||r.progenyDepth===null,s=!t.disableProgressive&&(a||o);try{s?await At(r,{...t,controller:i}):await rt(r,{...t,controller:i})}finally{te===i&&(te=null,Pe(!1))}}async function At(e,t={}){var d,g,h,b,I,T,M,k,re,ie,R,q;let r=t.controller,n=e.ancestryDepth==="auto"||e.ancestryDepth===null,i=e.progenyDepth==="auto"||e.progenyDepth===null,a=Number.isFinite(t.progressiveStep)&&t.progressiveStep>0?Math.floor(t.progressiveStep):dt,o=Math.max(1,a),s={...e};if(n){let A=Number.isFinite(_.ancestryDepth)?Math.max(0,_.ancestryDepth):o;s.ancestryDepth=Math.max(o,A)}if(i){let A=Number.isFinite(_.progenyDepth)?Math.max(0,_.progenyDepth):o;s.progenyDepth=Math.max(o,A)}let f={...e,ancestryDepth:n?"auto":e.ancestryDepth,progenyDepth:i?"auto":e.progenyDepth},l=0,u=(I=(b=(h=(g=(d=m==null?void 0:m.store)==null?void 0:d.getTree)==null?void 0:g.call(d))==null?void 0:h.data)==null?void 0:b.length)!=null?I:0,p=!1;for(;l<pt;){if(l+=1,(T=r==null?void 0:r.signal)!=null&&T.aborted)return;if(n||i){let N=[];n&&N.push(`anc\xEAtres \u2264 ${s.ancestryDepth}`),i&&N.push(`descendants \u2264 ${s.progenyDepth}`),N.length&&J(`Chargement progressif (${N.join(", ")})...`,"loading")}let A=l===1,W=A?t.treePosition!==void 0?t.treePosition:t.reposition===!1?"inherit":t.source==="search"?"main_to_middle":"inherit":"inherit",$=await rt(s,{...t,controller:r,progressiveBatch:!0,reposition:A?t.reposition:!1,treePosition:W});if(!$||$.aborted)return;if($.error){p=!0;break}let K=$.meta||{},B=(q=(R=(ie=(re=(k=(M=m==null?void 0:m.store)==null?void 0:M.getTree)==null?void 0:k.call(M))==null?void 0:re.data)==null?void 0:ie.length)!=null?R:K.returned)!=null?q:u,j=B-u;if(u=B,j<=0)break;n&&(s.ancestryDepth+=o),i&&(s.progenyDepth+=o)}p||(Q={...f},y={...y,...f},c&&(c={...c},n&&(c.ancestryDepth="auto"),i&&(c.progenyDepth="auto"),x=!0,je(c),x=!1))}async function rt(e,t={}){let r=t.controller||new AbortController;t.controller||(tt(),te=r);let n=gt(e);try{let i=await fetch(`/api/tree?${n}`,{cache:"no-store",signal:r.signal});if(!i.ok)throw new Error(`HTTP ${i.status}`);let a=await i.json();if(r.signal.aborted)return{aborted:!0};let o=Le(a),s=Array.isArray(o.data)?o.data:[],f=Oe(o.meta,s.length);return!s.length&&t.reason==="initial"&&!t.allowEmpty?(await it({...t,preservePreferences:!1,loadingLabel:"Chargement complet de l'arbre...",source:t.source||"system"}),{aborted:!1,meta:f}):(Q={...e},vt({data:s,config:o.config,meta:f},{...t,params:e}),{aborted:!1,meta:f})}catch(i){return i.name==="AbortError"?{aborted:!0,error:i}:(console.error("Erreur de chargement de sous-arbre",i),J(`Erreur: ${i&&i.message||"chargement interrompu"}`,"error"),{aborted:!1,error:i})}}function it(e={}){let t=e.loadingLabel||"Chargement complet de l'arbre...";return J(t,"loading"),Pe(!0),fetch("/api/tree",{cache:"no-store"}).then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}).then(r=>{var s,f,l;let n=Le(r),i=Array.isArray(n.data)?n.data:[],a=Oe(n.meta,i.length);G=a,ue=a.total;let o=e.mainId||(typeof((s=n.config)==null?void 0:s.mainId)=="string"?n.config.mainId:null)||((l=(f=i[0])==null?void 0:f.id)!=null?l:null);o&&(y={...y,mainId:o}),Q=null,at({data:i,config:n.config,meta:a},{preservePreferences:e.preservePreferences!==!1,treePosition:e.treePosition||"fit",source:e.source||"system",selectedLabel:e.selectedLabel,mainId:o})}).catch(r=>{console.error("Erreur lors du chargement complet de l'arbre",r),J(`Erreur: ${r&&r.message||"chargement impossible"}`,"error")}).finally(()=>{Pe(!1)})}function vt(e,t={}){var p,d,g,h,b,I,T;let{data:r,config:n,meta:i}=Le(e),a=Array.isArray(r)?r:[],o=Oe(i,a.length);G=o,ue=o.total;let s=t.params||{},f=s.mainId||(typeof(n==null?void 0:n.mainId)=="string"?n.mainId:null)||((g=(d=(p=a[0])==null?void 0:p.id)!=null?d:y.mainId)!=null?g:null);y={...y,mainId:f,ancestryDepth:(h=s.ancestryDepth)!=null?h:y.ancestryDepth,progenyDepth:(b=s.progenyDepth)!=null?b:y.progenyDepth,includeSiblings:(I=s.includeSiblings)!=null?I:y.includeSiblings,includeSpouses:(T=s.includeSpouses)!=null?T:y.includeSpouses};let l=t.selectedLabel||be(f),u=t.treePosition!==void 0?t.treePosition:t.reposition===!1?"inherit":t.source==="search"?"main_to_middle":"inherit";at({data:a,config:n,meta:o},{preservePreferences:t.preservePreferences!==!1,treePosition:u,source:t.source||V.source,selectedLabel:l,mainId:f})}function _t(){!C||!ee||!w||!P||(P.textContent="",P.classList.add("hidden"),ee.textContent="S\xE9lectionnez une personne pour afficher les informations.",ee.classList.remove("hidden"),w.innerHTML="",we())}function Ae(e={}){return[e["first name"],e["last name"]].filter(Boolean).join(" ").trim()}function It(e){return e==null?!1:typeof e=="string"?e.trim().length>0:Array.isArray(e)?e.length>0:typeof e=="object"?Object.keys(e).length>0:!0}function Tt(e={}){let t=e||{};function r(a){let o=ne(a),s=De(a);if(Object.prototype.hasOwnProperty.call(t,a))return t[a];for(let f of Object.keys(t))if(ne(f)===o)return t[f];for(let f of Object.keys(t))if(De(f)===s)return t[f]}let n=Xe.map(a=>({field:a,value:r(a),mandatory:!0})),i=new Set(Xe.map(De));return Object.entries(t).forEach(([a,o])=>{if(st(a))return;let s=De(a);et.has(s)||i.has(s)||It(o)&&(i.add(s),n.push({field:a,value:o,mandatory:!1}))}),n}function st(e){return typeof e!="string"?!1:e.startsWith("union date__ref__")||e.startsWith("union place__ref__")}function Ct(e){var a;if(!e||!e.data)return[];let t=e.data||{},r=new Set;(Array.isArray((a=e.rels)==null?void 0:a.spouses)?e.rels.spouses:[]).forEach(o=>{o&&r.add(o)}),Object.keys(t).forEach(o=>{if(!st(o))return;let[,s]=o.split("__ref__");s&&r.add(s)});let i=[];return r.forEach(o=>{var d,g;if(!o)return;let s=he(t[`union date__ref__${o}`]),f=he(t[`union place__ref__${o}`]),l=(g=(d=m==null?void 0:m.store)==null?void 0:d.getDatum)==null?void 0:g.call(d,o);if(!l&&!!!(s||f))return;let p=l?Ve(l):`Profil ${o}`;i.push({id:o,name:p,unionDate:s,unionPlace:f})}),i}function Mt(e){if(!w)return 0;let t=Ct(e);if(!t.length)return 0;let r=document.createElement("article");r.className="detail-item detail-unions";let n=document.createElement("span");n.className="detail-label",n.textContent=t.length>1?"Unions":"Union",r.append(n);let i=document.createElement("div");return i.className="detail-value union-list",t.forEach(a=>{let o=document.createElement("div");o.className="union-entry";let s=document.createElement("p");s.className="union-name",s.textContent=a.name,o.append(s),o.append(Ke("Date d'union",a.unionDate)),o.append(Ke("Lieu d'union",a.unionPlace)),i.append(o)}),r.append(i),w.append(r),t.length}function Ke(e,t){let r=document.createElement("p");r.className="union-row";let n=document.createElement("span");n.className="union-row-label",n.textContent=`${e} :`;let i=document.createElement("span");return i.className="union-row-value",t?i.textContent=t:(i.classList.add("empty"),i.textContent=Z),r.append(n,i),r}function $t(e){if(!e)return"";let t=e.toLowerCase();return Ge[t]?Ge[t]:t.replace(/\b\w/g,r=>r.toUpperCase())}function Nt(e){return e.map(t=>typeof t=="string"?t.trim():typeof t=="object"&&t!==null?JSON.stringify(t):String(t)).filter(Boolean).join(", ")}function Ft(e,t){if(t===void 0)return{text:Z,empty:!0};if(e==="avatar"){let i=(t||"").toString().trim();return i?{type:"avatar",url:i}:{text:Z,empty:!0}}if(e==="gender"&&typeof t=="string")return{text:ft[t.toUpperCase()]||t};if(t===null)return{text:Z,empty:!0};if(Array.isArray(t))return t.length?{text:Nt(t)}:{text:Z,empty:!0};if(typeof t=="object"){let i=JSON.stringify(t,null,2);return i?{text:i,pre:!0}:{text:Z,empty:!0}}let r=String(t).trim();if(!r)return{text:Z,empty:!0};let n=r.includes(`
`)||r.length>80;return{text:r,pre:n}}function Ot(e,t){if(!w)return;let r=document.createElement("article");r.className="detail-item";let n=document.createElement("span");if(n.className="detail-label",n.textContent=$t(e),r.append(n),t.type==="avatar"){let a=document.createElement("div");a.className="avatar-preview";let o=document.createElement("img");o.src=t.url,o.alt=`Avatar de ${(P==null?void 0:P.textContent)||"la personne s\xE9lectionn\xE9e"}`,o.loading="lazy";let s=document.createElement("a");s.href=t.url,s.target="_blank",s.rel="noopener",s.textContent="Ouvrir l\u2019image",a.append(o,s),r.append(a),w.append(r);return}let i=document.createElement("div");i.className="detail-value",t.pre&&i.classList.add("preformatted"),t.empty&&i.classList.add("empty"),i.textContent=t.text,r.append(i),w.append(r)}function ot(e){if(!C||!w||!ee||!P)return;let t=(e==null?void 0:e.data)||{};w.innerHTML="";let r=Ae(t),n=[];t.birthday&&n.push(`N\xE9(e) : ${t.birthday}`),t.death&&n.push(`D\xE9c\xE8s : ${t.death}`),r?(P.textContent=n.length?`${r} \xB7 ${n.join(" \xB7 ")}`:r,P.classList.remove("hidden")):n.length?(P.textContent=n.join(" \xB7 "),P.classList.remove("hidden")):(P.textContent="",P.classList.add("hidden"));let i=Tt(t),a=0;i.forEach(o=>{let s=Ft(o.field,o.value);s.empty||(Ot(o.field,s),a+=1)}),a+=Mt(e),a===0?(ee.textContent="Aucune information suppl\xE9mentaire disponible.",ee.classList.remove("hidden")):ee.classList.add("hidden")}function Fe(e,t="card"){if(!e)return;let r=Ae(e.data||{})||`Profil ${e.id}`;if(ot(e),m&&(m.updateMainId(e.id),xe({treePosition:"inherit",initial:!1})),J(`${t==="search"?"Resultat":"Selection"} : ${r}`,"info"),t==="search"){let i=L==null?void 0:L.querySelector("input");i&&(i.value="",i.blur())}pe({mainId:e.id},{source:t,treePosition:t==="search"?"main_to_middle":"inherit",reposition:t==="search",preservePreferences:!0,selectedLabel:r,loadingLabel:`${t==="search"?"Recherche":"Selection"} : ${r}...`})}function jt(e){if(!L)return;L.innerHTML="";let t=de&&de.length?"ready":X&&X.length===0?"empty":"loading";fe(t),e.setPersonDropdown(i=>{let a=i.data||{},o=Ae(a)||"Profil sans nom",s=[];return a.birthday&&s.push(a.birthday),a.death&&s.push(`\u271D ${a.death}`),s.length?`${o} (${s.join(" \xB7 ")})`:o},{cont:L,placeholder:"Rechercher (nom, date, lieu, etc.)",onSelect:i=>{var s,f;let a=(f=(s=e.store)==null?void 0:s.getDatum)==null?void 0:f.call(s,i);if(a){Fe(a,"search");return}let o=be(i)||`Profil ${i}`;pe({mainId:i},{source:"search",treePosition:"main_to_middle",reposition:!0,preservePreferences:!0,selectedLabel:o,loadingLabel:`Recherche : ${o}...`})}});let r=L.querySelector(".f3-autocomplete-items");if(r){let i=()=>{let o=r.childElementCount>0;r.classList.toggle("is-empty",!o),o?r.tabIndex=0:r.removeAttribute("tabindex")};i(),new MutationObserver(i).observe(r,{childList:!0})}let n=L.querySelector("input");n&&(n.id="personSearchInput",n.setAttribute("placeholder","Rechercher (nom, date, lieu, etc.)"),_e&&_e.id&&n.setAttribute("aria-describedby",_e.id)),ge(e),nt().then(()=>{ge(e)}).catch(()=>{})}function at(e,t={}){var R,q,A,W,$,K,B,j,N;let r=document.querySelector(He);if(!r)throw new Error("Conteneur du graphique introuvable");let n=e&&e.data!==void 0?e:Le(e),i=Array.isArray(n.data)?n.data:[],a=n.config||{},o=!m;o&&(r.innerHTML=""),_t(),m?m.updateData(i):m=Ze.createChart(He,i);let s=m,f=yt(s,a),l={...f,mainId:t.mainId||f.mainId||c.mainId||null,ancestryDepth:y.ancestryDepth,progenyDepth:y.progenyDepth,miniTree:t.preservePreferences&&c?c.miniTree!==!1:f.miniTree!==!1,cardDisplay:f.cardDisplay&&f.cardDisplay.length?f.cardDisplay.map(D=>[...D]):Ee.map(D=>[...D])};t.preservePreferences&&c&&(l.cardDisplay=c.cardDisplay&&c.cardDisplay.length?c.cardDisplay.map(D=>[...D]):l.cardDisplay,l.transitionTime=(R=c.transitionTime)!=null?R:l.transitionTime,l.cardXSpacing=(q=c.cardXSpacing)!=null?q:l.cardXSpacing,l.cardYSpacing=(A=c.cardYSpacing)!=null?A:l.cardYSpacing,l.singleParentEmptyCard=(W=c.singleParentEmptyCard)!=null?W:l.singleParentEmptyCard,l.singleParentEmptyCardLabel=($=c.singleParentEmptyCardLabel)!=null?$:l.singleParentEmptyCardLabel,l.orientation=(K=c.orientation)!=null?K:l.orientation),c={...l},c.mainId=l.mainId;let u=c.cardDisplay&&c.cardDisplay.length?c.cardDisplay.map(D=>[...D]):Ee.map(D=>[...D]);E||(E=s.setCardHtml()),typeof E.setCardDisplay=="function"&&E.setCardDisplay(u),typeof E.setMiniTree=="function"&&E.setMiniTree(c.miniTree!==!1),typeof E.setOnCardClick=="function"&&E.setOnCardClick((D,F)=>{var z,v,U;let S=(z=F==null?void 0:F.data)==null?void 0:z.id;if(!S)return;let H=(U=(v=s.store)==null?void 0:v.getDatum)==null?void 0:U.call(v,S);if(H)Fe(H,"card");else{let Y=be(S)||`Profil ${S}`;pe({mainId:S},{source:"card",treePosition:"inherit",reposition:!1,preservePreferences:!0,selectedLabel:Y,loadingLabel:`Selection : ${Y}...`})}}),typeof E.setOnMiniTreeClick=="function"&&E.setOnMiniTreeClick((D,F)=>{var z,v,U;let S=(z=F==null?void 0:F.data)==null?void 0:z.id;if(!S)return;let H=(U=(v=s.store)==null?void 0:v.getDatum)==null?void 0:U.call(v,S);if(H)Fe(H,"card");else{let Y=be(S)||`Profil ${S}`;pe({mainId:S},{source:"card",treePosition:"inherit",reposition:!1,preservePreferences:!0,selectedLabel:Y,loadingLabel:`Selection : ${Y}...`})}}),x=!0,je(c),x=!1,c.mainId&&s.updateMainId(c.mainId),Et(s),o?jt(s):ge(s);let p=t.preservePreferences===!1,g=t.treePosition||(t.source==="search"?"main_to_middle":o?"fit":"inherit");xe({treePosition:g,initial:p});let h=(B=s.getMainDatum)==null?void 0:B.call(s),b=((N=(j=s.store)==null?void 0:j.getMainId)==null?void 0:N.call(j))||c.mainId;b&&b!==c.mainId&&(c.mainId=b),b&&(y.mainId=b,Q&&(Q={...Q,mainId:b})),h&&ot(h),we();let I=Number.isFinite(G.returned)?G.returned:i.length,T=Number.isFinite(G.total)?G.total:i.length,M=h?Ae(h.data||{})||`Profil ${h.id}`:t.selectedLabel||"Branche courante",k=t.source==="search"?"R\xE9sultat":t.source==="card"?"S\xE9lection":"Branche";J(`${k} : ${M} \u2014 ${I} ${I===1?"profil":"profils"} dans la branche / ${T} ${T===1?"profil":"profils"} au total`,"success"),V={source:t.source||k.toLowerCase(),label:M},nt().then(()=>{ge(s)}).catch(()=>{})}it({preservePreferences:!1,source:"system"}).catch(()=>{J("Impossible de charger les donn\xE9es","error")});
//# sourceMappingURL=viewer.bundle.js.map
