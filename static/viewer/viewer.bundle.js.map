{
  "version": 3,
  "sources": ["viewer.js"],
  "sourcesContent": ["import * as f3 from '/lib/family-tree.esm.js'\r\n\r\nconst statusEl = document.getElementById('status')\r\nconst detailsPanel = document.getElementById('personDetails')\r\nconst searchContainer = document.getElementById('personSearch')\r\nconst searchHint = document.getElementById('personSearchHint')\r\nconst searchRoot = document.querySelector('[data-role=\"viewer-search\"]')\r\nconst searchEmptyEl = document.querySelector('[data-role=\"viewer-search-empty\"]')\r\nconst detailsList = detailsPanel?.querySelector('.detail-list')\r\nconst detailsSummary = detailsPanel?.querySelector('.summary')\r\nconst emptyState = detailsPanel?.querySelector('.empty')\r\nconst chartSelector = '#FamilyChart'\r\nconst ancestryDepthControl = document.getElementById('viewerAncestryDepth')\r\nconst progenyDepthControl = document.getElementById('viewerProgenyDepth')\r\nconst miniTreeToggle = document.getElementById('viewerMiniTree')\r\nconst datasetMeta = document.querySelector('[data-role=\"dataset-meta\"]')\r\nconst visibleCountEl = document.querySelector('[data-role=\"visible-count\"]')\r\nconst branchCountEl = document.querySelector('[data-role=\"branch-count\"]')\r\nconst totalCountEl = document.querySelector('[data-role=\"total-count\"]')\r\n\r\nfunction normalizeFieldKey(value) {\r\n  if (value === undefined || value === null) return ''\r\n  return String(value).trim().toLowerCase()\r\n}\r\n\r\nfunction canonicalFieldKey(value) {\r\n  return normalizeFieldKey(value).replace(/[\\s_-]+/g, '')\r\n}\r\n\r\nfunction sanitizeFieldValues(values) {\r\n  if (!Array.isArray(values)) return []\r\n  const seen = new Set()\r\n  const result = []\r\n  values.forEach(rawValue => {\r\n    if (typeof rawValue !== 'string') return\r\n    const trimmed = rawValue.trim()\r\n    if (!trimmed) return\r\n    const key = normalizeFieldKey(trimmed)\r\n    if (seen.has(key)) return\r\n    seen.add(key)\r\n    result.push(trimmed)\r\n  })\r\n  return result\r\n}\r\n\r\nfunction safeTrim(value) {\r\n  return typeof value === 'string' ? value.trim() : ''\r\n}\r\n\r\nfunction buildDatasetLabel(datum = {}) {\r\n  const person = datum.data || {}\r\n  const first = safeTrim(person['first name'])\r\n  const last = safeTrim(person['last name'])\r\n  const base = (first || last) ? [first, last].filter(Boolean).join(' ').trim() : (datum.id ? `Profil ${datum.id}` : 'Profil sans nom')\r\n  const birth = safeTrim(person['birthday'])\r\n  return birth ? `${base} (${birth})` : base\r\n}\r\n\r\nfunction createDatasetSearchOption(datum) {\r\n  if (!datum || typeof datum.id !== 'string' || !datum.id.trim()) return null\r\n  const label = buildDatasetLabel(datum)\r\n  const tokens = new Set()\r\n  const metaParts = []\r\n  const metaSeen = new Set()\r\n\r\n  const addToken = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed) return\r\n    tokens.add(trimmed)\r\n  }\r\n\r\n  const addMeta = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed) return\r\n    if (metaSeen.has(trimmed)) return\r\n    metaSeen.add(trimmed)\r\n    metaParts.push(trimmed)\r\n  }\r\n\r\n  addToken(label)\r\n  addToken(String(datum.id))\r\n\r\n  const data = datum.data && typeof datum.data === 'object' ? datum.data : {}\r\n  Object.entries(data).forEach(([rawKey, rawValue]) => {\r\n    if (typeof rawValue !== 'string') return\r\n    const trimmed = rawValue.trim()\r\n    if (!trimmed) return\r\n    addToken(trimmed)\r\n    const key = normalizeFieldKey(rawKey)\r\n    if (key === 'birthday') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n    if (key === 'death') {\r\n      addMeta(`\u271D ${trimmed}`)\r\n      return\r\n    }\r\n    if (key === 'maiden name') {\r\n      addMeta(`(${trimmed})`)\r\n      return\r\n    }\r\n    if (key === 'occupation') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n    if (key === 'location' || key === 'residence' || key === 'birthplace' || key === 'deathplace') {\r\n      addMeta(trimmed)\r\n    }\r\n  })\r\n\r\n  const searchText = Array.from(tokens)\r\n    .map(value => value.replace(/\\s+/g, ' ').trim())\r\n    .filter(Boolean)\r\n    .join(' | ')\r\n\r\n  return {\r\n    label,\r\n    value: datum.id,\r\n    searchText,\r\n    optionHtml: (option) => {\r\n      const meta = metaParts.length ? `<small>${metaParts.join(' \u00B7 ')}</small>` : ''\r\n      return `<div>${option.label_html || option.label}${meta ? `<div class=\"f3-autocomplete-meta\">${meta}</div>` : ''}</div>`\r\n    }\r\n  }\r\n}\r\n\r\nfunction buildSearchOptionsFromDataset(persons) {\r\n  if (!Array.isArray(persons)) return []\r\n  const options = []\r\n  const seen = new Set()\r\n  persons.forEach(datum => {\r\n    if (!datum || !datum.id || seen.has(datum.id)) return\r\n    const option = createDatasetSearchOption(datum)\r\n    if (!option) return\r\n    options.push(option)\r\n    seen.add(datum.id)\r\n  })\r\n  options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }))\r\n  return options\r\n}\r\n\r\nfunction setViewerSearchState(state) {\r\n  if (!searchRoot) return\r\n  if (!state) {\r\n    delete searchRoot.dataset.state\r\n  } else {\r\n    searchRoot.dataset.state = String(state)\r\n  }\r\n  if (searchEmptyEl) {\r\n    if (state === 'error') {\r\n      searchEmptyEl.textContent = 'Impossible de charger la recherche pour le moment.'\r\n    } else {\r\n      searchEmptyEl.textContent = 'Aucune personne disponible pour le moment.'\r\n    }\r\n  }\r\n}\r\n\r\nconst DETAIL_FIELD_ORDER = [\r\n  'first name',\r\n  'first names',\r\n  'last name',\r\n  'birthday',\r\n  'death',\r\n  'gender',\r\n  'avatar',\r\n  'bio'\r\n]\r\n\r\n// Fields to hide from the viewer details and from search/meta indexing.\r\nconst HIDDEN_FIELD_KEYS = new Set([\r\n  'phone',\r\n  'email',\r\n  'notes',\r\n  'occupation',\r\n  'location',\r\n  'residence',\r\n  'nickname'\r\n])\r\n\r\nconst FIELD_LABELS = {\r\n  'first name': 'Pr\u00E9nom',\r\n  'first names': 'Pr\u00E9noms',\r\n  'firstnames': 'Pr\u00E9noms',\r\n  'first_names': 'Pr\u00E9noms',\r\n  'last name': 'Nom',\r\n  'nickname': 'Surnom',\r\n  'maiden name': 'Nom de jeune fille',\r\n  'birthday': 'Date de naissance',\r\n  'death': 'Date de D\u00E9c\u00E8s',\r\n  'gender': 'Genre',\r\n  'location': 'Localisation',\r\n  'birthplace': 'Lieu de naissance',\r\n  'deathplace': 'Lieu de d\u00E9c\u00E8s',\r\n  'occupation': 'Profession',\r\n  'bio': 'Biographie',\r\n  'notes': 'Notes',\r\n  'email': 'Email',\r\n  'phone': 'T\u00E9l\u00E9phone',\r\n  'avatar': 'Avatar'\r\n}\r\n\r\nconst GENDER_LABELS = {\r\n  'M': 'Masculin',\r\n  'F': 'F\u00E9minin',\r\n  'O': 'Autre',\r\n  'X': 'Non binaire'\r\n}\r\n\r\nconst DEFAULT_EMPTY_LABEL = 'Non renseign\u00E9'\r\n\r\nconst DEFAULT_CARD_DISPLAY = [\r\n  ['first name', 'last name'],\r\n  ['birthday']\r\n]\r\n\r\nconst DEFAULT_CHART_CONFIG = Object.freeze({\r\n  transitionTime: 200,\r\n  cardXSpacing: 240,\r\n  cardYSpacing: 140,\r\n  orientation: 'vertical',\r\n  showSiblingsOfMain: true,\r\n  singleParentEmptyCard: true,\r\n  singleParentEmptyCardLabel: 'Inconnu',\r\n  ancestryDepth: 4,\r\n  progenyDepth: 4,\r\n  miniTree: true,\r\n  cardDisplay: DEFAULT_CARD_DISPLAY.map(row => [...row]),\r\n  mainId: null\r\n})\r\n\r\nconst PROGRESSIVE_DEPTH_STEP = 4\r\nconst PROGRESSIVE_MAX_STEPS = 12\r\n\r\nlet chartInstance = null\r\nlet cardInstance = null\r\nlet viewerConfig = { ...DEFAULT_CHART_CONFIG }\r\nlet totalPersons = 0\r\nlet isApplyingViewerConfig = false\r\nlet serverQueryState = {\r\n  mainId: null,\r\n  ancestryDepth: DEFAULT_CHART_CONFIG.ancestryDepth,\r\n  progenyDepth: DEFAULT_CHART_CONFIG.progenyDepth,\r\n  includeSiblings: true,\r\n  includeSpouses: true\r\n}\r\nlet lastSuccessfulQuery = null\r\nlet latestMeta = {\r\n  total: 0,\r\n  returned: 0,\r\n  includeSiblings: true,\r\n  includeSpouses: true\r\n}\r\nlet activeFetchController = null\r\nlet searchSummaryPromise = null\r\nlet peopleSummary = null\r\nlet summarySearchOptions = []\r\nlet localSearchOptions = []\r\nlet searchOptions = []\r\nlet lastSelectionContext = { source: 'initial', label: null }\r\nlet peopleSummaryIndex = new Map()\r\nlet pendingMetaFrame = null\r\nconst lastMetaSnapshot = { visible: -1, branch: -1, total: -1 }\r\nlet lastStatusSnapshot = { message: '', type: '' }\r\n\r\nfunction normalizeCardDisplay(rows) {\r\n  const safeRows = Array.isArray(rows) ? rows : []\r\n  const normalized = safeRows.slice(0, 2).map(row => sanitizeFieldValues(Array.isArray(row) ? row : []))\r\n  while (normalized.length < 2) normalized.push([])\r\n  return normalized\r\n}\r\n\r\nfunction normaliseTreePayload(payload) {\r\n  if (Array.isArray(payload)) {\r\n    return { data: payload, config: {}, meta: {} }\r\n  }\r\n\r\n  if (payload && typeof payload === 'object') {\r\n    const meta = payload.meta && typeof payload.meta === 'object' ? payload.meta : {}\r\n    if (Array.isArray(payload.data)) {\r\n      const candidateConfig = payload.config || payload.settings || {}\r\n      return { data: payload.data, config: candidateConfig, meta }\r\n    }\r\n\r\n    if (Array.isArray(payload.tree)) {\r\n      const candidateConfig = payload.config || payload.settings || {}\r\n      return { data: payload.tree, config: candidateConfig, meta }\r\n    }\r\n  }\r\n\r\n  return { data: [], config: {}, meta: {} }\r\n}\r\n\r\nfunction normaliseChartConfig(rawConfig = {}) {\r\n  if (!rawConfig || typeof rawConfig !== 'object') return {}\r\n\r\n  const config = {}\r\n  const transition = rawConfig.transitionTime ?? rawConfig.transition_time\r\n  if (typeof transition === 'number' && Number.isFinite(transition)) {\r\n    config.transitionTime = transition\r\n  }\r\n\r\n  const cardX = rawConfig.cardXSpacing ?? rawConfig.card_x_spacing ?? rawConfig.node_separation\r\n  if (typeof cardX === 'number' && Number.isFinite(cardX)) {\r\n    config.cardXSpacing = cardX\r\n  }\r\n\r\n  const cardY = rawConfig.cardYSpacing ?? rawConfig.card_y_spacing ?? rawConfig.level_separation\r\n  if (typeof cardY === 'number' && Number.isFinite(cardY)) {\r\n    config.cardYSpacing = cardY\r\n  }\r\n\r\n  const orientation = rawConfig.orientation\r\n  if (orientation === 'horizontal' || orientation === 'vertical') {\r\n    config.orientation = orientation\r\n  } else if (typeof rawConfig.is_horizontal === 'boolean') {\r\n    config.orientation = rawConfig.is_horizontal ? 'horizontal' : 'vertical'\r\n  }\r\n\r\n  const showSiblings = rawConfig.showSiblingsOfMain ?? rawConfig.show_siblings_of_main\r\n  if (typeof showSiblings === 'boolean') {\r\n    config.showSiblingsOfMain = showSiblings\r\n  }\r\n\r\n  const singleParentEnabled = rawConfig.singleParentEmptyCard ?? rawConfig.single_parent_empty_card\r\n  if (typeof singleParentEnabled === 'boolean') {\r\n    config.singleParentEmptyCard = singleParentEnabled\r\n  }\r\n\r\n  const emptyLabel = rawConfig.singleParentEmptyCardLabel ?? rawConfig.single_parent_empty_card_label\r\n  if (typeof emptyLabel === 'string' && emptyLabel.trim().length > 0) {\r\n    config.singleParentEmptyCardLabel = emptyLabel.trim()\r\n  }\r\n\r\n  const rawCardDisplay = rawConfig.cardDisplay ?? rawConfig.card_display\r\n  if (Array.isArray(rawCardDisplay) || (rawCardDisplay && typeof rawCardDisplay === 'object')) {\r\n    let source = rawCardDisplay\r\n    if (rawCardDisplay && !Array.isArray(rawCardDisplay) && typeof rawCardDisplay === 'object') {\r\n      source = [\r\n        rawCardDisplay[0] ?? rawCardDisplay['0'] ?? rawCardDisplay.row1 ?? rawCardDisplay.row_1 ?? rawCardDisplay.ligne1 ?? rawCardDisplay.line1 ?? rawCardDisplay.first ?? [],\r\n        rawCardDisplay[1] ?? rawCardDisplay['1'] ?? rawCardDisplay.row2 ?? rawCardDisplay.row_2 ?? rawCardDisplay.ligne2 ?? rawCardDisplay.line2 ?? rawCardDisplay.second ?? []\r\n      ]\r\n    }\r\n    config.cardDisplay = normalizeCardDisplay(source)\r\n  }\r\n\r\n  const rawMainId = rawConfig.mainId ?? rawConfig.main_id ?? rawConfig.mainPersonId ?? rawConfig.main_person_id\r\n  if (typeof rawMainId === 'string' && rawMainId.trim().length > 0) {\r\n    config.mainId = rawMainId.trim()\r\n  }\r\n\r\n  const rawAncestryDepth = rawConfig.ancestryDepth ?? rawConfig.ancestry_depth\r\n  if (rawAncestryDepth === null) {\r\n    config.ancestryDepth = null\r\n  } else if (rawAncestryDepth !== undefined) {\r\n    const value = Number(rawAncestryDepth)\r\n    if (Number.isFinite(value) && value >= 0) {\r\n      config.ancestryDepth = Math.floor(value)\r\n    }\r\n  }\r\n\r\n  const rawProgenyDepth = rawConfig.progenyDepth ?? rawConfig.progeny_depth\r\n  if (rawProgenyDepth === null) {\r\n    config.progenyDepth = null\r\n  } else if (rawProgenyDepth !== undefined) {\r\n    const value = Number(rawProgenyDepth)\r\n    if (Number.isFinite(value) && value >= 0) {\r\n      config.progenyDepth = Math.floor(value)\r\n    }\r\n  }\r\n\r\n  const rawMiniTree = rawConfig.miniTree ?? rawConfig.mini_tree\r\n  if (typeof rawMiniTree === 'boolean') {\r\n    config.miniTree = rawMiniTree\r\n  }\r\n\r\n  \r\n\r\n  return config\r\n}\r\n\r\nfunction applyConfigToChart(chart, rawConfig) {\r\n  const overrides = normaliseChartConfig(rawConfig)\r\n  const config = { ...DEFAULT_CHART_CONFIG, ...overrides }\r\n\r\n  const cardDisplayOverride = overrides.cardDisplay\r\n  config.cardDisplay = (cardDisplayOverride && cardDisplayOverride.length)\r\n    ? cardDisplayOverride.map(row => [...row])\r\n    : DEFAULT_CARD_DISPLAY.map(row => [...row])\r\n\r\n  chart.setTransitionTime(config.transitionTime)\r\n  chart.setCardXSpacing(config.cardXSpacing)\r\n  chart.setCardYSpacing(config.cardYSpacing)\r\n  chart.setShowSiblingsOfMain(config.showSiblingsOfMain)\r\n\r\n  if (config.orientation === 'horizontal') {\r\n    chart.setOrientationHorizontal()\r\n  } else {\r\n    chart.setOrientationVertical()\r\n  }\r\n\r\n  chart.setSingleParentEmptyCard(config.singleParentEmptyCard, {\r\n    label: config.singleParentEmptyCardLabel\r\n  })\r\n\r\n  if (typeof config.ancestryDepth === 'number' && Number.isFinite(config.ancestryDepth)) {\r\n    chart.setAncestryDepth(config.ancestryDepth)\r\n  } else {\r\n    chart.setAncestryDepth(null)\r\n  }\r\n\r\n  if (typeof config.progenyDepth === 'number' && Number.isFinite(config.progenyDepth)) {\r\n    chart.setProgenyDepth(config.progenyDepth)\r\n  } else {\r\n    chart.setProgenyDepth(null)\r\n  }\r\n\r\n  // duplicate branch merging option removed; chart will use internal defaults\r\n\r\n  return config\r\n}\r\n\r\nfunction serialiseDepthParam(value) {\r\n  if (value === 'auto') return undefined\r\n  if (value === 'all' || value === null) return 'all'\r\n  if (typeof value === 'number' && Number.isFinite(value) && value >= 0) {\r\n    return String(Math.floor(value))\r\n  }\r\n  return undefined\r\n}\r\n\r\nfunction buildSubtreeQuery(params) {\r\n  const query = new URLSearchParams()\r\n  query.set('mode', 'subtree')\r\n\r\n  if (params.mainId && typeof params.mainId === 'string') {\r\n    query.set('mainId', params.mainId)\r\n  }\r\n\r\n  const ancestryDepth = serialiseDepthParam(params.ancestryDepth)\r\n  if (ancestryDepth !== undefined) {\r\n    query.set('ancestryDepth', ancestryDepth)\r\n  }\r\n\r\n  const progenyDepth = serialiseDepthParam(params.progenyDepth)\r\n  if (progenyDepth !== undefined) {\r\n    query.set('progenyDepth', progenyDepth)\r\n  }\r\n\r\n  if (params.includeSiblings !== undefined) {\r\n    query.set('includeSiblings', params.includeSiblings ? 'true' : 'false')\r\n  }\r\n\r\n  if (params.includeSpouses !== undefined) {\r\n    query.set('includeSpouses', params.includeSpouses ? 'true' : 'false')\r\n  }\r\n\r\n  return query.toString()\r\n}\r\n\r\nfunction setInterfaceLoading(isLoading) {\r\n  const loading = Boolean(isLoading)\r\n  if (datasetMeta) datasetMeta.classList.toggle('is-loading', loading)\r\n  if (searchContainer) searchContainer.classList.toggle('is-loading', loading)\r\n}\r\n\r\nfunction abortActiveFetch() {\r\n  if (activeFetchController) {\r\n    activeFetchController.abort()\r\n    activeFetchController = null\r\n  }\r\n}\r\n\r\nfunction normaliseMeta(meta, fallbackTotal = 0, fallbackReturned = fallbackTotal) {\r\n  const payloadMeta = meta && typeof meta === 'object' ? meta : {}\r\n  const total = Number.isFinite(payloadMeta.total) ? Math.max(0, Math.floor(payloadMeta.total)) : Math.max(0, Math.floor(fallbackTotal))\r\n  const returned = Number.isFinite(payloadMeta.returned) ? Math.max(0, Math.floor(payloadMeta.returned)) : Math.max(0, Math.floor(fallbackReturned))\r\n  const ancestryDepth = payloadMeta.ancestryDepth === null\r\n    ? null\r\n    : Number.isFinite(payloadMeta.ancestryDepth)\r\n      ? Math.max(0, Math.floor(payloadMeta.ancestryDepth))\r\n      : undefined\r\n  const progenyDepth = payloadMeta.progenyDepth === null\r\n    ? null\r\n    : Number.isFinite(payloadMeta.progenyDepth)\r\n      ? Math.max(0, Math.floor(payloadMeta.progenyDepth))\r\n      : undefined\r\n\r\n  return {\r\n    total,\r\n    returned,\r\n    includeSiblings: payloadMeta.includeSiblings !== false,\r\n    includeSpouses: payloadMeta.includeSpouses !== false,\r\n    ancestryDepth,\r\n    progenyDepth\r\n  }\r\n}\r\n\r\nfunction hasQueryChanged(nextParams) {\r\n  if (!lastSuccessfulQuery) return true\r\n  const keys = ['mainId', 'ancestryDepth', 'progenyDepth', 'includeSiblings', 'includeSpouses']\r\n  return keys.some(key => {\r\n    const previous = lastSuccessfulQuery[key]\r\n    const next = nextParams[key]\r\n    if (previous === next) return false\r\n    if (previous === null && next === undefined) return false\r\n    if (previous === undefined && next === null) return false\r\n    return true\r\n  })\r\n}\r\n\r\nfunction buildSearchOption(person) {\r\n  const label = typeof person.label === 'string' && person.label.trim() ? person.label.trim() : `Profil ${person.id}`\r\n  const tokens = new Set()\r\n  const metaParts = []\r\n  const metaSeen = new Set()\r\n\r\n  const addToken = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed) return\r\n    tokens.add(trimmed)\r\n  }\r\n\r\n  const addMeta = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed) return\r\n    const key = trimmed.toLowerCase()\r\n    if (metaSeen.has(key)) return\r\n    metaSeen.add(key)\r\n    metaParts.push(trimmed)\r\n  }\r\n\r\n  const registerField = (rawKey, rawValue) => {\r\n    if (typeof rawValue !== 'string') return\r\n    const trimmed = rawValue.trim()\r\n    if (!trimmed) return\r\n    // Hide configured fields from search/meta tokens\r\n    const rkey = normalizeFieldKey(rawKey)\r\n    if (HIDDEN_FIELD_KEYS.has(rkey)) return\r\n    addToken(trimmed)\r\n    const key = normalizeFieldKey(rawKey)\r\n    if (key === 'birthday') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n    if (key === 'death') {\r\n      addMeta(`\u271D ${trimmed}`)\r\n      return\r\n    }\r\n    if (key === 'maiden name') {\r\n      addMeta(`(${trimmed})`)\r\n      return\r\n    }\r\n    if (key === 'location' || key === 'residence' || key === 'birthplace' || key === 'deathplace') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n  }\r\n\r\n  addToken(label)\r\n  addToken(String(person.id || ''))\r\n\r\n  if (typeof person.searchText === 'string' && person.searchText.trim()) {\r\n    person.searchText.split('|').forEach(fragment => addToken(fragment))\r\n  }\r\n\r\n  registerField('birthday', person.birthday)\r\n  registerField('death', person.death)\r\n  registerField('location', person.location)\r\n  registerField('residence', person.residence)\r\n  registerField('maiden name', person.maidenName)\r\n\r\n  if (person.fields && typeof person.fields === 'object') {\r\n    Object.entries(person.fields).forEach(([fieldKey, fieldValue]) => {\r\n      registerField(fieldKey, fieldValue)\r\n    })\r\n  }\r\n\r\n  const normalisedTokens = Array.from(tokens)\r\n    .map(value => value.replace(/\\s+/g, ' ').trim())\r\n    .filter(Boolean)\r\n\r\n  const searchText = normalisedTokens.length ? normalisedTokens.join(' | ') : label\r\n\r\n  return {\r\n    label,\r\n    value: person.id,\r\n    searchText,\r\n    optionHtml: (option) => {\r\n      const title = option.label_html || option.label\r\n      const meta = metaParts.length ? `<small>${metaParts.join(' \u00B7 ')}</small>` : ''\r\n      return `<div>${title}${meta ? `<div class=\"f3-autocomplete-meta\">${meta}</div>` : ''}</div>`\r\n    }\r\n  }\r\n}\r\n\r\nfunction buildSearchOptionsFromSummary(summary) {\r\n  if (!summary || !Array.isArray(summary.persons)) return []\r\n  const options = summary.persons\r\n    .filter(person => person && typeof person.id === 'string')\r\n    .map(person => buildSearchOption(person))\r\n  options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }))\r\n  return options\r\n}\r\n\r\nfunction combineSearchOptions() {\r\n  const merged = new Map()\r\n  const mergeEntry = (option) => {\r\n    if (!option || !option.value) return\r\n    if (!merged.has(option.value)) {\r\n      merged.set(option.value, { ...option })\r\n      return\r\n    }\r\n    const existing = merged.get(option.value)\r\n    const mergedSearchText = mergeSearchText(existing.searchText, option.searchText)\r\n    if (mergedSearchText) {\r\n      existing.searchText = mergedSearchText\r\n    }\r\n    if (typeof existing.optionHtml !== 'function' && typeof option.optionHtml === 'function') {\r\n      existing.optionHtml = option.optionHtml\r\n    }\r\n  }\r\n\r\n  const mergeSearchText = (first, second) => {\r\n    const segments = new Set()\r\n    const add = (value) => {\r\n      if (typeof value !== 'string') return\r\n      value.split('|').forEach(part => {\r\n        const trimmed = part.trim()\r\n        if (trimmed) segments.add(trimmed)\r\n      })\r\n    }\r\n    add(first)\r\n    add(second)\r\n    if (!segments.size) return (first || second || '')\r\n    return Array.from(segments).join(' | ')\r\n  }\r\n\r\n  localSearchOptions.forEach(mergeEntry)\r\n  summarySearchOptions.forEach(mergeEntry)\r\n\r\n  searchOptions = Array.from(merged.values())\r\n  searchOptions.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }))\r\n  if (chartInstance) {\r\n    updateSearchOptionsForChart(chartInstance)\r\n  }\r\n}\r\n\r\nfunction rebuildLocalSearchOptions(chart) {\r\n  if (!chart || !chart.store || typeof chart.store.getData !== 'function') {\r\n    localSearchOptions = []\r\n    combineSearchOptions()\r\n    return\r\n  }\r\n\r\n  try {\r\n    const persons = chart.store.getData()\r\n    localSearchOptions = buildSearchOptionsFromDataset(persons)\r\n  } catch (error) {\r\n    console.warn('[viewer] Impossible de reconstruire l\u2019index local de recherche', error)\r\n    localSearchOptions = []\r\n  }\r\n\r\n  combineSearchOptions()\r\n}\r\n\r\nfunction setSearchLoadingState(state) {\r\n  setViewerSearchState(state)\r\n  if (!searchContainer) return\r\n  if (!state) {\r\n    searchContainer.dataset.state = ''\r\n  } else {\r\n    searchContainer.dataset.state = String(state)\r\n  }\r\n}\r\n\r\nasync function ensurePeopleSummary(force = false) {\r\n  if (!force && peopleSummary) return peopleSummary\r\n  if (!force && searchSummaryPromise) return searchSummaryPromise\r\n\r\n  setSearchLoadingState('loading')\r\n  const controller = new AbortController()\r\n  const promise = fetch('/api/tree/summary', { cache: 'no-store', signal: controller.signal })\r\n    .then(response => {\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}`)\r\n      }\r\n      return response.json()\r\n    })\r\n    .then(summary => {\r\n      peopleSummary = summary\r\n      peopleSummaryIndex = new Map()\r\n      if (Array.isArray(summary?.persons)) {\r\n        summary.persons.forEach(person => {\r\n          if (person && typeof person.id === 'string') {\r\n            peopleSummaryIndex.set(person.id, person)\r\n          }\r\n        })\r\n      }\r\n      summarySearchOptions = buildSearchOptionsFromSummary(summary)\r\n      setViewerSearchState(summarySearchOptions.length ? 'ready' : 'empty')\r\n      combineSearchOptions()\r\n      return peopleSummary\r\n    })\r\n    .catch(error => {\r\n      if (error.name === 'AbortError') return peopleSummary\r\n      console.error('Impossible de charger l\\'index de recherche', error)\r\n      setViewerSearchState('error')\r\n      throw error\r\n    })\r\n    .finally(() => {\r\n      if (searchSummaryPromise === promise) {\r\n        searchSummaryPromise = null\r\n      }\r\n    })\r\n\r\n  searchSummaryPromise = promise\r\n  return promise\r\n}\r\n\r\nfunction updateSearchOptionsForChart(chart) {\r\n  if (!chart || !chart.personSearch) return\r\n  const options = Array.isArray(searchOptions) ? searchOptions : []\r\n  chart.personSearch.setOptionsGetter(() => options)\r\n  if (options.length) {\r\n    setViewerSearchState('ready')\r\n  } else if (peopleSummary) {\r\n    setViewerSearchState('empty')\r\n  }\r\n}\r\n\r\nfunction setStatus(message, type = 'info') {\r\n  if (!statusEl) return\r\n  if (lastStatusSnapshot.message === message && lastStatusSnapshot.type === type) {\r\n    return\r\n  }\r\n  lastStatusSnapshot = { message, type }\r\n  statusEl.textContent = message\r\n  statusEl.dataset.status = type\r\n}\r\n\r\nfunction depthToSelectValue(value, fallback) {\r\n  if (value === 'auto') return 'auto'\r\n  if (value === 'all') return 'all'\r\n  if (value === null) return 'all'\r\n  if (typeof value === 'number' && Number.isFinite(value) && value >= 0) {\r\n    return String(Math.floor(value))\r\n  }\r\n  if (typeof fallback === 'number' && Number.isFinite(fallback) && fallback >= 0) {\r\n    return String(Math.floor(fallback))\r\n  }\r\n  if (fallback === 'auto') return 'auto'\r\n  if (fallback === 'all' || fallback === null) return 'all'\r\n  return 'auto'\r\n}\r\n\r\nfunction parseDepthSelectValue(select, fallback) {\r\n  if (!select) return fallback\r\n  const raw = select.value\r\n  if (raw === 'auto') return 'auto'\r\n  if (raw === 'all' || raw === '') return 'all'\r\n  const value = Number(raw)\r\n  if (Number.isFinite(value) && value >= 0) {\r\n    return Math.floor(value)\r\n  }\r\n  return fallback\r\n}\r\n\r\nfunction updatePerformanceControlsUI(config) {\r\n  if (ancestryDepthControl) ancestryDepthControl.value = depthToSelectValue(config.ancestryDepth, DEFAULT_CHART_CONFIG.ancestryDepth)\r\n  if (progenyDepthControl) progenyDepthControl.value = depthToSelectValue(config.progenyDepth, DEFAULT_CHART_CONFIG.progenyDepth)\r\n  if (miniTreeToggle) miniTreeToggle.checked = config.miniTree !== false\r\n  // duplicate branch toggle control removed; no UI state to sync\r\n}\r\n\r\nfunction updateDatasetMeta() {\r\n  if (pendingMetaFrame !== null) return\r\n  const schedule = typeof requestAnimationFrame === 'function' ? requestAnimationFrame : (cb) => setTimeout(cb, 16)\r\n  pendingMetaFrame = schedule(() => {\r\n    pendingMetaFrame = null\r\n    const visible = chartInstance?.store?.getTree?.()?.data?.length ?? 0\r\n    const branchCount = Number.isFinite(latestMeta.returned) ? latestMeta.returned : visible\r\n\r\n    if (lastMetaSnapshot.visible === visible && lastMetaSnapshot.branch === branchCount && lastMetaSnapshot.total === totalPersons) {\r\n      return\r\n    }\r\n\r\n    lastMetaSnapshot.visible = visible\r\n    lastMetaSnapshot.branch = branchCount\r\n    lastMetaSnapshot.total = totalPersons\r\n\r\n    if (visibleCountEl) visibleCountEl.textContent = String(visible)\r\n    if (branchCountEl) branchCountEl.textContent = String(branchCount)\r\n    if (totalCountEl) totalCountEl.textContent = String(totalPersons)\r\n    if (datasetMeta) {\r\n      datasetMeta.dataset.visible = String(visible)\r\n      datasetMeta.dataset.total = String(totalPersons)\r\n      datasetMeta.dataset.branch = String(branchCount)\r\n    }\r\n  })\r\n}\r\n\r\nfunction applyViewerConfig({ treePosition = 'inherit', initial = false } = {}) {\r\n  if (!chartInstance) return\r\n  if (typeof viewerConfig.ancestryDepth === 'number' && Number.isFinite(viewerConfig.ancestryDepth)) {\r\n    chartInstance.setAncestryDepth(viewerConfig.ancestryDepth)\r\n  } else {\r\n    chartInstance.setAncestryDepth(null)\r\n  }\r\n\r\n  if (typeof viewerConfig.progenyDepth === 'number' && Number.isFinite(viewerConfig.progenyDepth)) {\r\n    chartInstance.setProgenyDepth(viewerConfig.progenyDepth)\r\n  } else {\r\n    chartInstance.setProgenyDepth(null)\r\n  }\r\n\r\n  // duplicate branch merging option removed; chart will use internal defaults\r\n\r\n  if (cardInstance && typeof cardInstance.setMiniTree === 'function') {\r\n    cardInstance.setMiniTree(viewerConfig.miniTree !== false)\r\n  }\r\n\r\n  isApplyingViewerConfig = true\r\n  updatePerformanceControlsUI(viewerConfig)\r\n  isApplyingViewerConfig = false\r\n\r\n  let nextPosition = 'inherit'\r\n  if (treePosition === 'fit' || treePosition === 'main_to_middle') {\r\n    nextPosition = treePosition\r\n  }\r\n  chartInstance.updateTree({ initial, tree_position: nextPosition })\r\n  updateDatasetMeta()\r\n}\r\n\r\nfunction attachPerformanceHandlers() {\r\n  ancestryDepthControl?.addEventListener('change', () => {\r\n    if (isApplyingViewerConfig) return\r\n    const fallback = viewerConfig.ancestryDepth ?? DEFAULT_CHART_CONFIG.ancestryDepth ?? null\r\n    const value = parseDepthSelectValue(ancestryDepthControl, fallback)\r\n    if (value === viewerConfig.ancestryDepth) return\r\n    viewerConfig = { ...viewerConfig, ancestryDepth: value }\r\n    requestSubtree({ ancestryDepth: value }, {\r\n      reason: 'ancestry-depth-change',\r\n      source: 'controls',\r\n      reposition: false,\r\n      treePosition: 'inherit',\r\n      preservePreferences: true\r\n    })\r\n  })\r\n\r\n  progenyDepthControl?.addEventListener('change', () => {\r\n    if (isApplyingViewerConfig) return\r\n    const fallback = viewerConfig.progenyDepth ?? DEFAULT_CHART_CONFIG.progenyDepth ?? null\r\n    const value = parseDepthSelectValue(progenyDepthControl, fallback)\r\n    if (value === viewerConfig.progenyDepth) return\r\n    viewerConfig = { ...viewerConfig, progenyDepth: value }\r\n    requestSubtree({ progenyDepth: value }, {\r\n      reason: 'progeny-depth-change',\r\n      source: 'controls',\r\n      reposition: false,\r\n      treePosition: 'inherit',\r\n      preservePreferences: true\r\n    })\r\n  })\r\n\r\n  miniTreeToggle?.addEventListener('change', () => {\r\n    if (isApplyingViewerConfig) return\r\n    const enabled = miniTreeToggle.checked\r\n    const previous = viewerConfig.miniTree !== false\r\n    if (enabled === previous) return\r\n    viewerConfig = { ...viewerConfig, miniTree: enabled }\r\n    applyViewerConfig({ treePosition: 'inherit' })\r\n  })\r\n\r\n  // duplicate toggle listener removed (option removed from UI)\r\n}\r\n\r\nattachPerformanceHandlers()\r\n\r\nfunction resolveLabelFromSummary(id) {\r\n  if (!id || typeof id !== 'string') return null\r\n  if (peopleSummaryIndex && peopleSummaryIndex.has(id)) {\r\n    const entry = peopleSummaryIndex.get(id)\r\n    if (entry && typeof entry.label === 'string' && entry.label.trim()) {\r\n      return entry.label.trim()\r\n    }\r\n  }\r\n  return null\r\n}\r\n\r\nfunction describeDepthValue(value) {\r\n  if (value === 'auto') return 'auto (progressif)'\r\n  if (value === 'all' || value === null) return 'sans limite'\r\n  if (typeof value === 'number' && Number.isFinite(value)) {\r\n    if (value === 0) return 'profil seul'\r\n    return `${Math.floor(value)}`\r\n  }\r\n  return 'auto (progressif)'\r\n}\r\n\r\nfunction buildDepthSummary(config) {\r\n  const ancestry = describeDepthValue(config.ancestryDepth)\r\n  const progeny = describeDepthValue(config.progenyDepth)\r\n  // Clarify that these are configured depths (or modes) rather than counts\r\n  return `Profondeur \u2014 Anc\u00EAtres: ${ancestry}, Descendants: ${progeny}`\r\n}\r\n\r\nasync function requestSubtree(partialParams = {}, context = {}) {\r\n  const nextParams = {\r\n    ...serverQueryState,\r\n    ...partialParams\r\n  }\r\n\r\n  if (!hasQueryChanged(nextParams) && !context.force) {\r\n    lastSelectionContext = {\r\n      source: context.source || lastSelectionContext.source,\r\n      label: context.selectedLabel || lastSelectionContext.label\r\n    }\r\n    return\r\n  }\r\n\r\n  serverQueryState = { ...nextParams }\r\n  lastSelectionContext = {\r\n    source: context.source || 'system',\r\n    label: context.selectedLabel || resolveLabelFromSummary(nextParams.mainId) || lastSelectionContext.label\r\n  }\r\n\r\n  const loadingLabel = context.loadingLabel\r\n    || (context.source === 'search' ? 'Recherche de la branche...' : 'Chargement de la branche...')\r\n\r\n  setStatus(loadingLabel, 'loading')\r\n  setInterfaceLoading(true)\r\n\r\n  const controller = new AbortController()\r\n  abortActiveFetch()\r\n  activeFetchController = controller\r\n\r\n  const wantsAutoAncestry = nextParams.ancestryDepth === 'auto' || nextParams.ancestryDepth === null\r\n  const wantsAutoProgeny = nextParams.progenyDepth === 'auto' || nextParams.progenyDepth === null\r\n  const shouldProgressiveLoad = !context.disableProgressive && (wantsAutoAncestry || wantsAutoProgeny)\r\n\r\n  try {\r\n    if (shouldProgressiveLoad) {\r\n      await progressiveSubtreeRequest(nextParams, { ...context, controller })\r\n    } else {\r\n      await fetchSubtreeOnce(nextParams, { ...context, controller })\r\n    }\r\n  } finally {\r\n    if (activeFetchController === controller) {\r\n      activeFetchController = null\r\n      setInterfaceLoading(false)\r\n    }\r\n  }\r\n}\r\n\r\nasync function progressiveSubtreeRequest(initialParams, context = {}) {\r\n  const controller = context.controller\r\n  const wantsAutoAncestry = initialParams.ancestryDepth === 'auto' || initialParams.ancestryDepth === null\r\n  const wantsAutoProgeny = initialParams.progenyDepth === 'auto' || initialParams.progenyDepth === null\r\n  const stepInput = Number.isFinite(context.progressiveStep) && context.progressiveStep > 0\r\n    ? Math.floor(context.progressiveStep)\r\n    : PROGRESSIVE_DEPTH_STEP\r\n  const stepSize = Math.max(1, stepInput)\r\n\r\n  const currentParams = { ...initialParams }\r\n  if (wantsAutoAncestry) {\r\n    const fallback = Number.isFinite(DEFAULT_CHART_CONFIG.ancestryDepth)\r\n      ? Math.max(0, DEFAULT_CHART_CONFIG.ancestryDepth)\r\n      : stepSize\r\n    currentParams.ancestryDepth = Math.max(stepSize, fallback)\r\n  }\r\n\r\n  if (wantsAutoProgeny) {\r\n    const fallback = Number.isFinite(DEFAULT_CHART_CONFIG.progenyDepth)\r\n      ? Math.max(0, DEFAULT_CHART_CONFIG.progenyDepth)\r\n      : stepSize\r\n    currentParams.progenyDepth = Math.max(stepSize, fallback)\r\n  }\r\n\r\n  const originalSnapshot = {\r\n    ...initialParams,\r\n    ancestryDepth: wantsAutoAncestry ? 'auto' : initialParams.ancestryDepth,\r\n    progenyDepth: wantsAutoProgeny ? 'auto' : initialParams.progenyDepth\r\n  }\r\n  let iterations = 0\r\n  let previousCount = chartInstance?.store?.getTree?.()?.data?.length ?? 0\r\n  let encounteredError = false\r\n\r\n  while (iterations < PROGRESSIVE_MAX_STEPS) {\r\n    iterations += 1\r\n\r\n    if (controller?.signal?.aborted) {\r\n      return\r\n    }\r\n\r\n    if (wantsAutoAncestry || wantsAutoProgeny) {\r\n      const summaryParts = []\r\n      if (wantsAutoAncestry) summaryParts.push(`anc\u00EAtres \u2264 ${currentParams.ancestryDepth}`)\r\n      if (wantsAutoProgeny) summaryParts.push(`descendants \u2264 ${currentParams.progenyDepth}`)\r\n      if (summaryParts.length) {\r\n        setStatus(`Chargement progressif (${summaryParts.join(', ')})...`, 'loading')\r\n      }\r\n    }\r\n\r\n    const firstBatch = iterations === 1\r\n    const batchTreePosition = firstBatch\r\n      ? (context.treePosition !== undefined\r\n        ? context.treePosition\r\n        : (context.reposition === false\r\n          ? 'inherit'\r\n          : (context.source === 'search' ? 'main_to_middle' : 'inherit')))\r\n      : 'inherit'\r\n\r\n    const result = await fetchSubtreeOnce(currentParams, {\r\n      ...context,\r\n      controller,\r\n      progressiveBatch: true,\r\n      reposition: firstBatch ? context.reposition : false,\r\n      treePosition: batchTreePosition\r\n    })\r\n\r\n    if (!result || result.aborted) {\r\n      return\r\n    }\r\n\r\n    if (result.error) {\r\n      encounteredError = true\r\n      break\r\n    }\r\n\r\n    const meta = result.meta || {}\r\n    const currentCount = chartInstance?.store?.getTree?.()?.data?.length ?? meta.returned ?? previousCount\r\n    const gained = currentCount - previousCount\r\n    previousCount = currentCount\r\n\r\n    if (gained <= 0) {\r\n      break\r\n    }\r\n\r\n    if (wantsAutoAncestry) {\r\n      currentParams.ancestryDepth += stepSize\r\n    }\r\n\r\n    if (wantsAutoProgeny) {\r\n      currentParams.progenyDepth += stepSize\r\n    }\r\n  }\r\n\r\n  if (encounteredError) {\r\n    return\r\n  }\r\n\r\n  lastSuccessfulQuery = { ...originalSnapshot }\r\n  serverQueryState = {\r\n    ...serverQueryState,\r\n    ...originalSnapshot\r\n  }\r\n\r\n  if (viewerConfig) {\r\n    viewerConfig = { ...viewerConfig }\r\n    if (wantsAutoAncestry) viewerConfig.ancestryDepth = 'auto'\r\n    if (wantsAutoProgeny) viewerConfig.progenyDepth = 'auto'\r\n    isApplyingViewerConfig = true\r\n    updatePerformanceControlsUI(viewerConfig)\r\n    isApplyingViewerConfig = false\r\n  }\r\n}\r\n\r\nasync function fetchSubtreeOnce(params, context = {}) {\r\n  const controller = context.controller || new AbortController()\r\n  if (!context.controller) {\r\n    abortActiveFetch()\r\n    activeFetchController = controller\r\n  }\r\n\r\n  const queryString = buildSubtreeQuery(params)\r\n\r\n  try {\r\n    const response = await fetch(`/api/tree?${queryString}`, { cache: 'no-store', signal: controller.signal })\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP ${response.status}`)\r\n    }\r\n\r\n    const payload = await response.json()\r\n    if (controller.signal.aborted) {\r\n      return { aborted: true }\r\n    }\r\n\r\n    const normalised = normaliseTreePayload(payload)\r\n    const persons = Array.isArray(normalised.data) ? normalised.data : []\r\n    const metaInfo = normaliseMeta(normalised.meta, persons.length)\r\n\r\n    if (!persons.length && context.reason === 'initial' && !context.allowEmpty) {\r\n      await fetchFullTree({\r\n        ...context,\r\n        preservePreferences: false,\r\n        loadingLabel: 'Chargement complet de l\\'arbre...',\r\n        source: context.source || 'system'\r\n      })\r\n      return { aborted: false, meta: metaInfo }\r\n    }\r\n\r\n    lastSuccessfulQuery = { ...params }\r\n    applySubtreePayload({\r\n      data: persons,\r\n      config: normalised.config,\r\n      meta: metaInfo\r\n    }, {\r\n      ...context,\r\n      params\r\n    })\r\n\r\n    return { aborted: false, meta: metaInfo }\r\n  } catch (error) {\r\n    if (error.name === 'AbortError') {\r\n      return { aborted: true, error }\r\n    }\r\n    console.error('Erreur de chargement de sous-arbre', error)\r\n    setStatus(`Erreur: ${(error && error.message) || 'chargement interrompu'}`, 'error')\r\n    return { aborted: false, error }\r\n  }\r\n}\r\n\r\nfunction fetchFullTree(context = {}) {\r\n  const loadingLabel = context.loadingLabel || 'Chargement complet de l\\'arbre...'\r\n  setStatus(loadingLabel, 'loading')\r\n  setInterfaceLoading(true)\r\n\r\n  return fetch('/api/tree', { cache: 'no-store' })\r\n    .then(response => {\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}`)\r\n      }\r\n      return response.json()\r\n    })\r\n    .then(payload => {\r\n      const normalised = normaliseTreePayload(payload)\r\n      const persons = Array.isArray(normalised.data) ? normalised.data : []\r\n      const metaInfo = normaliseMeta(normalised.meta, persons.length)\r\n      latestMeta = metaInfo\r\n      totalPersons = metaInfo.total\r\n\r\n      const resolvedMainId = context.mainId\r\n        || (typeof normalised.config?.mainId === 'string' ? normalised.config.mainId : null)\r\n        || (persons[0]?.id ?? null)\r\n\r\n      if (resolvedMainId) {\r\n        serverQueryState = { ...serverQueryState, mainId: resolvedMainId }\r\n      }\r\n\r\n      lastSuccessfulQuery = null\r\n\r\n      renderChart({\r\n        data: persons,\r\n        config: normalised.config,\r\n        meta: metaInfo\r\n      }, {\r\n        preservePreferences: context.preservePreferences !== false,\r\n        treePosition: context.treePosition || 'fit',\r\n        source: context.source || 'system',\r\n        selectedLabel: context.selectedLabel,\r\n        mainId: resolvedMainId\r\n      })\r\n    })\r\n    .catch(error => {\r\n      console.error('Erreur lors du chargement complet de l\\'arbre', error)\r\n      setStatus(`Erreur: ${(error && error.message) || 'chargement impossible'}`, 'error')\r\n    })\r\n    .finally(() => {\r\n      setInterfaceLoading(false)\r\n    })\r\n}\r\n\r\nfunction applySubtreePayload(payload, context = {}) {\r\n  const { data, config, meta } = normaliseTreePayload(payload)\r\n  const persons = Array.isArray(data) ? data : []\r\n  const metaInfo = normaliseMeta(meta, persons.length)\r\n  latestMeta = metaInfo\r\n  totalPersons = metaInfo.total\r\n\r\n  const requestedParams = context.params || {}\r\n  const resolvedMainId = requestedParams.mainId\r\n    || (typeof config?.mainId === 'string' ? config.mainId : null)\r\n    || (persons[0]?.id ?? serverQueryState.mainId ?? null)\r\n\r\n  serverQueryState = {\r\n    ...serverQueryState,\r\n    mainId: resolvedMainId,\r\n    ancestryDepth: requestedParams.ancestryDepth ?? serverQueryState.ancestryDepth,\r\n    progenyDepth: requestedParams.progenyDepth ?? serverQueryState.progenyDepth,\r\n    includeSiblings: requestedParams.includeSiblings ?? serverQueryState.includeSiblings,\r\n    includeSpouses: requestedParams.includeSpouses ?? serverQueryState.includeSpouses\r\n  }\r\n\r\n  const selectedLabel = context.selectedLabel || resolveLabelFromSummary(resolvedMainId)\r\n  const treePosition = context.treePosition !== undefined\r\n    ? context.treePosition\r\n    : (context.reposition === false\r\n      ? 'inherit'\r\n      : (context.source === 'search' ? 'main_to_middle' : 'inherit'))\r\n  renderChart({ data: persons, config, meta: metaInfo }, {\r\n    preservePreferences: context.preservePreferences !== false,\r\n    treePosition,\r\n    source: context.source || lastSelectionContext.source,\r\n    selectedLabel,\r\n    mainId: resolvedMainId\r\n  })\r\n}\r\n\r\nfunction resetDetails() {\r\n  if (!detailsPanel || !emptyState || !detailsList || !detailsSummary) return\r\n  detailsSummary.textContent = ''\r\n  detailsSummary.classList.add('hidden')\r\n  emptyState.textContent = 'S\u00E9lectionnez une personne pour afficher les informations.'\r\n  emptyState.classList.remove('hidden')\r\n  detailsList.innerHTML = ''\r\n  updateDatasetMeta()\r\n}\r\n\r\nfunction buildFullName(person = {}) {\r\n  const nameParts = [person['first name'], person['last name']].filter(Boolean)\r\n  return nameParts.join(' ').trim()\r\n}\r\n\r\nfunction hasContent(value) {\r\n  if (value === null || value === undefined) return false\r\n  if (typeof value === 'string') return value.trim().length > 0\r\n  if (Array.isArray(value)) return value.length > 0\r\n  if (typeof value === 'object') return Object.keys(value).length > 0\r\n  return true\r\n}\r\n\r\nfunction buildDetailEntries(person = {}) {\r\n  const normalizedPerson = person || {}\r\n\r\n  // Helper to find a person's field value ignoring key case/formatting.\r\n  function findValueForKey(rawKey) {\r\n    const desired = normalizeFieldKey(rawKey)\r\n    const desiredCanonical = canonicalFieldKey(rawKey)\r\n    // direct match first\r\n    if (Object.prototype.hasOwnProperty.call(normalizedPerson, rawKey)) {\r\n      return normalizedPerson[rawKey]\r\n    }\r\n    // try normalized keys (case-insensitive)\r\n    for (const k of Object.keys(normalizedPerson)) {\r\n      if (normalizeFieldKey(k) === desired) return normalizedPerson[k]\r\n    }\r\n    // try canonical keys (ignore spaces/underscores)\r\n    for (const k of Object.keys(normalizedPerson)) {\r\n      if (canonicalFieldKey(k) === desiredCanonical) return normalizedPerson[k]\r\n    }\r\n    return undefined\r\n  }\r\n\r\n  // Build entries for the ordered (mandatory) fields, resolving values case-insensitively\r\n  const entries = DETAIL_FIELD_ORDER.map(field => ({\r\n    field,\r\n    value: findValueForKey(field),\r\n    mandatory: true\r\n  }))\r\n\r\n  // Track normalized keys already included so we don't duplicate when iterating remaining fields\r\n  const seen = new Set(DETAIL_FIELD_ORDER.map(canonicalFieldKey))\r\n\r\n  Object.entries(normalizedPerson).forEach(([field, value]) => {\r\n    if (isUnionReferenceKey(field)) return\r\n    const key = canonicalFieldKey(field)\r\n    // Skip hidden fields entirely\r\n    if (HIDDEN_FIELD_KEYS.has(key)) return\r\n    if (seen.has(key)) return\r\n    if (!hasContent(value)) return\r\n    seen.add(key)\r\n    entries.push({ field, value, mandatory: false })\r\n  })\r\n\r\n  return entries\r\n}\r\n\r\nfunction isUnionReferenceKey(field) {\r\n  if (typeof field !== 'string') return false\r\n  return field.startsWith('union date__ref__') || field.startsWith('union place__ref__')\r\n}\r\n\r\nfunction collectSpouseUnionDetails(datum) {\r\n  if (!datum || !datum.data) return []\r\n  const personData = datum.data || {}\r\n  const candidateIds = new Set()\r\n\r\n  const spouseIds = Array.isArray(datum.rels?.spouses) ? datum.rels.spouses : []\r\n  spouseIds.forEach(id => {\r\n    if (id) candidateIds.add(id)\r\n  })\r\n\r\n  Object.keys(personData).forEach(key => {\r\n    if (!isUnionReferenceKey(key)) return\r\n    const [, refId] = key.split('__ref__')\r\n    if (refId) candidateIds.add(refId)\r\n  })\r\n\r\n  const details = []\r\n  candidateIds.forEach(id => {\r\n    if (!id) return\r\n    const unionDate = safeTrim(personData[`union date__ref__${id}`])\r\n    const unionPlace = safeTrim(personData[`union place__ref__${id}`])\r\n    const storeDatum = chartInstance?.store?.getDatum?.(id)\r\n    const hasUnionInfo = Boolean(unionDate || unionPlace)\r\n    if (!storeDatum && !hasUnionInfo) {\r\n      return\r\n    }\r\n    const name = storeDatum ? buildDatasetLabel(storeDatum) : `Profil ${id}`\r\n    details.push({\r\n      id,\r\n      name,\r\n      unionDate,\r\n      unionPlace\r\n    })\r\n  })\r\n\r\n  return details\r\n}\r\n\r\nfunction renderUnionDetails(datum) {\r\n  if (!detailsList) return 0\r\n  const unions = collectSpouseUnionDetails(datum)\r\n  if (!unions.length) return 0\r\n\r\n  const item = document.createElement('article')\r\n  item.className = 'detail-item detail-unions'\r\n\r\n  const labelEl = document.createElement('span')\r\n  labelEl.className = 'detail-label'\r\n  labelEl.textContent = unions.length > 1 ? 'Unions' : 'Union'\r\n  item.append(labelEl)\r\n\r\n  const valueEl = document.createElement('div')\r\n  valueEl.className = 'detail-value union-list'\r\n\r\n  unions.forEach(detail => {\r\n    const entryEl = document.createElement('div')\r\n    entryEl.className = 'union-entry'\r\n\r\n    const nameEl = document.createElement('p')\r\n    nameEl.className = 'union-name'\r\n    nameEl.textContent = detail.name\r\n    entryEl.append(nameEl)\r\n\r\n    entryEl.append(createUnionRow(\"Date d'union\", detail.unionDate))\r\n    entryEl.append(createUnionRow(\"Lieu d'union\", detail.unionPlace))\r\n\r\n    valueEl.append(entryEl)\r\n  })\r\n\r\n  item.append(valueEl)\r\n  detailsList.append(item)\r\n  return unions.length\r\n}\r\n\r\nfunction createUnionRow(label, value) {\r\n  const row = document.createElement('p')\r\n  row.className = 'union-row'\r\n\r\n  const labelSpan = document.createElement('span')\r\n  labelSpan.className = 'union-row-label'\r\n  labelSpan.textContent = `${label} :`\r\n\r\n  const valueSpan = document.createElement('span')\r\n  valueSpan.className = 'union-row-value'\r\n  if (!value) {\r\n    valueSpan.classList.add('empty')\r\n    valueSpan.textContent = DEFAULT_EMPTY_LABEL\r\n  } else {\r\n    valueSpan.textContent = value\r\n  }\r\n\r\n  row.append(labelSpan, valueSpan)\r\n  return row\r\n}\r\n\r\nfunction formatFieldLabel(rawField) {\r\n  if (!rawField) return ''\r\n  const field = rawField.toLowerCase()\r\n  if (FIELD_LABELS[field]) return FIELD_LABELS[field]\r\n  return field.replace(/\\b\\w/g, char => char.toUpperCase())\r\n}\r\n\r\nfunction formatArrayValue(value) {\r\n  return value\r\n    .map(item => {\r\n      if (typeof item === 'string') return item.trim()\r\n      if (typeof item === 'object' && item !== null) return JSON.stringify(item)\r\n      return String(item)\r\n    })\r\n    .filter(Boolean)\r\n    .join(', ')\r\n}\r\n\r\nfunction resolveFieldDisplay(field, rawValue) {\r\n  if (rawValue === undefined) {\r\n    return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n  }\r\n\r\n  if (field === 'avatar') {\r\n    const url = (rawValue || '').toString().trim()\r\n    if (!url) return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n    return { type: 'avatar', url }\r\n  }\r\n\r\n  if (field === 'gender' && typeof rawValue === 'string') {\r\n    const transformed = GENDER_LABELS[rawValue.toUpperCase()] || rawValue\r\n    return { text: transformed }\r\n  }\r\n\r\n  if (rawValue === null) {\r\n    return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n  }\r\n\r\n  if (Array.isArray(rawValue)) {\r\n    if (!rawValue.length) return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n    return { text: formatArrayValue(rawValue) }\r\n  }\r\n\r\n  if (typeof rawValue === 'object') {\r\n    const json = JSON.stringify(rawValue, null, 2)\r\n    if (!json) return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n    return { text: json, pre: true }\r\n  }\r\n\r\n  const value = String(rawValue).trim()\r\n  if (!value) return { text: DEFAULT_EMPTY_LABEL, empty: true }\r\n\r\n  const isLongText = value.includes('\\n') || value.length > 80\r\n  return { text: value, pre: isLongText }\r\n}\r\n\r\nfunction createDetailItem(field, display) {\r\n  if (!detailsList) return\r\n  const item = document.createElement('article')\r\n  item.className = 'detail-item'\r\n\r\n  const labelEl = document.createElement('span')\r\n  labelEl.className = 'detail-label'\r\n  labelEl.textContent = formatFieldLabel(field)\r\n  item.append(labelEl)\r\n\r\n  if (display.type === 'avatar') {\r\n    const valueEl = document.createElement('div')\r\n    valueEl.className = 'avatar-preview'\r\n\r\n    const img = document.createElement('img')\r\n    img.src = display.url\r\n    img.alt = `Avatar de ${detailsSummary?.textContent || 'la personne s\u00E9lectionn\u00E9e'}`\r\n    img.loading = 'lazy'\r\n\r\n    const link = document.createElement('a')\r\n    link.href = display.url\r\n    link.target = '_blank'\r\n    link.rel = 'noopener'\r\n    link.textContent = 'Ouvrir l\u2019image'\r\n\r\n    valueEl.append(img, link)\r\n    item.append(valueEl)\r\n    detailsList.append(item)\r\n    return\r\n  }\r\n\r\n  const valueEl = document.createElement('div')\r\n  valueEl.className = 'detail-value'\r\n  if (display.pre) valueEl.classList.add('preformatted')\r\n  if (display.empty) valueEl.classList.add('empty')\r\n  valueEl.textContent = display.text\r\n  item.append(valueEl)\r\n  detailsList.append(item)\r\n}\r\n\r\nfunction showDetailsForDatum(datum) {\r\n  if (!detailsPanel || !detailsList || !emptyState || !detailsSummary) return\r\n  const person = datum?.data || {}\r\n\r\n  detailsList.innerHTML = ''\r\n\r\n  const fullName = buildFullName(person)\r\n  const highlight = []\r\n  if (person['birthday']) highlight.push(`N\u00E9(e) : ${person['birthday']}`)\r\n  if (person['death']) highlight.push(`D\u00E9c\u00E8s : ${person['death']}`)\r\n\r\n  if (fullName) {\r\n    detailsSummary.textContent = highlight.length ? `${fullName} \u00B7 ${highlight.join(' \u00B7 ')}` : fullName\r\n    detailsSummary.classList.remove('hidden')\r\n  } else if (highlight.length) {\r\n    detailsSummary.textContent = highlight.join(' \u00B7 ')\r\n    detailsSummary.classList.remove('hidden')\r\n  } else {\r\n    detailsSummary.textContent = ''\r\n    detailsSummary.classList.add('hidden')\r\n  }\r\n\r\n  const entries = buildDetailEntries(person)\r\n  let rendered = 0\r\n  entries.forEach(entry => {\r\n    const display = resolveFieldDisplay(entry.field, entry.value)\r\n    if (display.empty) return\r\n    createDetailItem(entry.field, display)\r\n    rendered += 1\r\n  })\r\n\r\n  rendered += renderUnionDetails(datum)\r\n\r\n  if (rendered === 0) {\r\n    emptyState.textContent = 'Aucune information suppl\u00E9mentaire disponible.'\r\n    emptyState.classList.remove('hidden')\r\n  } else {\r\n    emptyState.classList.add('hidden')\r\n  }\r\n\r\n}\r\n\r\nfunction handlePersonSelection(datum, source = 'card') {\r\n  if (!datum) return\r\n\r\n  const name = buildFullName(datum.data || {}) || `Profil ${datum.id}`\r\n  showDetailsForDatum(datum)\r\n\r\n  if (chartInstance) {\r\n    chartInstance.updateMainId(datum.id)\r\n    applyViewerConfig({ treePosition: 'inherit', initial: false })\r\n  }\r\n\r\n  const prefixLabel = source === 'search' ? 'Resultat' : 'Selection'\r\n  setStatus(`${prefixLabel} : ${name}`, 'info')\r\n\r\n  if (source === 'search') {\r\n    const input = searchContainer?.querySelector('input')\r\n    if (input) {\r\n      input.value = ''\r\n      input.blur()\r\n    }\r\n  }\r\n\r\n  requestSubtree({ mainId: datum.id }, {\r\n    source,\r\n    treePosition: source === 'search' ? 'main_to_middle' : 'inherit',\r\n    reposition: source === 'search',\r\n    preservePreferences: true,\r\n    selectedLabel: name,\r\n    loadingLabel: `${source === 'search' ? 'Recherche' : 'Selection'} : ${name}...`\r\n  })\r\n}\r\n\r\nfunction setupSearch(chart) {\r\n  if (!searchContainer) return\r\n\r\n  searchContainer.innerHTML = ''\r\n  const initialState = searchOptions && searchOptions.length\r\n    ? 'ready'\r\n    : (peopleSummary && peopleSummary.length === 0 ? 'empty' : 'loading')\r\n  setViewerSearchState(initialState)\r\n\r\n  chart.setPersonDropdown(datum => {\r\n    const person = datum.data || {}\r\n    const name = buildFullName(person) || 'Profil sans nom'\r\n    const extras = []\r\n    if (person['birthday']) extras.push(person['birthday'])\r\n    if (person['death']) extras.push(`\u271D ${person['death']}`)\r\n    return extras.length ? `${name} (${extras.join(' \u00B7 ')})` : name\r\n  }, {\r\n    cont: searchContainer,\r\n  placeholder: 'Rechercher (nom, date, lieu, etc.)',\r\n    onSelect: (id) => {\r\n      const selected = chart.store?.getDatum?.(id)\r\n      if (selected) {\r\n        handlePersonSelection(selected, 'search')\r\n        return\r\n      }\r\n      const fallbackLabel = resolveLabelFromSummary(id) || `Profil ${id}`\r\n      requestSubtree({ mainId: id }, {\r\n        source: 'search',\r\n        treePosition: 'main_to_middle',\r\n        reposition: true,\r\n        preservePreferences: true,\r\n        selectedLabel: fallbackLabel,\r\n        loadingLabel: `Recherche : ${fallbackLabel}...`\r\n      })\r\n    }\r\n  })\r\n\r\n  const itemsContainer = searchContainer.querySelector('.f3-autocomplete-items')\r\n  if (itemsContainer) {\r\n    const toggleItemsState = () => {\r\n      const hasChildren = itemsContainer.childElementCount > 0\r\n      itemsContainer.classList.toggle('is-empty', !hasChildren)\r\n      if (hasChildren) {\r\n        itemsContainer.tabIndex = 0\r\n      } else {\r\n        itemsContainer.removeAttribute('tabindex')\r\n      }\r\n    }\r\n\r\n    toggleItemsState()\r\n    const observer = new MutationObserver(toggleItemsState)\r\n    observer.observe(itemsContainer, { childList: true })\r\n  }\r\n\r\n  const searchInput = searchContainer.querySelector('input')\r\n  if (searchInput) {\r\n    searchInput.id = 'personSearchInput'\r\n    searchInput.setAttribute('placeholder', 'Rechercher (nom, date, lieu, etc.)')\r\n    if (searchHint && searchHint.id) {\r\n      searchInput.setAttribute('aria-describedby', searchHint.id)\r\n    }\r\n  }\r\n\r\n  updateSearchOptionsForChart(chart)\r\n  ensurePeopleSummary().then(() => {\r\n    updateSearchOptionsForChart(chart)\r\n  }).catch(() => {})\r\n}\r\n\r\nfunction renderChart(payload, options = {}) {\r\n  const container = document.querySelector(chartSelector)\r\n  if (!container) {\r\n    throw new Error('Conteneur du graphique introuvable')\r\n  }\r\n\r\n  const normalised = payload && payload.data !== undefined\r\n    ? payload\r\n    : normaliseTreePayload(payload)\r\n\r\n  const dataArray = Array.isArray(normalised.data) ? normalised.data : []\r\n  const rawConfig = normalised.config || {}\r\n  const isInitialRender = !chartInstance\r\n\r\n  if (isInitialRender) {\r\n    container.innerHTML = ''\r\n  }\r\n\r\n  resetDetails()\r\n\r\n  if (!chartInstance) {\r\n    chartInstance = f3.createChart(chartSelector, dataArray)\r\n  } else {\r\n    chartInstance.updateData(dataArray)\r\n  }\r\n\r\n  const chart = chartInstance\r\n  const baseConfig = applyConfigToChart(chart, rawConfig)\r\n\r\n  const mergedConfig = {\r\n    ...baseConfig,\r\n    mainId: options.mainId || baseConfig.mainId || viewerConfig.mainId || null,\r\n    ancestryDepth: serverQueryState.ancestryDepth,\r\n    progenyDepth: serverQueryState.progenyDepth,\r\n  // duplicateBranchToggle option removed; rely on chart defaults\r\n    miniTree: options.preservePreferences && viewerConfig ? viewerConfig.miniTree !== false : baseConfig.miniTree !== false,\r\n    cardDisplay: baseConfig.cardDisplay && baseConfig.cardDisplay.length\r\n      ? baseConfig.cardDisplay.map(row => [...row])\r\n      : DEFAULT_CARD_DISPLAY.map(row => [...row])\r\n  }\r\n\r\n  if (options.preservePreferences && viewerConfig) {\r\n    mergedConfig.cardDisplay = viewerConfig.cardDisplay && viewerConfig.cardDisplay.length\r\n      ? viewerConfig.cardDisplay.map(row => [...row])\r\n      : mergedConfig.cardDisplay\r\n    mergedConfig.transitionTime = viewerConfig.transitionTime ?? mergedConfig.transitionTime\r\n    mergedConfig.cardXSpacing = viewerConfig.cardXSpacing ?? mergedConfig.cardXSpacing\r\n    mergedConfig.cardYSpacing = viewerConfig.cardYSpacing ?? mergedConfig.cardYSpacing\r\n    mergedConfig.singleParentEmptyCard = viewerConfig.singleParentEmptyCard ?? mergedConfig.singleParentEmptyCard\r\n    mergedConfig.singleParentEmptyCardLabel = viewerConfig.singleParentEmptyCardLabel ?? mergedConfig.singleParentEmptyCardLabel\r\n    mergedConfig.orientation = viewerConfig.orientation ?? mergedConfig.orientation\r\n  }\r\n\r\n  viewerConfig = { ...mergedConfig }\r\n  viewerConfig.mainId = mergedConfig.mainId\r\n\r\n  const cardDisplayConfig = viewerConfig.cardDisplay && viewerConfig.cardDisplay.length\r\n    ? viewerConfig.cardDisplay.map(row => [...row])\r\n    : DEFAULT_CARD_DISPLAY.map(row => [...row])\r\n\r\n  if (!cardInstance) {\r\n    cardInstance = chart.setCardHtml()\r\n  }\r\n\r\n  if (typeof cardInstance.setCardDisplay === 'function') {\r\n    cardInstance.setCardDisplay(cardDisplayConfig)\r\n  }\r\n  if (typeof cardInstance.setMiniTree === 'function') {\r\n    cardInstance.setMiniTree(viewerConfig.miniTree !== false)\r\n  }\r\n\r\n  if (typeof cardInstance.setOnCardClick === 'function') {\r\n    cardInstance.setOnCardClick((event, treeDatum) => {\r\n      const id = treeDatum?.data?.id\r\n      if (!id) return\r\n      const datum = chart.store?.getDatum?.(id)\r\n      if (datum) {\r\n        handlePersonSelection(datum, 'card')\r\n      } else {\r\n        const fallbackLabel = resolveLabelFromSummary(id) || `Profil ${id}`\r\n        requestSubtree({ mainId: id }, {\r\n          source: 'card',\r\n          treePosition: 'inherit',\r\n          reposition: false,\r\n          preservePreferences: true,\r\n          selectedLabel: fallbackLabel,\r\n          loadingLabel: `Selection : ${fallbackLabel}...`\r\n        })\r\n      }\r\n    })\r\n  }\r\n\r\n  if (typeof cardInstance.setOnMiniTreeClick === 'function') {\r\n    cardInstance.setOnMiniTreeClick((event, treeDatum) => {\r\n      const id = treeDatum?.data?.id\r\n      if (!id) return\r\n      const datum = chart.store?.getDatum?.(id)\r\n      if (datum) {\r\n        handlePersonSelection(datum, 'card')\r\n      } else {\r\n        const fallbackLabel = resolveLabelFromSummary(id) || `Profil ${id}`\r\n        requestSubtree({ mainId: id }, {\r\n          source: 'card',\r\n          treePosition: 'inherit',\r\n          reposition: false,\r\n          preservePreferences: true,\r\n          selectedLabel: fallbackLabel,\r\n          loadingLabel: `Selection : ${fallbackLabel}...`\r\n        })\r\n      }\r\n    })\r\n  }\r\n\r\n  // duplicate branch merging option removed; chart will use internal defaults\r\n\r\n  isApplyingViewerConfig = true\r\n  updatePerformanceControlsUI(viewerConfig)\r\n  isApplyingViewerConfig = false\r\n\r\n  if (viewerConfig.mainId) {\r\n    chart.updateMainId(viewerConfig.mainId)\r\n  }\r\n\r\n  rebuildLocalSearchOptions(chart)\r\n\r\n  if (isInitialRender) {\r\n    setupSearch(chart)\r\n  } else {\r\n    updateSearchOptionsForChart(chart)\r\n  }\r\n\r\n  const initialUpdate = options.preservePreferences === false\r\n  const requestedTreePosition = options.treePosition\r\n  const defaultTreePosition = requestedTreePosition\r\n    || (options.source === 'search'\r\n      ? 'main_to_middle'\r\n      : (isInitialRender ? 'fit' : 'inherit'))\r\n\r\n  applyViewerConfig({ treePosition: defaultTreePosition, initial: initialUpdate })\r\n\r\n  const mainDatum = chart.getMainDatum?.()\r\n  const effectiveMainId = chart.store?.getMainId?.() || viewerConfig.mainId\r\n  if (effectiveMainId && effectiveMainId !== viewerConfig.mainId) {\r\n    viewerConfig.mainId = effectiveMainId\r\n  }\r\n  if (effectiveMainId) {\r\n    serverQueryState.mainId = effectiveMainId\r\n    if (lastSuccessfulQuery) {\r\n      lastSuccessfulQuery = { ...lastSuccessfulQuery, mainId: effectiveMainId }\r\n    }\r\n  }\r\n  if (mainDatum) {\r\n    showDetailsForDatum(mainDatum)\r\n  }\r\n\r\n  updateDatasetMeta()\r\n\r\n  const branchCount = Number.isFinite(latestMeta.returned) ? latestMeta.returned : dataArray.length\r\n  const totalCount = Number.isFinite(latestMeta.total) ? latestMeta.total : dataArray.length\r\n  const name = mainDatum\r\n    ? (buildFullName(mainDatum.data || {}) || `Profil ${mainDatum.id}`)\r\n    : (options.selectedLabel || 'Branche courante')\r\n  const prefix = options.source === 'search'\r\n    ? 'R\u00E9sultat'\r\n    : options.source === 'card'\r\n      ? 'S\u00E9lection'\r\n      : 'Branche'\r\n  const branchLabel = branchCount === 1 ? 'profil' : 'profils'\r\n  const totalLabel = totalCount === 1 ? 'profil' : 'profils'\r\n  // Affiche les informations principales sans mentionner les profondeurs (souvent inexactes)\r\n  setStatus(`${prefix} : ${name} \u2014 ${branchCount} ${branchLabel} dans la branche / ${totalCount} ${totalLabel} au total`, 'success')\r\n\r\n  lastSelectionContext = { source: options.source || prefix.toLowerCase(), label: name }\r\n\r\n  ensurePeopleSummary().then(() => {\r\n    updateSearchOptionsForChart(chart)\r\n  }).catch(() => {})\r\n}\r\n\r\nfetchFullTree({ preservePreferences: false, source: 'system' }).catch(() => {\r\n  setStatus('Impossible de charger les donn\u00E9es', 'error')\r\n})\r\n"],
  "mappings": "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",
  "names": ["f3", "statusEl", "detailsPanel", "searchContainer", "searchHint", "searchRoot", "searchEmptyEl", "detailsList", "detailsSummary", "emptyState", "chartSelector", "ancestryDepthControl", "progenyDepthControl", "miniTreeToggle", "datasetMeta", "visibleCountEl", "branchCountEl", "totalCountEl", "normalizeFieldKey", "value", "canonicalFieldKey", "sanitizeFieldValues", "values", "seen", "result", "rawValue", "trimmed", "key", "safeTrim", "buildDatasetLabel", "datum", "person", "first", "last", "base", "birth", "createDatasetSearchOption", "label", "tokens", "metaParts", "metaSeen", "addToken", "addMeta", "data", "rawKey", "searchText", "option", "meta", "buildSearchOptionsFromDataset", "persons", "options", "a", "b", "setViewerSearchState", "state", "DETAIL_FIELD_ORDER", "HIDDEN_FIELD_KEYS", "FIELD_LABELS", "GENDER_LABELS", "DEFAULT_EMPTY_LABEL", "DEFAULT_CARD_DISPLAY", "DEFAULT_CHART_CONFIG", "row", "PROGRESSIVE_DEPTH_STEP", "PROGRESSIVE_MAX_STEPS", "chartInstance", "cardInstance", "viewerConfig", "totalPersons", "isApplyingViewerConfig", "serverQueryState", "lastSuccessfulQuery", "latestMeta", "activeFetchController", "searchSummaryPromise", "peopleSummary", "summarySearchOptions", "localSearchOptions", "searchOptions", "lastSelectionContext", "peopleSummaryIndex", "pendingMetaFrame", "lastMetaSnapshot", "lastStatusSnapshot", "normalizeCardDisplay", "rows", "normalized", "normaliseTreePayload", "payload", "candidateConfig", "normaliseChartConfig", "rawConfig", "_a", "_b", "_c", "_d", "_e", "_f", "_g", "_h", "_i", "_j", "_k", "_l", "_m", "_n", "_o", "_p", "_q", "_r", "_s", "_t", "_u", "_v", "_w", "_x", "_y", "_z", "_A", "_B", "_C", "config", "transition", "cardX", "cardY", "orientation", "showSiblings", "singleParentEnabled", "emptyLabel", "rawCardDisplay", "source", "rawMainId", "rawAncestryDepth", "rawProgenyDepth", "rawMiniTree", "applyConfigToChart", "chart", "overrides", "cardDisplayOverride", "serialiseDepthParam", "buildSubtreeQuery", "params", "query", "ancestryDepth", "progenyDepth", "setInterfaceLoading", "isLoading", "loading", "abortActiveFetch", "normaliseMeta", "fallbackTotal", "fallbackReturned", "payloadMeta", "total", "returned", "hasQueryChanged", "nextParams", "previous", "next", "buildSearchOption", "registerField", "rkey", "fragment", "fieldKey", "fieldValue", "normalisedTokens", "title", "buildSearchOptionsFromSummary", "summary", "combineSearchOptions", "merged", "mergeEntry", "existing", "mergedSearchText", "mergeSearchText", "second", "segments", "add", "part", "updateSearchOptionsForChart", "rebuildLocalSearchOptions", "error", "setSearchLoadingState", "ensurePeopleSummary", "force", "controller", "promise", "response", "setStatus", "message", "type", "depthToSelectValue", "fallback", "parseDepthSelectValue", "select", "raw", "updatePerformanceControlsUI", "updateDatasetMeta", "cb", "visible", "branchCount", "applyViewerConfig", "treePosition", "initial", "nextPosition", "attachPerformanceHandlers", "requestSubtree", "enabled", "resolveLabelFromSummary", "id", "entry", "requestSubtree", "partialParams", "context", "nextParams", "serverQueryState", "hasQueryChanged", "lastSelectionContext", "resolveLabelFromSummary", "loadingLabel", "setStatus", "setInterfaceLoading", "controller", "abortActiveFetch", "activeFetchController", "wantsAutoAncestry", "wantsAutoProgeny", "shouldProgressiveLoad", "progressiveSubtreeRequest", "fetchSubtreeOnce", "initialParams", "_a", "_b", "_c", "_d", "_e", "_f", "_g", "_h", "_i", "_j", "_k", "_l", "stepInput", "PROGRESSIVE_DEPTH_STEP", "stepSize", "currentParams", "fallback", "DEFAULT_CHART_CONFIG", "originalSnapshot", "iterations", "previousCount", "chartInstance", "encounteredError", "PROGRESSIVE_MAX_STEPS", "summaryParts", "firstBatch", "batchTreePosition", "result", "meta", "currentCount", "gained", "lastSuccessfulQuery", "viewerConfig", "isApplyingViewerConfig", "updatePerformanceControlsUI", "params", "queryString", "buildSubtreeQuery", "response", "payload", "normalised", "normaliseTreePayload", "persons", "metaInfo", "normaliseMeta", "fetchFullTree", "applySubtreePayload", "error", "latestMeta", "totalPersons", "resolvedMainId", "renderChart", "data", "config", "requestedParams", "selectedLabel", "treePosition", "resetDetails", "detailsPanel", "emptyState", "detailsList", "detailsSummary", "updateDatasetMeta", "buildFullName", "person", "hasContent", "value", "buildDetailEntries", "normalizedPerson", "findValueForKey", "rawKey", "desired", "normalizeFieldKey", "desiredCanonical", "canonicalFieldKey", "k", "entries", "DETAIL_FIELD_ORDER", "field", "seen", "isUnionReferenceKey", "key", "HIDDEN_FIELD_KEYS", "collectSpouseUnionDetails", "datum", "personData", "candidateIds", "id", "refId", "details", "unionDate", "safeTrim", "unionPlace", "storeDatum", "name", "buildDatasetLabel", "renderUnionDetails", "unions", "item", "labelEl", "valueEl", "detail", "entryEl", "nameEl", "createUnionRow", "label", "row", "labelSpan", "valueSpan", "DEFAULT_EMPTY_LABEL", "formatFieldLabel", "rawField", "FIELD_LABELS", "char", "formatArrayValue", "resolveFieldDisplay", "rawValue", "url", "GENDER_LABELS", "json", "isLongText", "createDetailItem", "display", "img", "link", "showDetailsForDatum", "fullName", "highlight", "rendered", "entry", "handlePersonSelection", "source", "applyViewerConfig", "input", "searchContainer", "setupSearch", "chart", "initialState", "searchOptions", "peopleSummary", "setViewerSearchState", "extras", "selected", "fallbackLabel", "itemsContainer", "toggleItemsState", "hasChildren", "searchInput", "searchHint", "updateSearchOptionsForChart", "ensurePeopleSummary", "options", "container", "chartSelector", "dataArray", "rawConfig", "isInitialRender", "baseConfig", "applyConfigToChart", "mergedConfig", "DEFAULT_CARD_DISPLAY", "cardDisplayConfig", "cardInstance", "event", "treeDatum", "rebuildLocalSearchOptions", "initialUpdate", "defaultTreePosition", "mainDatum", "effectiveMainId", "branchCount", "totalCount", "prefix"]
}
