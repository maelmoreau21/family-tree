import*as lt from"/lib/family-tree.esm.js";var Re=document.getElementById("status"),ze=document.getElementById("save"),Be=document.getElementById("reload"),D=document.getElementById("controlPanel"),st="#FamilyChart";function k(t){return t==null?"":String(t).trim().toLowerCase()}function te(t){if(!Array.isArray(t))return[];let o=new Set,c=[];return t.forEach(u=>{if(typeof u!="string")return;let L=u.trim();if(!L)return;let T=k(L);o.has(T)||(o.add(T),c.push(L))}),c}var Rt=new Map([["first name","Pr\xE9nom"],["last name","Nom"],["birthday","Date de naissance"],["death","Date de D\xE9c\xE8s"],["gender","Genre"],["avatar","Photo de profil"],["photo","Photo"],["picture","Portrait"],["bio","Biographie"],["occupation","Profession"],["location","Lieu de r\xE9sidence"],["birthplace","Lieu de naissance"],["deathplace","Lieu de d\xE9c\xE8s"],["notes","Notes"],["nickname","Surnom"],["maiden name","Nom de jeune fille"]]),ct={1:[{value:"first name",checked:!0},{value:"last name",checked:!0},{value:"birthday",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}],2:[{value:"birthday",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}]},Te=[{value:"first name",label:"Pr\xE9nom",checked:!0},{value:"last name",label:"Nom",checked:!0},{value:"birthday",label:"Date de naissance",checked:!0},{value:"avatar",label:"Avatar",checked:!0},{value:"gender",label:"Genre",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!1},{value:"bio",label:"Biographie",checked:!1}],Le=[["first name","last name"],["birthday"]],pe=te(Te.filter(t=>t.checked!==!1).map(t=>t.value)),ut=new Set(["bio","notes","biographie","description"]);function Ye(){let t=new Map(Rt);return Te.forEach(o=>{t.set(k(o.value),o.label)}),Object.values(ct).forEach(o=>{o.forEach(c=>{c.label&&t.set(k(c.value),c.label)})}),t}function zt(t,o=Ye()){let c=o||Ye();return te(t).map(u=>{let L=k(u),T=c.get(L)||u,E=ut.has(L)?"textarea":"text";return{id:u,label:T,type:E}})}var I=Object.freeze({transitionTime:200,cardXSpacing:240,cardYSpacing:140,orientation:"vertical",showSiblingsOfMain:!0,singleParentEmptyCard:!0,singleParentEmptyCardLabel:"Inconnu",ancestryDepth:4,progenyDepth:4,miniTree:!0,duplicateBranchToggle:!0,editableFields:[...pe],cardDisplay:Le.map(t=>[...t]),mainId:null});function Bt(t){let c=(Array.isArray(t)?t:[]).slice(0,2).map(u=>te(Array.isArray(u)?u:[]));for(;c.length<2;)c.push([]);return c}function Ce(t,o=Le){var L,T,E,N,G,y,O,M,q,x,w,z,v,F;let c=t;return t&&!Array.isArray(t)&&typeof t=="object"&&(c=[(O=(y=(G=(N=(E=(T=(L=t[0])!=null?L:t[0])!=null?T:t.row1)!=null?E:t.row_1)!=null?N:t.ligne1)!=null?G:t.line1)!=null?y:t.first)!=null?O:[],(F=(v=(z=(w=(x=(q=(M=t[1])!=null?M:t[1])!=null?q:t.row2)!=null?x:t.row_2)!=null?w:t.ligne2)!=null?z:t.line2)!=null?v:t.second)!=null?F:[]]),Array.isArray(c)?Bt(c).map((P,X)=>{if(P.length)return[...P];let R=o[X];return Array.isArray(R)?[...R]:[]}):o.map(P=>[...P])}function dt(t={}){let o={transitionTime:I.transitionTime,cardXSpacing:I.cardXSpacing,cardYSpacing:I.cardYSpacing,orientation:I.orientation,showSiblingsOfMain:I.showSiblingsOfMain,singleParentEmptyCard:I.singleParentEmptyCard,singleParentEmptyCardLabel:I.singleParentEmptyCardLabel,ancestryDepth:I.ancestryDepth,progenyDepth:I.progenyDepth,miniTree:I.miniTree,duplicateBranchToggle:I.duplicateBranchToggle,editableFields:[...pe],cardDisplay:Ce(Le),mainId:I.mainId};if(typeof t.transitionTime=="number"&&Number.isFinite(t.transitionTime)&&(o.transitionTime=t.transitionTime),typeof t.cardXSpacing=="number"&&Number.isFinite(t.cardXSpacing)&&(o.cardXSpacing=t.cardXSpacing),typeof t.cardYSpacing=="number"&&Number.isFinite(t.cardYSpacing)&&(o.cardYSpacing=t.cardYSpacing),(t.orientation==="horizontal"||t.orientation==="vertical")&&(o.orientation=t.orientation),typeof t.showSiblingsOfMain=="boolean"&&(o.showSiblingsOfMain=t.showSiblingsOfMain),typeof t.singleParentEmptyCard=="boolean"&&(o.singleParentEmptyCard=t.singleParentEmptyCard),typeof t.singleParentEmptyCardLabel=="string"){let c=t.singleParentEmptyCardLabel.trim();c&&(o.singleParentEmptyCardLabel=c)}if(t.ancestryDepth===null?o.ancestryDepth=null:typeof t.ancestryDepth=="number"&&Number.isFinite(t.ancestryDepth)&&t.ancestryDepth>=0&&(o.ancestryDepth=Math.floor(t.ancestryDepth)),t.progenyDepth===null?o.progenyDepth=null:typeof t.progenyDepth=="number"&&Number.isFinite(t.progenyDepth)&&t.progenyDepth>=0&&(o.progenyDepth=Math.floor(t.progenyDepth)),typeof t.miniTree=="boolean"&&(o.miniTree=t.miniTree),typeof t.duplicateBranchToggle=="boolean"&&(o.duplicateBranchToggle=t.duplicateBranchToggle),Array.isArray(t.editableFields)){let c=te(t.editableFields);c.length&&(o.editableFields=c)}if((Array.isArray(t.cardDisplay)||t.cardDisplay&&typeof t.cardDisplay=="object")&&(o.cardDisplay=Ce(t.cardDisplay,[[],[]])),typeof t.mainId=="string"){let c=t.mainId.trim();c&&(o.mainId=c)}return o}var S=null,Ie=null,J=null,$e=!1,ke=null,a=dt(),C=!1,se=[...pe],be=null;function Y(t,o="info"){Re&&(Re.textContent=t,Re.dataset.status=o)}function $t(t){if(Array.isArray(t))return{data:t,config:{}};if(t&&typeof t=="object"){if(Array.isArray(t.data)){let o=t.config||t.settings||t.meta||{};return{data:t.data,config:o}}if(Array.isArray(t.tree)){let o=t.config||t.settings||t.meta||{};return{data:t.tree,config:o}}}return{data:[],config:{}}}function Yt(t={}){var v,F,P,X,R,V,H,K,le,ce,ue,Z,b,oe,d,de,ne,U,W;if(!t||typeof t!="object")return{};let o={},c=(v=t.transitionTime)!=null?v:t.transition_time;typeof c=="number"&&Number.isFinite(c)&&(o.transitionTime=c);let u=(P=(F=t.cardXSpacing)!=null?F:t.card_x_spacing)!=null?P:t.node_separation;typeof u=="number"&&Number.isFinite(u)&&(o.cardXSpacing=u);let L=(R=(X=t.cardYSpacing)!=null?X:t.card_y_spacing)!=null?R:t.level_separation;typeof L=="number"&&Number.isFinite(L)&&(o.cardYSpacing=L);let T=t.orientation;T==="horizontal"||T==="vertical"?o.orientation=T:typeof t.is_horizontal=="boolean"&&(o.orientation=t.is_horizontal?"horizontal":"vertical");let E=(V=t.showSiblingsOfMain)!=null?V:t.show_siblings_of_main;typeof E=="boolean"&&(o.showSiblingsOfMain=E);let N=(H=t.singleParentEmptyCard)!=null?H:t.single_parent_empty_card;typeof N=="boolean"&&(o.singleParentEmptyCard=N);let G=(K=t.singleParentEmptyCardLabel)!=null?K:t.single_parent_empty_card_label;typeof G=="string"&&G.trim().length>0&&(o.singleParentEmptyCardLabel=G.trim());let y=(ue=(ce=(le=t.editableFields)!=null?le:t.edit_fields)!=null?ce:t.fields)!=null?ue:t.editable_fields;Array.isArray(y)&&(o.editableFields=te(y));let O=(Z=t.cardDisplay)!=null?Z:t.card_display;(Array.isArray(O)||O&&typeof O=="object")&&(o.cardDisplay=Ce(O,[[],[]]));let M=(d=(oe=(b=t.mainId)!=null?b:t.main_id)!=null?oe:t.mainPersonId)!=null?d:t.main_person_id;typeof M=="string"&&M.trim().length>0&&(o.mainId=M.trim());let q=(de=t.ancestryDepth)!=null?de:t.ancestry_depth;if(q===null)o.ancestryDepth=null;else if(q!==void 0){let B=Number(q);Number.isFinite(B)&&B>=0&&(o.ancestryDepth=Math.floor(B))}let x=(ne=t.progenyDepth)!=null?ne:t.progeny_depth;if(x===null)o.progenyDepth=null;else if(x!==void 0){let B=Number(x);Number.isFinite(B)&&B>=0&&(o.progenyDepth=Math.floor(B))}let w=(U=t.miniTree)!=null?U:t.mini_tree;typeof w=="boolean"&&(o.miniTree=w);let z=(W=t.duplicateBranchToggle)!=null?W:t.duplicate_branch_toggle;return typeof z=="boolean"&&(o.duplicateBranchToggle=z),o}function ft(t){t.setTransitionTime(a.transitionTime),t.setCardXSpacing(a.cardXSpacing),t.setCardYSpacing(a.cardYSpacing),t.setShowSiblingsOfMain(a.showSiblingsOfMain),a.orientation==="horizontal"?t.setOrientationHorizontal():t.setOrientationVertical(),t.setSingleParentEmptyCard(a.singleParentEmptyCard,{label:a.singleParentEmptyCardLabel}),typeof a.ancestryDepth=="number"&&Number.isFinite(a.ancestryDepth)?t.setAncestryDepth(a.ancestryDepth):t.setAncestryDepth(null),typeof a.progenyDepth=="number"&&Number.isFinite(a.progenyDepth)?t.setProgenyDepth(a.progenyDepth):t.setProgenyDepth(null),t.setDuplicateBranchToggle(a.duplicateBranchToggle!==!1)}async function Xt(){Y("Chargement des donn\xE9es\u2026");let t=await fetch("/api/tree",{cache:"no-store"});if(!t.ok)throw new Error(`\xC9chec du chargement (${t.status})`);return t.json()}function Xe(){Ie&&(clearTimeout(Ie),Ie=null)}async function je(t,{immediate:o=!1}={}){if(!t)return;Xe();let c=pt(t);if($e){ke={snapshot:c,immediate:o},Y("Sauvegarde d\xE9j\xE0 en cours\u2026","saving");return}try{$e=!0,Y(o?"Enregistrement en cours\u2026":"Sauvegarde automatique\u2026","saving");let u=await fetch("/api/tree",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c,null,2)});if(!u.ok&&u.status!==204)throw new Error(`Serveur a retourn\xE9 ${u.status}`);J=JSON.stringify(c),Y("Modifications enregistr\xE9es \u2705","success")}catch(u){console.error(u),Y(`Erreur d'enregistrement: ${u.message}`,"error")}finally{if($e=!1,ke){let u=ke;ke=null,await je(u.snapshot,{immediate:u.immediate})}}}function pt(t){return typeof structuredClone=="function"?structuredClone(t):JSON.parse(JSON.stringify(t))}function Fe(){if(!S)return null;let t=S.exportData();return t?{data:t,config:pt(a)}:null}function ae(){Xe(),Y("Modification d\xE9tect\xE9e\u2026 sauvegarde automatique imminente","saving"),Ie=setTimeout(()=>{let t=Fe();t&&je(t)},1500)}function jt(t){let o=document.querySelector(st);if(!o)throw new Error("Conteneur du graphique introuvable");o.innerHTML="",typeof be=="function"&&(be(),be=null);let{data:c,config:u}=$t(t);a=dt(Yt(u)),se=[...a.editableFields],se.length||(se=[...pe]);let L=[...se],T=zt(L),E=lt.createChart(st,c);ft(E);let N=a.cardDisplay&&a.cardDisplay.length?a.cardDisplay.map(v=>[...v]):Ce(Le),G=E.setCardHtml().setCardDisplay(N).setCardImageField("avatar").setMiniTree(a.miniTree!==!1),y=null,O=Array.isArray(c)?c:[];S=E.editTree().setFields(T).setEditFirst(!0).setCardClickOpen(G).setOnChange(()=>{J=null,y&&(y.refreshMainProfileOptions({keepSelection:!0}),y.syncMainProfileSelection({scheduleSaveIfChanged:!1})),ae()}),y=Gt({chart:E,card:G})||{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}},typeof y.teardown=="function"?be=y.teardown:be=null,typeof y.handleFormCreation=="function"&&S.setOnFormCreation(y.handleFormCreation);let M=z(O,E);M&&E.updateMainId(M),E.setAfterUpdate(()=>{if(!E.store||typeof E.store.getMainId!="function")return;let v=E.store.getMainId();v&&(a.mainId!==v&&(a={...a,mainId:v},J=null,C||ae()),y&&y.syncMainProfileSelection({scheduleSaveIfChanged:!1}))}),y&&(y.refreshMainProfileOptions({keepSelection:!1}),y.syncMainProfileSelection({scheduleSaveIfChanged:!1})),E.updateTree({initial:!0,tree_position:"fit"});let q=E.getMainDatum();q&&S.open(q);let x=Fe();J=x?JSON.stringify(x):null;let w=O.length;Y(w>0?`\xC9diteur pr\xEAt \u2705 \u2013 ${w} personne(s) charg\xE9e(s)`:"Fichier de donn\xE9es vide",w>0?"success":"error");function z(v,F){var H;if(!Array.isArray(v)||v.length===0)return a={...a,mainId:null},null;let P=new Set(v.map(K=>K&&K.id).filter(Boolean)),X=typeof a.mainId=="string"?a.mainId.trim():"";if(X&&P.has(X))return X;let R=F!=null&&F.store&&typeof F.store.getMainId=="function"?F.store.getMainId():null;if(R&&P.has(R))return a.mainId!==R&&(a={...a,mainId:R}),R;let V=((H=v[0])==null?void 0:H.id)||null;return V&&a.mainId!==V&&(a={...a,mainId:V}),V}}function Gt({chart:t,card:o}){if(!D)return{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}};let c=D.querySelector('[data-role="editable-fields"]'),u=c==null?void 0:c.querySelector(".editable-list"),L=c==null?void 0:c.querySelector('[data-action="add-editable"]'),T=[...D.querySelectorAll("[data-display-row]")],E=new Map(T.map(e=>[e.dataset.displayRow,e])),N=Ye(),G=new Map(Object.entries(ct).map(([e,n])=>[e,new Map(n.map(i=>[k(i.value),i.checked]))])),y=D.querySelector("#imageField"),O=D.querySelector("#cardStyle"),M=D.querySelector("#transitionInput"),q=D.querySelector("#cardYSpacing"),x=D.querySelector("#cardXSpacing"),w=D.querySelector("#emptyLabel"),z=D.querySelector("#ancestryDepth"),v=D.querySelector("#progenyDepth"),F=D.querySelector("#miniTreeToggle"),P=D.querySelector("#duplicateToggle"),X=D.querySelectorAll("[data-orientation]"),R=D.querySelector("#cardWidth"),V=D.querySelector("#cardHeight"),H=D.querySelector("#imgWidth"),K=D.querySelector("#imgHeight"),le=D.querySelector("#imgX"),ce=D.querySelector("#imgY"),ue=D.querySelector("#resetDimensions"),Z=D.querySelector('[data-role="main-profile"]'),b=Z==null?void 0:Z.querySelector("#mainProfileSelect"),oe=Z==null?void 0:Z.querySelector('[data-role="main-profile-name"]');b&&(b.disabled=!0);let d=D.querySelector('[data-role="image-uploader"]'),de=d==null?void 0:d.querySelector("#assetUpload"),ne=d==null?void 0:d.querySelector('[data-role="upload-feedback"]'),U=d==null?void 0:d.querySelector('[data-role="upload-result"]'),W=d==null?void 0:d.querySelector('[data-role="upload-url"]'),B=d==null?void 0:d.querySelector('[data-role="open-upload"]'),Pe=d==null?void 0:d.querySelector('[data-action="copy-upload-url"]'),j=d==null?void 0:d.querySelector("#assetUrl"),Ae=d==null?void 0:d.querySelector('[data-action="copy-manual-url"]'),ie=d?{parent:d.parentElement,nextSibling:d.nextSibling}:null,fe=null,Se=null;function Ge(){var n;return((n=y==null?void 0:y.value)==null?void 0:n.trim())||"avatar"}function Ue(){var e;if(!Se||!((e=S==null?void 0:S.store)!=null&&e.getDatum))return null;try{return S.store.getDatum(Se)||null}catch(n){return console.error("Impossible de r\xE9cup\xE9rer le profil actif pour le t\xE9l\xE9versement",n),null}}function Ve(e){if(!e)return"";try{return new URL(e,window.location.origin).toString()}catch{return String(e)}}function Me(e,{origin:n="manual",sizeBytes:i}={}){let r=Ve(e);if(!r)return;let s=Ge(),l=s.replace(/"/g,'\\"'),p=!1,m=!1;if(fe){let f=fe.querySelector(`[name="${l}"]`);f&&f instanceof HTMLInputElement?(f.value!==r&&(f.value=r,f.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0):f&&f instanceof HTMLTextAreaElement&&(f.value!==r&&(f.value=r,f.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0)}let h=Ue();if(h&&(h.data||(h.data={}),h.data[s]!==r&&(h.data[s]=r,m=!0)),m){try{t.updateTree({initial:!1,tree_position:"inherit"})}catch(f){console.error("Impossible de rafra\xEEchir le graphique apr\xE8s mise \xE0 jour de l\u2019image",f)}ae()}j&&(j.value=r);let g=p||m;if(n==="upload")if(g){let f=i?` (${qe(i)})`:"";_(`Image t\xE9l\xE9vers\xE9e${f} et appliqu\xE9e au profil.`,"success"),Y("Image appliqu\xE9e au profil \u2705","success")}else{let f=i?` (${qe(i)})`:"";_(`Image t\xE9l\xE9vers\xE9e${f}. S\xE9lectionnez un profil \xE9ditable pour l\u2019appliquer.`,"info")}else g?(_("Image appliqu\xE9e au profil.","success"),Y("Image appliqu\xE9e au profil \u2705","success")):_("S\xE9lectionnez un profil \xE9ditable pour appliquer l\u2019image.","info")}function Je(){var s;let e=Ge(),n=Ue(),i=((s=n==null?void 0:n.data)==null?void 0:s[e])||"";if(!i){he(),j&&(j.value=""),_("Formats recommand\xE9s : JPG, PNG, WebP.","info");return}let r=We(i,{silent:!0});j&&(j.value=r),_("Image actuelle du profil charg\xE9e.","info")}function me(){if(!d||!(ie!=null&&ie.parent))return;fe&&(fe=null),Se=null;let{parent:e,nextSibling:n}=ie;n&&e.contains(n)?e.insertBefore(d,n):e.appendChild(d),d.classList.remove("is-modal-context"),he(),j&&(j.value=""),_("Importez une image ou collez une URL publique. Formats recommand\xE9s : JPG, PNG, WebP.","info")}function ht(e){if(!d||!e||fe===e)return;me();let n=e.querySelector(".f3-form-buttons");n&&n.parentNode?n.parentNode.insertBefore(d,n):e.appendChild(d),d.classList.add("is-modal-context"),fe=e}function yt({cont:e,form_creator:n}){var s;if(!d)return;let i=(s=e==null?void 0:e.querySelector)==null?void 0:s.call(e,"form");if(!i){me();return}if(!((n==null?void 0:n.editable)!==!1&&!(n!=null&&n.no_edit))){i.contains(d)&&me();return}ht(i),Se=(n==null?void 0:n.datum_id)||null,Je()}function gt(){me()}d&&(ie!=null&&ie.parent)&&d.parentElement!==ie.parent&&me();let bt=5*1024*1024;function qe(e){return Number.isFinite(e)?e<1024?`${e} o`:e<1024*1024?`${(e/1024).toFixed(1)} Ko`:`${(e/(1024*1024)).toFixed(2)} Mo`:""}function _(e,n="info"){ne&&(ne.textContent=e,ne.dataset.status=n)}function he(){U&&(U.classList.add("hidden"),U.dataset.url="",W&&(W.textContent=""),B&&(B.href="#",B.classList.add("hidden")))}function We(e,{silent:n=!1}={}){if(!U)return"";let i=Ve(e);return U.dataset.url=i,W&&(W.textContent=i),B&&(B.href=i,B.classList.remove("hidden")),U.classList.remove("hidden"),j&&(j.value=i),n||_("Image pr\xEAte \xE0 \xEAtre appliqu\xE9e.","info"),i}async function He(e,{successMessage:n="Copi\xE9 dans le presse-papiers \u2705",errorMessage:i="Impossible de copier."}={}){var r;if(!e){_("Aucune URL \xE0 copier.","error");return}try{if((r=navigator.clipboard)!=null&&r.writeText)await navigator.clipboard.writeText(e);else{let s=document.createElement("textarea");s.value=e,s.setAttribute("readonly",""),s.style.position="absolute",s.style.left="-9999px",document.body.append(s),s.select(),document.execCommand("copy"),s.remove()}Y(n,"success"),_(n,"success")}catch(s){console.error(s),Y(i,"error"),_(i,"error")}}async function St(e){if(!e)return;if(he(),!e.type||!e.type.startsWith("image/")){_("Format non pris en charge. S\xE9lectionnez une image (JPEG, PNG, WebP\u2026).","error");return}if(e.size>bt){_(`Fichier trop volumineux (${qe(e.size)}). Limite 5 Mo.`,"error");return}_("T\xE9l\xE9versement en cours\u2026","saving"),Y("T\xE9l\xE9versement de l\u2019image\u2026","saving");let n=new FormData;n.append("file",e,e.name);try{let i=await fetch("/api/uploads",{method:"POST",body:n});if(!i.ok){let p=`Erreur serveur (${i.status})`;try{let m=await i.json();m!=null&&m.message&&(p=m.message)}catch{}throw new Error(p)}let r=await i.json(),s=r==null?void 0:r.url;if(!s)throw new Error("R\xE9ponse du serveur invalide (URL manquante).");let l=We(s);Me(l,{origin:"upload",sizeBytes:e.size})}catch(i){console.error(i),_(i.message||"\xC9chec du t\xE9l\xE9versement.","error"),Y(`T\xE9l\xE9versement \xE9chou\xE9: ${i.message||"Erreur inconnue"}`,"error"),he()}}he(),ne&&_(ne.textContent||"Formats recommand\xE9s : JPG, PNG, WebP.","info");function Et(e){X.forEach(n=>{let i=n.dataset.orientation===e;n.classList.toggle("active",i)})}function Ke(){var e,n,i,r,s,l,p;if(M&&(M.value=(n=(e=a.transitionTime)==null?void 0:e.toString())!=null?n:""),x&&(x.value=(r=(i=a.cardXSpacing)==null?void 0:i.toString())!=null?r:""),q&&(q.value=(l=(s=a.cardYSpacing)==null?void 0:s.toString())!=null?l:""),w){let m=(p=a.singleParentEmptyCardLabel)!=null?p:I.singleParentEmptyCardLabel;w.value=m}z&&(z.value=Ze(a.ancestryDepth,I.ancestryDepth)),v&&(v.value=Ze(a.progenyDepth,I.progenyDepth)),F&&(F.checked=a.miniTree!==!1),P&&(P.checked=a.duplicateBranchToggle!==!1),Et(a.orientation||I.orientation)}function Q(e={},{treePosition:n="inherit",refresh:i=!0}={}){if(a={...a,...e},ft(t),o&&typeof o.setMiniTree=="function"&&o.setMiniTree(a.miniTree!==!1),i){let r=C;C=!0,Ke(),C=r}t.updateTree({initial:!1,tree_position:n}),J=null,C||ae()}function xe(e,n){if(!e)return n;let i=Number(e.value);return Number.isFinite(i)?i:n}function Ze(e,n){return e===null?"":typeof e=="number"&&Number.isFinite(e)&&e>=0?String(Math.floor(e)):typeof n=="number"&&Number.isFinite(n)&&n>=0?String(Math.floor(n)):""}function Qe(e,n){if(!e)return n;if(e.value==="")return null;let i=Number(e.value);return Number.isFinite(i)&&i>=0?Math.floor(i):n}function Ee(e,n){let i=k(e);return n?N.set(i,n.trim()||e):N.has(i)||N.set(i,e),N.get(i)||e}function vt(e){return te(e).map(n=>{let i=k(n),r=Ee(n,N.get(i)),s=ut.has(i)?"textarea":"text";return{id:n,label:r,type:s}})}function we(e){return typeof e=="string"?e.trim():""}function _e(){if(!S||!S.store||typeof S.store.getData!="function")return[];let e=S.store.getData();return Array.isArray(e)?e:[]}function et(e){if(!e)return"Profil sans nom";let n=e.data||{},i=we(n["first name"]),r=we(n["last name"]),s=i||r?[i,r].filter(Boolean).join(" ").trim():`Profil ${e.id}`,l=we(n.birthday);return l?`${s} (${l})`:s}function ve(e){var i,r;if(!oe)return;if(!e){oe.textContent="\u2014";return}let n=(r=(i=S==null?void 0:S.store)==null?void 0:i.getDatum)==null?void 0:r.call(i,e);if(!n){oe.textContent="\u2014";return}oe.textContent=et(n)}function ye({keepSelection:e=!0}={}){var g;if(!b)return;let n=_e(),i=e?b.value:"";if(b.innerHTML="",!n.length){let f=document.createElement("option");f.value="",f.textContent="Aucune personne disponible",b.append(f),b.disabled=!0,ve(null);return}let r=document.createDocumentFragment();n.forEach(f=>{if(!f||!f.id)return;let A=document.createElement("option");A.value=f.id,A.textContent=et(f),r.append(A)}),b.append(r),b.disabled=!1;let s=new Set(n.map(f=>f.id)),l=[];e&&i&&s.has(i)&&l.push(i);let p=typeof a.mainId=="string"?a.mainId:"";p&&s.has(p)&&l.push(p);let m=t.store&&typeof t.store.getMainId=="function"?t.store.getMainId():"";m&&s.has(m)&&l.push(m),(g=n[0])!=null&&g.id&&l.push(n[0].id);let h=l.find(Boolean)||"";h?b.value=h:b.selectedIndex=0,ve(b.value||null)}function Dt({scheduleSaveIfChanged:e=!1}={}){if(!t.store||typeof t.store.getMainId!="function")return;let n=t.store.getMainId();if(b){let i=_e(),r=new Set(i.map(s=>s.id));n&&!r.has(n)&&ye({keepSelection:!1}),n&&([...b.options].some(l=>l.value===n)||ye({keepSelection:!1}),b.value=n,b.disabled=!1),!n&&!b.options.length&&ye({keepSelection:!1})}ve(n||null),a.mainId!==n&&(a={...a,mainId:n||null},J=null,e&&!C&&ae())}function kt(e,{openEditor:n=!0,treePosition:i="main_to_middle",suppressSave:r=!1}={}){var h,g;if(!e)return;if(!_e().some(f=>f.id===e)){ye({keepSelection:!1});return}let p=(t.store&&typeof t.store.getMainId=="function"?t.store.getMainId():null)!==e;p&&(t.updateMainId(e),t.updateTree({initial:!1,tree_position:i}));let m=a.mainId!==e;if(m&&(a={...a,mainId:e}),(m||p)&&!r&&(J=null,C||ae()),b&&b.value!==e&&(b.value=e,b.disabled=!1),ve(e),n&&S){let f=(g=(h=S.store)==null?void 0:h.getDatum)==null?void 0:g.call(h,e);f&&S.open(f)}}b&&b.addEventListener("change",e=>{let{value:n}=e.target;n&&kt(n,{openEditor:!0,treePosition:"main_to_middle"})});function ge(e){var n;return(n=window.CSS)!=null&&n.escape?window.CSS.escape(e):e.replace(/[^a-zA-Z0-9_-]/g,i=>`\\${i}`)}function tt(e){if(e.querySelector(".remove-field"))return;let n=document.createElement("button");n.type="button",n.className="remove-field",n.textContent="Retirer",n.addEventListener("click",()=>{e.remove(),Oe()}),e.append(n)}function It(e){T.forEach(n=>{let i=n.querySelector(".field-list");if(!i)return;let r=`[data-field-key="${ge(e)}"]`,s=i.querySelector(r);if(s)if(s.dataset.custom==="true")s.remove();else{let l=G.get(n.dataset.displayRow),p=l==null?void 0:l.get(e),m=s.querySelector('input[type="checkbox"]');m&&typeof p=="boolean"&&(m.checked=p)}})}function Tt(e){if(!a.cardDisplay)return[];let n=k(e),i=[];return a.cardDisplay.forEach((r,s)=>{r.some(l=>k(l)===n)&&i.push(String(s+1))}),i}function Ct(){Array.isArray(a.editableFields)&&a.editableFields.forEach(e=>{let n=k(e);if(!n)return;let i=Ee(e,N.get(n)),r=`[data-field-key="${ge(n)}"]`;u!=null&&u.querySelector(r)||Ne({value:e,label:i,checked:!0,removable:!0,selectRows:Tt(e)})})}function Lt(){if(!u)return;let e=new Set((a.editableFields||[]).map(k));u.querySelectorAll('input[type="checkbox"]').forEach(n=>{let i=k(n.value);n.checked=e.has(i)})}function Ft(){T.forEach((e,n)=>{let i=a.cardDisplay&&a.cardDisplay[n]||[],r=new Set(i.map(k));e.querySelectorAll('input[type="checkbox"]').forEach(s=>{let l=k(s.value);s.checked=r.has(l)})})}function Pt(e,{value:n,label:i,defaultChecked:r=!1,removable:s=!1}){let l=e.querySelector(".field-list");if(!l)return{item:null,isNew:!1};let p=k(n),m=`[data-field-key="${ge(p)}"]`,h=Ee(n,i),g=l.querySelector(m);if(g){let ee=g.querySelector("label span");return ee&&(ee.textContent=h),s&&(g.dataset.custom="true",tt(g)),{item:g,isNew:!1}}g=document.createElement("div"),g.className="display-item",g.dataset.fieldKey=p,s&&(g.dataset.custom="true");let f=document.createElement("label"),A=document.createElement("input");A.type="checkbox",A.value=n,A.checked=r;let $=document.createElement("span");return $.textContent=h,f.append(A,$),g.append(f),s&&tt(g),l.append(g),{item:g,isNew:!0}}function Ne({value:e,label:n,checked:i=!0,removable:r=!1,selectRows:s=[]}){if(!u)return;let l=k(e),p=Ee(e,n),m=`[data-field-key="${ge(l)}"]`,h=u.querySelector(m),g=!h;if(h){let A=h.querySelector('input[type="checkbox"]');A&&typeof i=="boolean"&&(A.checked=i);let $=h.querySelector("label span");$&&($.textContent=p),r&&(h.dataset.custom="true")}else{h=document.createElement("div"),h.className="editable-item",h.dataset.fieldKey=l,r&&(h.dataset.custom="true");let A=document.createElement("label"),$=document.createElement("input");$.type="checkbox",$.value=e,$.checked=i;let ee=document.createElement("span");if(ee.textContent=p,A.append($,ee),h.append(A),r){let re=document.createElement("button");re.type="button",re.className="remove-field",re.textContent="Retirer",re.addEventListener("click",()=>{h.remove(),It(l),De()}),h.append(re)}u.append(h)}let f=new Set((s||[]).map(String));T.forEach(A=>{let $=A.dataset.displayRow,ee=G.get($),re=ee==null?void 0:ee.get(l),_t=re!==void 0?re:f.has($),Nt=r,{item:at,isNew:Ot}=Pt(A,{value:e,label:p,defaultChecked:_t,removable:Nt});if(at&&!Ot&&f.has($)){let ot=at.querySelector('input[type="checkbox"]');ot&&(ot.checked=!0)}})}function nt(e){return e?[...e.querySelectorAll('input[type="checkbox"]')].filter(n=>n.checked).map(n=>n.value):[]}function it(e=[],n=[]){return e.length!==n.length?!1:e.every((i,r)=>k(i)===k(n[r]))}function At(e=[],n=[]){return e.length!==n.length?!1:e.every((i,r)=>it(i,n[r]))}function Mt(e){T.forEach(n=>{n.querySelectorAll(".display-item").forEach(r=>{let s=r.dataset.fieldKey,l=r.querySelector('input[type="checkbox"]'),p=e.has(s);r.classList.toggle("is-disabled",!p),l&&(l.disabled=!p,!p&&l.checked&&(l.checked=!1))})})}function Oe({suppressSave:e=!1}={}){let n=E.get("1"),i=E.get("2"),r=te(nt(n)),s=te(nt(i)),l=r[0]||(se.length?se[0]:pe[0]||"first name"),m=[r.length?r:[l],s];o.setCardDisplay(m),t.updateTree({initial:!1,tree_position:"inherit"}),!At(a.cardDisplay,m)&&(a={...a,cardDisplay:m.map(g=>[...g])},e||(J=null,C||ae()))}function De({suppressSave:e=!1}={}){if(!S||!u)return;let n=[...u.querySelectorAll('input[type="checkbox"]')].filter(m=>m.checked).map(m=>m.value),i=n.length?n:a.editableFields.length?[...a.editableFields]:["first name"];if(i=te(i),!i.length){let m=pe[0]||"first name";if(i=[m],u){let h=k(m),g=`[data-field-key="${ge(h)}"] input[type="checkbox"]`,f=u.querySelector(g);f&&(f.checked=!0)}}se=[...i];let r=vt(i);S.setFields(r);let s=new Set(i.map(k));Mt(s),!it(a.editableFields,i)&&(a={...a,editableFields:[...i]},e||(J=null,C||ae())),Oe({suppressSave:e});let p=S.store.getMainDatum();p&&S.open(p)}function qt(){let e=prompt("Nom du champ (cl\xE9 dans vos donn\xE9es) ?");if(!e)return null;let n=e.trim();if(!n)return null;let i=k(n),r=N.get(i)||n,s=prompt("Libell\xE9 affich\xE9 pour ce champ ?",r),l=(s!=null?s:r).trim()||n;return{value:n,label:l,key:i}}function xt({selectRows:e=[]}={}){let n=qt();if(!n)return;let{value:i,label:r,key:s}=n,l=Te.some(p=>k(p.value)===s);Ne({value:i,label:r,checked:!0,removable:!l,selectRows:e}),De()}Te.forEach(e=>{Ne({value:e.value,label:e.label,checked:e.checked!==!1,removable:!1})}),u==null||u.addEventListener("change",e=>{e.target.matches('input[type="checkbox"]')&&De()}),L==null||L.addEventListener("click",()=>xt()),T.forEach(e=>{e.addEventListener("change",n=>{n.target.matches('input[type="checkbox"]')&&Oe()})}),y==null||y.addEventListener("change",()=>{o.setCardImageField(y.value),t.updateTree({initial:!1,tree_position:"inherit"}),Je()}),O==null||O.addEventListener("change",()=>{o.setStyle(O.value),t.updateTree({initial:!1,tree_position:"inherit"})}),M==null||M.addEventListener("change",()=>{var r;if(C)return;let e=(r=a.transitionTime)!=null?r:I.transitionTime,n=xe(M,e),i=Math.max(0,n);i!==a.transitionTime&&Q({transitionTime:i})}),q==null||q.addEventListener("change",()=>{var r;if(C)return;let e=(r=a.cardYSpacing)!=null?r:I.cardYSpacing,n=xe(q,e),i=n>0?n:e;i!==a.cardYSpacing&&Q({cardYSpacing:i})}),x==null||x.addEventListener("change",()=>{var r;if(C)return;let e=(r=a.cardXSpacing)!=null?r:I.cardXSpacing,n=xe(x,e),i=n>0?n:e;i!==a.cardXSpacing&&Q({cardXSpacing:i})}),z==null||z.addEventListener("change",()=>{var i,r;if(C)return;let e=(r=(i=a.ancestryDepth)!=null?i:I.ancestryDepth)!=null?r:null,n=Qe(z,e);n!==a.ancestryDepth&&Q({ancestryDepth:n},{treePosition:"main_to_middle"})}),v==null||v.addEventListener("change",()=>{var i,r;if(C)return;let e=(r=(i=a.progenyDepth)!=null?i:I.progenyDepth)!=null?r:null,n=Qe(v,e);n!==a.progenyDepth&&Q({progenyDepth:n},{treePosition:"main_to_middle"})}),F==null||F.addEventListener("change",()=>{if(C)return;let e=F.checked,n=a.miniTree!==!1;e!==n&&Q({miniTree:e})}),P==null||P.addEventListener("change",()=>{if(C)return;let e=P.checked,n=a.duplicateBranchToggle!==!1;e!==n&&Q({duplicateBranchToggle:e},{treePosition:"inherit"})}),w==null||w.addEventListener("change",()=>{if(C)return;let e=(w.value||"").trim()||I.singleParentEmptyCardLabel;e!==a.singleParentEmptyCardLabel&&Q({singleParentEmptyCardLabel:e,singleParentEmptyCard:!0})}),X==null||X.forEach(e=>{e.addEventListener("click",()=>{let i=e.dataset.orientation==="horizontal"?"horizontal":"vertical";a.orientation!==i&&Q({orientation:i},{treePosition:"fit"})})});function rt(){let e={};n("width",R),n("height",V),n("img_w",H),n("img_h",K),n("img_x",le),n("img_y",ce),o.resetCardDim(),Object.keys(e).length>0&&o.setCardDim(e),t.updateTree({initial:!1,tree_position:"inherit"});function n(i,r){if(!r)return;let s=Number(r.value);Number.isFinite(s)&&(e[i]=s)}}[R,V,H,K,le,ce].forEach(e=>e==null?void 0:e.addEventListener("change",rt)),ue==null||ue.addEventListener("click",()=>{[[R,240],[V,150],[H,80],[K,80],[le,16],[ce,16]].forEach(([e,n])=>{e&&(e.value=n)}),rt()}),de==null||de.addEventListener("change",e=>{let n=e.target.files&&e.target.files[0];n&&St(n),e.target.value=""}),Pe==null||Pe.addEventListener("click",()=>{var n,i;let e=((n=U==null?void 0:U.dataset)==null?void 0:n.url)||((i=W==null?void 0:W.textContent)==null?void 0:i.trim());e&&Me(e,{origin:"manual"}),He(e,{successMessage:"URL du t\xE9l\xE9versement copi\xE9e \u2705",errorMessage:"Impossible de copier l\u2019URL du t\xE9l\xE9versement."})}),Ae==null||Ae.addEventListener("click",()=>{var n;let e=(n=j==null?void 0:j.value)==null?void 0:n.trim();e&&Me(e,{origin:"manual"}),He(e,{successMessage:"Image appliqu\xE9e et URL copi\xE9e \u2705",errorMessage:"Impossible de copier ce lien."})});let wt=C;return C=!0,Ct(),Ke(),Lt(),Ft(),C=wt,De({suppressSave:!0}),{refreshMainProfileOptions:ye,syncMainProfileSelection:Dt,handleFormCreation:yt,teardown:gt}}async function mt(){Xe(),S=null,J=null;try{let t=await Xt();jt(t)}catch(t){console.error(t),Y(`Erreur: ${t.message}`,"error")}}ze==null||ze.addEventListener("click",()=>{let t=Fe();t&&je(t,{immediate:!0})});Be==null||Be.addEventListener("click",()=>{mt()});function Ut(){let t=Fe();return t?JSON.stringify(t)!==J:!1}window.addEventListener("beforeunload",t=>{Ut()&&(t.preventDefault(),t.returnValue="")});mt();
//# sourceMappingURL=builder.bundle.js.map
