import*as vt from"/lib/family-tree.esm.js";var ze=document.getElementById("status"),je=document.getElementById("save"),Be=document.getElementById("reload"),A=document.getElementById("controlPanel"),yt="#FamilyChart",Xe=document.querySelector('[data-role="builder-search"]'),Ge=document.querySelector('[data-role="builder-search-target"]'),gt=document.querySelector('[data-role="builder-search-empty"]'),bt=document.getElementById("builderSearchLabel"),St=document.getElementById("builderSearchHint"),ge=document.querySelector('[data-action="toggle-panel"]'),He="family-tree:builder:controlsCollapsed",Le=[],Ke=!1;function Ve(e){if(Xe){if(!e){delete Xe.dataset.state;return}Xe.dataset.state=e}}function I(e){return e==null?"":String(e).trim().toLowerCase()}function te(e){if(!Array.isArray(e))return[];let r=new Set,c=[];return e.forEach(s=>{if(typeof s!="string")return;let g=s.trim();if(!g)return;let S=I(g);r.has(S)||(r.add(S),c.push(g))}),c}function Dt(){try{return window.localStorage}catch{return null}}function en(){let e=Dt();if(!e)return!1;try{return e.getItem(He)==="1"}catch{return!1}}function tn(e){let r=Dt();if(r)try{e?r.setItem(He,"1"):r.removeItem(He)}catch{}}function It(e){e?document.body.classList.add("controls-collapsed"):document.body.classList.remove("controls-collapsed"),ge&&(ge.setAttribute("aria-expanded",String(!e)),ge.textContent=e?"Afficher le panneau":"Replier le panneau")}function nn(e){let r=typeof e=="boolean"?e:!document.body.classList.contains("controls-collapsed");It(r),tn(r)}var rn=en();It(rn);ge&&ge.addEventListener("click",()=>{nn()});var an=new Map([["first name","Pr\xE9nom"],["first names","Pr\xE9noms"],["last name","Nom"],["birthday","Date de naissance"],["death","Date de D\xE9c\xE8s"],["gender","Genre"],["avatar","Photo de profil"],["photo","Photo"],["picture","Portrait"],["bio","Biographie"],["occupation","Profession"],["location","Lieu de r\xE9sidence"],["birthplace","Lieu de naissance"],["deathplace","Lieu de d\xE9c\xE8s"],["union date","Date d'union"],["union place","Lieu d'union"],["union paragraph","Paragraphe d'union"],["notes","Notes"],["nickname","Surnom"],["maiden name","Nom de naissance"]]),Ce=new Set(["phone","email","notes","occupation","location","residence","nickname"]),Ct={1:[{value:"first name",checked:!0},{value:"last name",checked:!0},{value:"birthday",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}],2:[{value:"birthday",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}]},Fe=[{value:"first name",label:"Pr\xE9nom",checked:!0},{value:"first names",label:"Pr\xE9noms",checked:!0},{value:"last name",label:"Nom",checked:!0},{value:"maiden name",label:"Nom de naissance",checked:!0},{value:"birthday",label:"Date de naissance",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!0},{value:"avatar",label:"Avatar",checked:!0},{value:"gender",label:"Genre",checked:!0},{value:"birthplace",label:"Lieu de naissance",checked:!0},{value:"deathplace",label:"Lieu de D\xE9c\xE8s",checked:!0},{value:"bio",label:"Biographie",checked:!1}],qe=[["first name","last name"],["birthday"]],kt="union paragraph",fe=Me(te(Fe.filter(e=>e.checked!==!1).map(e=>e.value))),on=new Set(["bio","notes","biographie","description","union paragraph"]),We=new Set(["union date","union place"]);function Ze(e,r,c){if(We.has(e))return{id:r,label:c,type:"rel_reference",rel_type:"spouse",getRelLabel:be};let s=on.has(e)?"textarea":"text";return{id:r,label:c,type:s}}function Lt(e,r){let c=s=>r?typeof r.get=="function"||r instanceof Map?r.get(s)||s:r[s]||s:s;return We.forEach(s=>{if(e.some(y=>I(y.id)===s))return;let S=c(s);e.push(Ze(s,s,S))}),e}function Je(){let e=new Map(an);return Fe.forEach(r=>{e.set(I(r.value),r.label)}),Object.values(Ct).forEach(r=>{r.forEach(c=>{c.label&&e.set(I(c.value),c.label)})}),e}function sn(e,r=Je()){let c=r||Je(),s=te(e).map(g=>{let S=I(g),y=c.get(S)||g;return Ze(S,g,y)});return Lt(s,c)}function Et(e){return typeof e=="string"?e.trim():""}function Ae(){if(!v||!v.store||typeof v.store.getData!="function")return[];let e=v.store.getData();return Array.isArray(e)?e:[]}function be(e){if(!e)return"Profil sans nom";let r=e.data||{},c=Et(r["first name"]),s=Et(r["last name"]);return(c||s?[c,s].filter(Boolean).join(" ").trim():`Profil ${e.id}`)||"Profil sans nom"}function ln(e){if(!e||typeof e.id!="string"||!e.id.trim())return null;let r=be(e),c=new Set,s=[],g=new Set,S=m=>{if(typeof m!="string")return;let E=m.trim();E&&c.add(E)},y=m=>{if(typeof m!="string")return;let E=m.trim();!E||g.has(E)||(g.add(E),s.push(E))};S(r),S(String(e.id));let M=e.data&&typeof e.data=="object"?e.data:{};Object.entries(M).forEach(([m,E])=>{if(typeof E!="string")return;let k=E.trim();if(!k)return;S(k);let C=I(m);if(C==="birthday"){y(k);return}if(C==="death"){y(`\u271D ${k}`);return}if(C==="maiden name"){y(`(${k})`);return}if(C==="occupation"){y(k);return}(C==="location"||C==="residence"||C==="birthplace"||C==="deathplace")&&y(k)});let $=Array.from(c).map(m=>m.replace(/\s+/g," ").trim()).filter(Boolean).join(" | ");return{label:r,value:e.id,searchText:$,optionHtml:m=>{let E=s.length?`<small>${s.join(" \xB7 ")}</small>`:"";return`<div>${m.label_html||m.label}${E?`<div class="f3-autocomplete-meta">${E}</div>`:""}</div>`}}}function cn(e){if(!Array.isArray(e))return[];let r=[],c=new Set;return e.forEach(s=>{if(!s||!s.id||c.has(s.id))return;let g=ln(s);g&&(r.push(g),c.add(s.id))}),r.sort((s,g)=>s.label.localeCompare(g.label,"fr",{sensitivity:"base"})),r}function un(e){if(!e||!Ge)return Ve("empty"),null;gt&&gt.classList.remove("hidden"),e.setPersonDropdown(s=>be(s),{cont:Ge,placeholder:"Rechercher (nom, date, lieu, etc.)",onSelect:s=>{var S,y;if(!s||!v)return;let g=(y=(S=v.store)==null?void 0:S.getDatum)==null?void 0:y.call(S,s);g&&v.open(g)}});let r=Ge.querySelector("input");r&&(r.setAttribute("id","builderSearchInput"),bt&&r.setAttribute("aria-labelledby",bt.id),St&&r.setAttribute("aria-describedby",St.id),r.setAttribute("autocomplete","off"),r.setAttribute("spellcheck","false"));function c(){if(!e.personSearch)return;let s=Ae();Le=cn(s),e.personSearch.setOptionsGetter(()=>Le),Ve(Le.length?"ready":"empty"),Ke=!0}return c(),{refreshSearchOptions:c}}var P=Object.freeze({transitionTime:200,cardXSpacing:240,cardYSpacing:140,orientation:"vertical",showSiblingsOfMain:!0,singleParentEmptyCard:!0,singleParentEmptyCardLabel:"Inconnu",ancestryDepth:4,progenyDepth:4,miniTree:!0,editableFields:[...fe],cardDisplay:qe.map(e=>[...e]),mainId:null});function dn(e){let c=(Array.isArray(e)?e:[]).slice(0,2).map(s=>te(Array.isArray(s)?s:[]));for(;c.length<2;)c.push([]);return c}function Te(e,r=qe){var g,S,y,M,$,m,E,k,C,x,O,_,Y,F;let c=e;return e&&!Array.isArray(e)&&typeof e=="object"&&(c=[(E=(m=($=(M=(y=(S=(g=e[0])!=null?g:e[0])!=null?S:e.row1)!=null?y:e.row_1)!=null?M:e.ligne1)!=null?$:e.line1)!=null?m:e.first)!=null?E:[],(F=(Y=(_=(O=(x=(C=(k=e[1])!=null?k:e[1])!=null?C:e.row2)!=null?x:e.row_2)!=null?O:e.ligne2)!=null?_:e.line2)!=null?Y:e.second)!=null?F:[]]),Array.isArray(c)?dn(c).map((q,H)=>{if(q.length)return[...q];let B=r[H];return Array.isArray(B)?[...B]:[]}):r.map(q=>[...q])}function At(e={}){let r={transitionTime:P.transitionTime,cardXSpacing:P.cardXSpacing,cardYSpacing:P.cardYSpacing,orientation:P.orientation,showSiblingsOfMain:P.showSiblingsOfMain,singleParentEmptyCard:P.singleParentEmptyCard,singleParentEmptyCardLabel:P.singleParentEmptyCardLabel,ancestryDepth:P.ancestryDepth,progenyDepth:P.progenyDepth,miniTree:P.miniTree,editableFields:[...fe],cardDisplay:Te(qe),mainId:P.mainId};if(typeof e.transitionTime=="number"&&Number.isFinite(e.transitionTime)&&(r.transitionTime=e.transitionTime),typeof e.cardXSpacing=="number"&&Number.isFinite(e.cardXSpacing)&&(r.cardXSpacing=e.cardXSpacing),typeof e.cardYSpacing=="number"&&Number.isFinite(e.cardYSpacing)&&(r.cardYSpacing=e.cardYSpacing),(e.orientation==="horizontal"||e.orientation==="vertical")&&(r.orientation=e.orientation),typeof e.showSiblingsOfMain=="boolean"&&(r.showSiblingsOfMain=e.showSiblingsOfMain),typeof e.singleParentEmptyCard=="boolean"&&(r.singleParentEmptyCard=e.singleParentEmptyCard),typeof e.singleParentEmptyCardLabel=="string"){let c=e.singleParentEmptyCardLabel.trim();c&&(r.singleParentEmptyCardLabel=c)}if(e.ancestryDepth===null?r.ancestryDepth=null:typeof e.ancestryDepth=="number"&&Number.isFinite(e.ancestryDepth)&&e.ancestryDepth>=0&&(r.ancestryDepth=Math.floor(e.ancestryDepth)),e.progenyDepth===null?r.progenyDepth=null:typeof e.progenyDepth=="number"&&Number.isFinite(e.progenyDepth)&&e.progenyDepth>=0&&(r.progenyDepth=Math.floor(e.progenyDepth)),typeof e.miniTree=="boolean"&&(r.miniTree=e.miniTree),Array.isArray(e.editableFields)){let c=te(e.editableFields);c.length&&(r.editableFields=c)}if((Array.isArray(e.cardDisplay)||e.cardDisplay&&typeof e.cardDisplay=="object")&&(r.cardDisplay=Te(e.cardDisplay,[[],[]])),typeof e.mainId=="string"){let c=e.mainId.trim();c&&(r.mainId=c)}return r}var v=null,Pe=null,V=null,Ue=!1,ke=null,o=At(),T=!1,ee=[...fe],ye=null;function j(e,r="info"){ze&&(ze.textContent=e,ze.dataset.status=r)}function fn(e){if(Array.isArray(e))return{data:e,config:{}};if(e&&typeof e=="object"){if(Array.isArray(e.data)){let r=e.config||e.settings||e.meta||{};return{data:e.data,config:r}}if(Array.isArray(e.tree)){let r=e.config||e.settings||e.meta||{};return{data:e.tree,config:r}}}return{data:[],config:{}}}function pn(e={}){var _,Y,F,q,H,B,G,K,J,W,le,Z,D,se,f,ce,ne,U;if(!e||typeof e!="object")return{};let r={},c=(_=e.transitionTime)!=null?_:e.transition_time;typeof c=="number"&&Number.isFinite(c)&&(r.transitionTime=c);let s=(F=(Y=e.cardXSpacing)!=null?Y:e.card_x_spacing)!=null?F:e.node_separation;typeof s=="number"&&Number.isFinite(s)&&(r.cardXSpacing=s);let g=(H=(q=e.cardYSpacing)!=null?q:e.card_y_spacing)!=null?H:e.level_separation;typeof g=="number"&&Number.isFinite(g)&&(r.cardYSpacing=g);let S=e.orientation;S==="horizontal"||S==="vertical"?r.orientation=S:typeof e.is_horizontal=="boolean"&&(r.orientation=e.is_horizontal?"horizontal":"vertical");let y=(B=e.showSiblingsOfMain)!=null?B:e.show_siblings_of_main;typeof y=="boolean"&&(r.showSiblingsOfMain=y);let M=(G=e.singleParentEmptyCard)!=null?G:e.single_parent_empty_card;typeof M=="boolean"&&(r.singleParentEmptyCard=M);let $=(K=e.singleParentEmptyCardLabel)!=null?K:e.single_parent_empty_card_label;typeof $=="string"&&$.trim().length>0&&(r.singleParentEmptyCardLabel=$.trim());let m=(le=(W=(J=e.editableFields)!=null?J:e.edit_fields)!=null?W:e.fields)!=null?le:e.editable_fields;Array.isArray(m)&&(r.editableFields=te(m));let E=(Z=e.cardDisplay)!=null?Z:e.card_display;(Array.isArray(E)||E&&typeof E=="object")&&(r.cardDisplay=Te(E,[[],[]]));let k=(f=(se=(D=e.mainId)!=null?D:e.main_id)!=null?se:e.mainPersonId)!=null?f:e.main_person_id;typeof k=="string"&&k.trim().length>0&&(r.mainId=k.trim());let C=(ce=e.ancestryDepth)!=null?ce:e.ancestry_depth;if(C===null)r.ancestryDepth=null;else if(C!==void 0){let R=Number(C);Number.isFinite(R)&&R>=0&&(r.ancestryDepth=Math.floor(R))}let x=(ne=e.progenyDepth)!=null?ne:e.progeny_depth;if(x===null)r.progenyDepth=null;else if(x!==void 0){let R=Number(x);Number.isFinite(R)&&R>=0&&(r.progenyDepth=Math.floor(R))}let O=(U=e.miniTree)!=null?U:e.mini_tree;return typeof O=="boolean"&&(r.miniTree=O),r}function Pt(e){e.setTransitionTime(o.transitionTime),e.setCardXSpacing(o.cardXSpacing),e.setCardYSpacing(o.cardYSpacing),e.setShowSiblingsOfMain(o.showSiblingsOfMain),o.orientation==="horizontal"?e.setOrientationHorizontal():e.setOrientationVertical(),e.setSingleParentEmptyCard(o.singleParentEmptyCard,{label:o.singleParentEmptyCardLabel}),typeof o.ancestryDepth=="number"&&Number.isFinite(o.ancestryDepth)?e.setAncestryDepth(o.ancestryDepth):e.setAncestryDepth(null),typeof o.progenyDepth=="number"&&Number.isFinite(o.progenyDepth)?e.setProgenyDepth(o.progenyDepth):e.setProgenyDepth(null)}async function mn(){j("Chargement des donn\xE9es\u2026");let e=await fetch("/api/tree",{cache:"no-store"});if(!e.ok)throw new Error(`\xC9chec du chargement (${e.status})`);return e.json()}function Qe(){Pe&&(clearTimeout(Pe),Pe=null)}async function et(e,{immediate:r=!1}={}){if(!e)return;Qe();let c=Ft(e);if(Ue){ke={snapshot:c,immediate:r},j("Sauvegarde d\xE9j\xE0 en cours\u2026","saving");return}try{Ue=!0,j(r?"Enregistrement en cours\u2026":"Sauvegarde automatique\u2026","saving");let s=await fetch("/api/tree",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c,null,2)});if(!s.ok&&s.status!==204)throw new Error(`Serveur a retourn\xE9 ${s.status}`);V=JSON.stringify(c),j("Modifications enregistr\xE9es \u2705","success")}catch(s){console.error(s),j(`Erreur d'enregistrement: ${s.message}`,"error")}finally{if(Ue=!1,ke){let s=ke;ke=null,await et(s.snapshot,{immediate:s.immediate})}}}function Ft(e){return typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}function we(){if(!v)return null;let e=v.exportData();return e?{data:e,config:Ft(o)}:null}function oe(){Qe(),j("Modification d\xE9tect\xE9e\u2026 sauvegarde automatique imminente","saving"),Pe=setTimeout(()=>{let e=we();e&&et(e)},1500)}function hn(e){let r=document.querySelector(yt);if(!r)throw new Error("Conteneur du graphique introuvable");r.innerHTML="",Ke=!1,Le=[],Ve("loading"),typeof ye=="function"&&(ye(),ye=null);let{data:c,config:s}=fn(e);o=At(pn(s)),ee=[...o.editableFields],ee.length||(ee=[...fe]),ee=Me(ee);let g=[...ee],S=sn(g),y=vt.createChart(yt,c);Pt(y);let M=o.cardDisplay&&o.cardDisplay.length?o.cardDisplay.map(F=>[...F]):Te(qe),$=y.setCardHtml().setCardDisplay(M).setCardImageField("avatar").setMiniTree(o.miniTree!==!1),m=null,E=null,k=Array.isArray(c)?c:[];v=y.editTree().setFields(S).setEditFirst(!0).setCardClickOpen($).setOnChange(()=>{V=null,m&&(m.refreshMainProfileOptions({keepSelection:!0}),m.syncMainProfileSelection({scheduleSaveIfChanged:!1})),E&&E.refreshSearchOptions(),oe()}),m=yn({chart:y,card:$})||{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}},E=un(y),typeof m.teardown=="function"?ye=m.teardown:ye=null,typeof m.handleFormCreation=="function"&&v.setOnFormCreation(m.handleFormCreation);let C=Y(k,y);C&&y.updateMainId(C),y.setAfterUpdate(()=>{if(!y.store||typeof y.store.getMainId!="function")return;!y.store.getMainId()&&o.mainId&&(o={...o,mainId:null},V=null,T||oe()),m&&m.syncMainProfileSelection({scheduleSaveIfChanged:!1}),!Ke&&E&&E.refreshSearchOptions()}),m&&(m.refreshMainProfileOptions({keepSelection:!1}),m.syncMainProfileSelection({scheduleSaveIfChanged:!1})),y.updateTree({initial:!0,tree_position:"fit"});let x=y.getMainDatum();x&&v.open(x);let O=we();V=O?JSON.stringify(O):null;let _=k.length;j(_>0?`\xC9diteur pr\xEAt \u2705 \u2013 ${_} personne(s) charg\xE9e(s)`:"Fichier de donn\xE9es vide",_>0?"success":"error");function Y(F,q){var J;if(!Array.isArray(F)||F.length===0)return o={...o,mainId:null},null;let H=new Set(F.map(W=>W&&W.id).filter(Boolean)),B=typeof o.mainId=="string"?o.mainId.trim():"";if(B&&H.has(B))return B;let G=q!=null&&q.store&&typeof q.store.getMainId=="function"?q.store.getMainId():null;if(G&&H.has(G))return o.mainId!==G&&(o={...o,mainId:G}),G;let K=((J=F[0])==null?void 0:J.id)||null;return K&&o.mainId!==K&&(o={...o,mainId:K}),K}}function yn({chart:e,card:r}){if(!A)return{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}};let c=A.querySelector('[data-role="editable-fields"]'),s=c==null?void 0:c.querySelector(".editable-list"),g=c==null?void 0:c.querySelector('[data-action="add-editable"]'),S=[...A.querySelectorAll("[data-display-row]")],y=new Map(S.map(t=>[t.dataset.displayRow,t])),M=Je(),$=new Map(Object.entries(Ct).map(([t,n])=>[t,new Map(n.map(i=>[I(i.value),i.checked]))])),m=A.querySelector("#imageField"),E=A.querySelector("#cardStyle"),k=A.querySelector("#transitionInput"),C=A.querySelector("#cardYSpacing"),x=A.querySelector("#cardXSpacing"),O=A.querySelector("#emptyLabel"),_=A.querySelector("#ancestryDepth"),Y=A.querySelector("#progenyDepth"),F=A.querySelector("#miniTreeToggle"),q=A.querySelectorAll("[data-orientation]"),H=A.querySelector("#cardWidth"),B=A.querySelector("#cardHeight"),G=A.querySelector("#imgWidth"),K=A.querySelector("#imgHeight"),J=A.querySelector("#imgX"),W=A.querySelector("#imgY"),le=A.querySelector("#resetDimensions"),Z=A.querySelector('[data-role="main-profile"]'),D=Z==null?void 0:Z.querySelector("#mainProfileSelect"),se=Z==null?void 0:Z.querySelector('[data-role="main-profile-name"]');D&&(D.disabled=!0);let f=A.querySelector('[data-role="image-uploader"]'),ce=f==null?void 0:f.querySelector("#assetUpload"),ne=f==null?void 0:f.querySelector('[data-role="upload-feedback"]'),U=f==null?void 0:f.querySelector('[data-role="upload-result"]'),R=f==null?void 0:f.querySelector('[data-role="upload-url"]'),ue=f==null?void 0:f.querySelector('[data-role="open-upload"]'),xe=f==null?void 0:f.querySelector('[data-action="copy-upload-url"]'),X=f==null?void 0:f.querySelector("#assetUrl"),_e=f==null?void 0:f.querySelector('[data-action="copy-manual-url"]'),ie=f?{parent:f.parentElement,nextSibling:f.nextSibling}:null,de=null,Se=null;function tt(){var n;return((n=m==null?void 0:m.value)==null?void 0:n.trim())||"avatar"}function nt(){var t;if(!Se||!((t=v==null?void 0:v.store)!=null&&t.getDatum))return null;try{return v.store.getDatum(Se)||null}catch(n){return console.error("Impossible de r\xE9cup\xE9rer le profil actif pour le t\xE9l\xE9versement",n),null}}function it(t){if(!t)return"";try{return new URL(t,window.location.origin).toString()}catch{return String(t)}}function Ne(t,{origin:n="manual",sizeBytes:i}={}){let a=it(t);if(!a)return;let l=tt(),u=l.replace(/"/g,'\\"'),p=!1,d=!1;if(de){let h=de.querySelector(`[name="${u}"]`);h&&h instanceof HTMLInputElement?(h.value!==a&&(h.value=a,h.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0):h&&h instanceof HTMLTextAreaElement&&(h.value!==a&&(h.value=a,h.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0)}let b=nt();if(b&&(b.data||(b.data={}),b.data[l]!==a&&(b.data[l]=a,d=!0)),d){try{e.updateTree({initial:!1,tree_position:"inherit"})}catch(h){console.error("Impossible de rafra\xEEchir le graphique apr\xE8s mise \xE0 jour de l\u2019image",h)}oe()}X&&(X.value=a);let L=p||d;if(n==="upload")if(L){let h=i?` (${Oe(i)})`:"";N(`Image t\xE9l\xE9vers\xE9e${h} et appliqu\xE9e au profil.`,"success"),j("Image appliqu\xE9e au profil \u2705","success")}else{let h=i?` (${Oe(i)})`:"";N(`Image t\xE9l\xE9vers\xE9e${h}. S\xE9lectionnez un profil \xE9ditable pour l\u2019appliquer.`,"info")}else L?(N("Image appliqu\xE9e au profil.","success"),j("Image appliqu\xE9e au profil \u2705","success")):N("S\xE9lectionnez un profil \xE9ditable pour appliquer l\u2019image.","info")}function rt(){var l;let t=tt(),n=nt(),i=((l=n==null?void 0:n.data)==null?void 0:l[t])||"";if(!i){me(),X&&(X.value=""),N("Formats recommand\xE9s : JPG, PNG, WebP.","info");return}let a=at(i,{silent:!0});X&&(X.value=a),N("Image actuelle du profil charg\xE9e.","info")}function pe(){if(!f||!(ie!=null&&ie.parent))return;de&&(de=null),Se=null;let{parent:t,nextSibling:n}=ie;n&&t.contains(n)?t.insertBefore(f,n):t.appendChild(f),f.classList.remove("is-modal-context"),me(),X&&(X.value=""),N("Importez une image ou collez une URL publique. Formats recommand\xE9s : JPG, PNG, WebP.","info")}function Mt(t){if(!f||!t||de===t)return;pe();let n=t.querySelector(".f3-form-buttons");n&&n.parentNode?n.parentNode.insertBefore(f,n):t.appendChild(f),f.classList.add("is-modal-context"),de=t}function qt({cont:t,form_creator:n}){var l;if(!f)return;let i=(l=t==null?void 0:t.querySelector)==null?void 0:l.call(t,"form");if(!i){pe();return}if(!((n==null?void 0:n.editable)!==!1&&!(n!=null&&n.no_edit))){i.contains(f)&&pe();return}Mt(i),Se=(n==null?void 0:n.datum_id)||null,rt()}function wt(){pe()}f&&(ie!=null&&ie.parent)&&f.parentElement!==ie.parent&&pe();let xt=5*1024*1024;function Oe(t){return Number.isFinite(t)?t<1024?`${t} o`:t<1024*1024?`${(t/1024).toFixed(1)} Ko`:`${(t/(1024*1024)).toFixed(2)} Mo`:""}function N(t,n="info"){ne&&(ne.textContent=t,ne.dataset.status=n)}function me(){U&&(U.classList.add("hidden"),U.dataset.url="",R&&(R.textContent=""),ue&&(ue.href="#",ue.classList.add("hidden")))}function at(t,{silent:n=!1}={}){if(!U)return"";let i=it(t);return U.dataset.url=i,R&&(R.textContent=i),ue&&(ue.href=i,ue.classList.remove("hidden")),U.classList.remove("hidden"),X&&(X.value=i),n||N("Image pr\xEAte \xE0 \xEAtre appliqu\xE9e.","info"),i}async function ot(t,{successMessage:n="Copi\xE9 dans le presse-papiers \u2705",errorMessage:i="Impossible de copier."}={}){var a;if(!t){N("Aucune URL \xE0 copier.","error");return}try{if((a=navigator.clipboard)!=null&&a.writeText)await navigator.clipboard.writeText(t);else{let l=document.createElement("textarea");l.value=t,l.setAttribute("readonly",""),l.style.position="absolute",l.style.left="-9999px",document.body.append(l),l.select(),document.execCommand("copy"),l.remove()}j(n,"success"),N(n,"success")}catch(l){console.error(l),j(i,"error"),N(i,"error")}}async function _t(t){if(!t)return;if(me(),!t.type||!t.type.startsWith("image/")){N("Format non pris en charge. S\xE9lectionnez une image (JPEG, PNG, WebP\u2026).","error");return}if(t.size>xt){N(`Fichier trop volumineux (${Oe(t.size)}). Limite 5 Mo.`,"error");return}N("T\xE9l\xE9versement en cours\u2026","saving"),j("T\xE9l\xE9versement de l\u2019image\u2026","saving");let n=new FormData;n.append("file",t,t.name);try{let i=await fetch("/api/uploads",{method:"POST",body:n});if(!i.ok){let p=`Erreur serveur (${i.status})`;try{let d=await i.json();d!=null&&d.message&&(p=d.message)}catch{}throw new Error(p)}let a=await i.json(),l=a==null?void 0:a.url;if(!l)throw new Error("R\xE9ponse du serveur invalide (URL manquante).");let u=at(l);Ne(u,{origin:"upload",sizeBytes:t.size})}catch(i){console.error(i),N(i.message||"\xC9chec du t\xE9l\xE9versement.","error"),j(`T\xE9l\xE9versement \xE9chou\xE9: ${i.message||"Erreur inconnue"}`,"error"),me()}}me(),ne&&N(ne.textContent||"Formats recommand\xE9s : JPG, PNG, WebP.","info");function Nt(t){q.forEach(n=>{let i=n.dataset.orientation===t;n.classList.toggle("active",i)})}function st(){var t,n,i,a,l,u,p;if(k&&(k.value=(n=(t=o.transitionTime)==null?void 0:t.toString())!=null?n:""),x&&(x.value=(a=(i=o.cardXSpacing)==null?void 0:i.toString())!=null?a:""),C&&(C.value=(u=(l=o.cardYSpacing)==null?void 0:l.toString())!=null?u:""),O){let d=(p=o.singleParentEmptyCardLabel)!=null?p:P.singleParentEmptyCardLabel;O.value=d}_&&(_.value=lt(o.ancestryDepth,P.ancestryDepth)),Y&&(Y.value=lt(o.progenyDepth,P.progenyDepth)),F&&(F.checked=o.miniTree!==!1),Nt(o.orientation||P.orientation)}function re(t={},{treePosition:n="inherit",refresh:i=!0}={}){if(o={...o,...t},Pt(e),r&&typeof r.setMiniTree=="function"&&r.setMiniTree(o.miniTree!==!1),i){let a=T;T=!0,st(),T=a}e.updateTree({initial:!1,tree_position:n}),V=null,T||oe()}function Re(t,n){if(!t)return n;let i=Number(t.value);return Number.isFinite(i)?i:n}function lt(t,n){return t===null?"":typeof t=="number"&&Number.isFinite(t)&&t>=0?String(Math.floor(t)):typeof n=="number"&&Number.isFinite(n)&&n>=0?String(Math.floor(n)):""}function ct(t,n){if(!t)return n;if(t.value==="")return null;let i=Number(t.value);return Number.isFinite(i)&&i>=0?Math.floor(i):n}function Ee(t,n){let i=I(t);return n?M.set(i,n.trim()||t):M.has(i)||M.set(i,t),M.get(i)||t}function Ot(t){let n=te(t).map(i=>({value:i,key:I(i)})).filter(i=>!Ce.has(i.key)).map(i=>{let a=Ee(i.value,M.get(i.key));return Ze(i.key,i.value,a)});return Lt(n,M)}function ve(t){var i,a;if(!se)return;if(!t){se.textContent="\u2014";return}let n=(a=(i=v==null?void 0:v.store)==null?void 0:i.getDatum)==null?void 0:a.call(i,t);if(!n){se.textContent="\u2014";return}se.textContent=be(n)}function De({keepSelection:t=!0}={}){var L;if(!D)return;let n=Ae(),i=t?D.value:"";if(D.innerHTML="",!n.length){let h=document.createElement("option");h.value="",h.textContent="Aucune personne disponible",D.append(h),D.disabled=!0,ve(null);return}let a=document.createDocumentFragment();n.forEach(h=>{if(!h||!h.id)return;let w=document.createElement("option");w.value=h.id,w.textContent=be(h),a.append(w)}),D.append(a),D.disabled=!1;let l=new Set(n.map(h=>h.id)),u=[];t&&i&&l.has(i)&&u.push(i);let p=typeof o.mainId=="string"?o.mainId:"";p&&l.has(p)&&u.push(p);let d=e.store&&typeof e.store.getMainId=="function"?e.store.getMainId():"";d&&l.has(d)&&u.push(d),(L=n[0])!=null&&L.id&&u.push(n[0].id);let b=u.find(Boolean)||"";b?D.value=b:D.selectedIndex=0,ve(D.value||null)}function Rt({scheduleSaveIfChanged:t=!1}={}){var p;if(!e.store||typeof e.store.getMainId!="function")return;let n=e.store.getMainId(),i=Ae(),a=new Set(i.map(d=>d&&d.id).filter(Boolean)),l=typeof o.mainId=="string"&&o.mainId.trim()?o.mainId.trim():null,u=l;if(u&&!a.has(u)&&(u=null),!u&&n&&a.has(n)&&(u=n),!u&&i.length){let d=((p=i[0])==null?void 0:p.id)||null;d&&a.has(d)&&(u=d)}u!==l&&(o={...o,mainId:u},V=null,t&&!T&&oe()),D&&(u&&![...D.options].some(d=>d.value===u)&&De({keepSelection:!1}),!u&&!D.options.length&&De({keepSelection:!1}),u&&(D.value=u,D.disabled=!1)),ve(u||null)}function $t(t,{openEditor:n=!0,suppressSave:i=!1}={}){var p,d;if(!t)return;if(!Ae().some(b=>b.id===t)){De({keepSelection:!1});return}let l=o.mainId!==t;l&&(o={...o,mainId:t}),l&&!i&&(V=null,T||oe());let u=e.store&&typeof e.store.getMainId=="function"?e.store.getMainId():null;if(e&&typeof e.updateMainId=="function"&&u!==t&&(e.updateMainId(t),e.updateTree({initial:!1,tree_position:"main_to_middle"})),D&&D.value!==t&&(D.value=t,D.disabled=!1),ve(t),n&&v){let b=(d=(p=v.store)==null?void 0:p.getDatum)==null?void 0:d.call(p,t);b&&v.open(b)}}D&&D.addEventListener("change",t=>{let{value:n}=t.target;n&&$t(n)});function he(t){var n;return(n=window.CSS)!=null&&n.escape?window.CSS.escape(t):t.replace(/[^a-zA-Z0-9_-]/g,i=>`\\${i}`)}function ut(t){if(t.querySelector(".remove-field"))return;let n=document.createElement("button");n.type="button",n.className="remove-field",n.textContent="Retirer",n.addEventListener("click",()=>{t.remove(),Ye()}),t.append(n)}function Yt(t){S.forEach(n=>{let i=n.querySelector(".field-list");if(!i)return;let a=`[data-field-key="${he(t)}"]`,l=i.querySelector(a);if(l)if(l.dataset.custom==="true")l.remove();else{let u=$.get(n.dataset.displayRow),p=u==null?void 0:u.get(t),d=l.querySelector('input[type="checkbox"]');d&&typeof p=="boolean"&&(d.checked=p)}})}function zt(t){if(!o.cardDisplay)return[];let n=I(t),i=[];return o.cardDisplay.forEach((a,l)=>{a.some(u=>I(u)===n)&&i.push(String(l+1))}),i}function jt(){Array.isArray(o.editableFields)&&o.editableFields.forEach(t=>{let n=I(t);if(We.has(n)||n===kt||!n)return;let i=Ee(t,M.get(n)),a=`[data-field-key="${he(n)}"]`;s!=null&&s.querySelector(a)||$e({value:t,label:i,checked:!0,removable:!0,selectRows:zt(t)})})}function Bt(){if(!s)return;let t=new Set((o.editableFields||[]).map(I));s.querySelectorAll('input[type="checkbox"]').forEach(n=>{let i=I(n.value);n.checked=t.has(i)})}function Xt(){S.forEach((t,n)=>{let i=o.cardDisplay&&o.cardDisplay[n]||[],a=new Set(i.map(I));t.querySelectorAll('input[type="checkbox"]').forEach(l=>{let u=I(l.value);l.checked=a.has(u)})})}function Gt(t,{value:n,label:i,defaultChecked:a=!1,removable:l=!1}){let u=t.querySelector(".field-list");if(!u)return{item:null,isNew:!1};let p=I(n);if(Ce.has(p))return{item:null,isNew:!1};let d=`[data-field-key="${he(p)}"]`,b=Ee(n,i),L=u.querySelector(d);if(L){let Q=L.querySelector("label span");return Q&&(Q.textContent=b),l&&(L.dataset.custom="true",ut(L)),{item:L,isNew:!1}}L=document.createElement("div"),L.className="display-item",L.dataset.fieldKey=p,l&&(L.dataset.custom="true");let h=document.createElement("label"),w=document.createElement("input");w.type="checkbox",w.value=n,w.checked=a;let z=document.createElement("span");return z.textContent=b,h.append(w,z),L.append(h),l&&ut(L),u.append(L),{item:L,isNew:!0}}function $e({value:t,label:n,checked:i=!0,removable:a=!1,selectRows:l=[]}){if(!s)return;let u=I(t);if(Ce.has(u))return;let p=Ee(t,n),d=`[data-field-key="${he(u)}"]`,b=s.querySelector(d),L=!b;if(b){let w=b.querySelector('input[type="checkbox"]');w&&typeof i=="boolean"&&(w.checked=i);let z=b.querySelector("label span");z&&(z.textContent=p),a&&(b.dataset.custom="true")}else{b=document.createElement("div"),b.className="editable-item",b.dataset.fieldKey=u,a&&(b.dataset.custom="true");let w=document.createElement("label"),z=document.createElement("input");z.type="checkbox",z.value=t,z.checked=i;let Q=document.createElement("span");if(Q.textContent=p,w.append(z,Q),b.append(w),a){let ae=document.createElement("button");ae.type="button",ae.className="remove-field",ae.textContent="Retirer",ae.addEventListener("click",()=>{b.remove(),Yt(u),Ie()}),b.append(ae)}s.append(b)}let h=new Set((l||[]).map(String));S.forEach(w=>{let z=w.dataset.displayRow,Q=$.get(z),ae=Q==null?void 0:Q.get(u),Wt=ae!==void 0?ae:h.has(z),Zt=a,{item:mt,isNew:Qt}=Gt(w,{value:t,label:p,defaultChecked:Wt,removable:Zt});if(mt&&!Qt&&h.has(z)){let ht=mt.querySelector('input[type="checkbox"]');ht&&(ht.checked=!0)}})}function dt(t){return t?[...t.querySelectorAll('input[type="checkbox"]')].filter(n=>n.checked).map(n=>n.value):[]}function ft(t=[],n=[]){return t.length!==n.length?!1:t.every((i,a)=>I(i)===I(n[a]))}function Ut(t=[],n=[]){return t.length!==n.length?!1:t.every((i,a)=>ft(i,n[a]))}function Ht(t){S.forEach(n=>{n.querySelectorAll(".display-item").forEach(a=>{let l=a.dataset.fieldKey,u=a.querySelector('input[type="checkbox"]'),p=t.has(l);a.classList.toggle("is-disabled",!p),u&&(u.disabled=!p,!p&&u.checked&&(u.checked=!1))})})}function Ye({suppressSave:t=!1}={}){let n=y.get("1"),i=y.get("2"),a=te(dt(n)),l=te(dt(i)),u=a[0]||(ee.length?ee[0]:fe[0]||"first name"),d=[a.length?a:[u],l];r.setCardDisplay(d),e.updateTree({initial:!1,tree_position:"inherit"}),!Ut(o.cardDisplay,d)&&(o={...o,cardDisplay:d.map(L=>[...L])},t||(V=null,T||oe()))}function Ie({suppressSave:t=!1}={}){if(!v||!s)return;let n=[...s.querySelectorAll('input[type="checkbox"]')].filter(d=>d.checked).map(d=>d.value),i=n.length?n:o.editableFields.length?[...o.editableFields]:["first name"];if(i=Me(te(i)),!i.length){let d=fe[0]||"first name";if(i=[d],s){let b=I(d),L=`[data-field-key="${he(b)}"] input[type="checkbox"]`,h=s.querySelector(L);h&&(h.checked=!0)}}ee=Me([...i]);let a=Ot(i);v.setFields(a);let l=new Set(i.map(I));Ht(l),!ft(o.editableFields,i)&&(o={...o,editableFields:[...i]},t||(V=null,T||oe())),Ye({suppressSave:t});let p=v.store.getMainDatum();p&&v.open(p)}function Kt(){let t=prompt("Nom du champ (cl\xE9 dans vos donn\xE9es) ?");if(!t)return null;let n=t.trim();if(!n)return null;let i=I(n),a=M.get(i)||n,l=prompt("Libell\xE9 affich\xE9 pour ce champ ?",a),u=(l!=null?l:a).trim()||n;return{value:n,label:u,key:i}}function Vt({selectRows:t=[]}={}){let n=Kt();if(!n)return;let{value:i,label:a,key:l}=n,u=Fe.some(p=>I(p.value)===l);$e({value:i,label:a,checked:!0,removable:!u,selectRows:t}),Ie()}Fe.forEach(t=>{Ce.has(I(t.value))||$e({value:t.value,label:t.label,checked:t.checked!==!1,removable:!1})}),s==null||s.addEventListener("change",t=>{t.target.matches('input[type="checkbox"]')&&Ie()}),g==null||g.addEventListener("click",()=>Vt()),S.forEach(t=>{t.addEventListener("change",n=>{n.target.matches('input[type="checkbox"]')&&Ye()})}),m==null||m.addEventListener("change",()=>{r.setCardImageField(m.value),e.updateTree({initial:!1,tree_position:"inherit"}),rt()}),E==null||E.addEventListener("change",()=>{r.setStyle(E.value),e.updateTree({initial:!1,tree_position:"inherit"})}),k==null||k.addEventListener("change",()=>{var a;if(T)return;let t=(a=o.transitionTime)!=null?a:P.transitionTime,n=Re(k,t),i=Math.max(0,n);i!==o.transitionTime&&re({transitionTime:i})}),C==null||C.addEventListener("change",()=>{var a;if(T)return;let t=(a=o.cardYSpacing)!=null?a:P.cardYSpacing,n=Re(C,t),i=n>0?n:t;i!==o.cardYSpacing&&re({cardYSpacing:i})}),x==null||x.addEventListener("change",()=>{var a;if(T)return;let t=(a=o.cardXSpacing)!=null?a:P.cardXSpacing,n=Re(x,t),i=n>0?n:t;i!==o.cardXSpacing&&re({cardXSpacing:i})}),_==null||_.addEventListener("change",()=>{var i,a;if(T)return;let t=(a=(i=o.ancestryDepth)!=null?i:P.ancestryDepth)!=null?a:null,n=ct(_,t);n!==o.ancestryDepth&&re({ancestryDepth:n},{treePosition:"main_to_middle"})}),Y==null||Y.addEventListener("change",()=>{var i,a;if(T)return;let t=(a=(i=o.progenyDepth)!=null?i:P.progenyDepth)!=null?a:null,n=ct(Y,t);n!==o.progenyDepth&&re({progenyDepth:n},{treePosition:"main_to_middle"})}),F==null||F.addEventListener("change",()=>{if(T)return;let t=F.checked,n=o.miniTree!==!1;t!==n&&re({miniTree:t})}),O==null||O.addEventListener("change",()=>{if(T)return;let t=(O.value||"").trim()||P.singleParentEmptyCardLabel;t!==o.singleParentEmptyCardLabel&&re({singleParentEmptyCardLabel:t,singleParentEmptyCard:!0})}),q==null||q.forEach(t=>{t.addEventListener("click",()=>{let i=t.dataset.orientation==="horizontal"?"horizontal":"vertical";o.orientation!==i&&re({orientation:i},{treePosition:"fit"})})});function pt(){let t={};n("width",H),n("height",B),n("img_w",G),n("img_h",K),n("img_x",J),n("img_y",W),r.resetCardDim(),Object.keys(t).length>0&&r.setCardDim(t),e.updateTree({initial:!1,tree_position:"inherit"});function n(i,a){if(!a)return;let l=Number(a.value);Number.isFinite(l)&&(t[i]=l)}}[H,B,G,K,J,W].forEach(t=>t==null?void 0:t.addEventListener("change",pt)),le==null||le.addEventListener("click",()=>{[[H,240],[B,150],[G,80],[K,80],[J,16],[W,16]].forEach(([t,n])=>{t&&(t.value=n)}),pt()}),ce==null||ce.addEventListener("change",t=>{let n=t.target.files&&t.target.files[0];n&&_t(n),t.target.value=""}),xe==null||xe.addEventListener("click",()=>{var n,i;let t=((n=U==null?void 0:U.dataset)==null?void 0:n.url)||((i=R==null?void 0:R.textContent)==null?void 0:i.trim());t&&Ne(t,{origin:"manual"}),ot(t,{successMessage:"URL du t\xE9l\xE9versement copi\xE9e \u2705",errorMessage:"Impossible de copier l\u2019URL du t\xE9l\xE9versement."})}),_e==null||_e.addEventListener("click",()=>{var n;let t=(n=X==null?void 0:X.value)==null?void 0:n.trim();t&&Ne(t,{origin:"manual"}),ot(t,{successMessage:"Image appliqu\xE9e et URL copi\xE9e \u2705",errorMessage:"Impossible de copier ce lien."})});let Jt=T;return T=!0,jt(),st(),Bt(),Xt(),T=Jt,Ie({suppressSave:!0}),{refreshMainProfileOptions:De,syncMainProfileSelection:Rt,handleFormCreation:qt,teardown:wt}}function Me(e=[]){return e.filter(r=>I(r)!==kt)}async function Tt(){Qe(),v=null,V=null;try{let e=await mn();hn(e)}catch(e){console.error(e),j(`Erreur: ${e.message}`,"error")}}je==null||je.addEventListener("click",()=>{let e=we();e&&et(e,{immediate:!0})});Be==null||Be.addEventListener("click",()=>{Tt()});function gn(){let e=we();return e?JSON.stringify(e)!==V:!1}window.addEventListener("beforeunload",e=>{gn()&&(e.preventDefault(),e.returnValue="")});Tt();
//# sourceMappingURL=builder.bundle.js.map
