import*as vt from"/lib/family-tree.esm.js";var ze=document.getElementById("status"),Ye=document.getElementById("save"),je=document.getElementById("reload"),T=document.getElementById("controlPanel"),gt="#FamilyChart",Xe=document.querySelector('[data-role="builder-search"]'),Ge=document.querySelector('[data-role="builder-search-target"]'),bt=document.querySelector('[data-role="builder-search-empty"]'),St=document.getElementById("builderSearchLabel"),Et=document.getElementById("builderSearchHint"),be=document.querySelector('[data-action="toggle-panel"]'),Ke="family-tree:builder:controlsCollapsed",Le=[],Ve=!1;function Je(e){if(Xe){if(!e){delete Xe.dataset.state;return}Xe.dataset.state=e}}function C(e){return e==null?"":String(e).trim().toLowerCase()}function ie(e){if(!Array.isArray(e))return[];let r=new Set,c=[];return e.forEach(s=>{if(typeof s!="string")return;let y=s.trim();if(!y)return;let g=C(y);r.has(g)||(r.add(g),c.push(y))}),c}function Dt(){try{return window.localStorage}catch{return null}}function en(){let e=Dt();if(!e)return!1;try{return e.getItem(Ke)==="1"}catch{return!1}}function tn(e){let r=Dt();if(r)try{e?r.setItem(Ke,"1"):r.removeItem(Ke)}catch{}}function It(e){e?document.body.classList.add("controls-collapsed"):document.body.classList.remove("controls-collapsed"),be&&(be.setAttribute("aria-expanded",String(!e)),be.textContent=e?"Afficher le panneau":"Replier le panneau")}function nn(e){let r=typeof e=="boolean"?e:!document.body.classList.contains("controls-collapsed");It(r),tn(r)}var rn=en();It(rn);be&&be.addEventListener("click",()=>{nn()});var an=new Map([["first name","Pr\xE9nom"],["last name","Nom"],["birthday","Date de naissance"],["death","Date de D\xE9c\xE8s"],["gender","Genre"],["avatar","Photo de profil"],["photo","Photo"],["picture","Portrait"],["bio","Biographie"],["occupation","Profession"],["location","Lieu de r\xE9sidence"],["birthplace","Lieu de naissance"],["deathplace","Lieu de d\xE9c\xE8s"],["union date","Date d'union"],["union place","Lieu d'union"],["union paragraph","Paragraphe d'union"],["notes","Notes"],["nickname","Surnom"],["maiden name","Nom de naissance"]]),Ct={1:[{value:"first name",checked:!0},{value:"last name",checked:!0},{value:"birthday",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}],2:[{value:"birthday",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!1},{value:"avatar",checked:!1},{value:"gender",checked:!1}]},Pe=[{value:"first name",label:"Pr\xE9nom",checked:!0},{value:"last name",label:"Nom",checked:!0},{value:"maiden name",label:"Nom de naissance",checked:!1},{value:"birthday",label:"Date de naissance",checked:!0},{value:"death",label:"Date de D\xE9c\xE8s",checked:!1},{value:"avatar",label:"Avatar",checked:!0},{value:"gender",label:"Genre",checked:!0},{value:"birthplace",label:"Lieu de naissance",checked:!1},{value:"deathplace",label:"Lieu de D\xE9c\xE8s",checked:!1},{value:"bio",label:"Biographie",checked:!1}],qe=[["first name","last name"],["birthday"]],kt="union paragraph",pe=Me(ie(Pe.filter(e=>e.checked!==!1).map(e=>e.value))),on=new Set(["bio","notes","biographie","description","union paragraph"]),Ze=new Set(["union date","union place"]);function Qe(e,r,c){if(Ze.has(e))return{id:r,label:c,type:"rel_reference",rel_type:"spouse",getRelLabel:Se};let s=on.has(e)?"textarea":"text";return{id:r,label:c,type:s}}function Lt(e,r){let c=s=>r?typeof r.get=="function"||r instanceof Map?r.get(s)||s:r[s]||s:s;return Ze.forEach(s=>{if(e.some(b=>C(b.id)===s))return;let g=c(s);e.push(Qe(s,s,g))}),e}function We(){let e=new Map(an);return Pe.forEach(r=>{e.set(C(r.value),r.label)}),Object.values(Ct).forEach(r=>{r.forEach(c=>{c.label&&e.set(C(c.value),c.label)})}),e}function sn(e,r=We()){let c=r||We(),s=ie(e).map(y=>{let g=C(y),b=c.get(g)||y;return Qe(g,y,b)});return Lt(s,c)}function Ue(e){return typeof e=="string"?e.trim():""}function Te(){if(!v||!v.store||typeof v.store.getData!="function")return[];let e=v.store.getData();return Array.isArray(e)?e:[]}function Se(e){if(!e)return"Profil sans nom";let r=e.data||{},c=Ue(r["first name"]),s=Ue(r["last name"]),y=c||s?[c,s].filter(Boolean).join(" ").trim():`Profil ${e.id}`,g=Ue(r.birthday);return g?`${y} (${g})`:y}function ln(e){if(!e||typeof e.id!="string"||!e.id.trim())return null;let r=Se(e),c=new Set,s=[],y=new Set,g=m=>{if(typeof m!="string")return;let E=m.trim();E&&c.add(E)},b=m=>{if(typeof m!="string")return;let E=m.trim();!E||y.has(E)||(y.add(E),s.push(E))};g(r),g(String(e.id));let q=e.data&&typeof e.data=="object"?e.data:{};Object.entries(q).forEach(([m,E])=>{if(typeof E!="string")return;let k=E.trim();if(!k)return;g(k);let I=C(m);if(I==="birthday"){b(k);return}if(I==="death"){b(`\u271D ${k}`);return}if(I==="maiden name"){b(`(${k})`);return}if(I==="occupation"){b(k);return}(I==="location"||I==="residence"||I==="birthplace"||I==="deathplace")&&b(k)});let R=Array.from(c).map(m=>m.replace(/\s+/g," ").trim()).filter(Boolean).join(" | ");return{label:r,value:e.id,searchText:R,optionHtml:m=>{let E=s.length?`<small>${s.join(" \xB7 ")}</small>`:"";return`<div>${m.label_html||m.label}${E?`<div class="f3-autocomplete-meta">${E}</div>`:""}</div>`}}}function cn(e){if(!Array.isArray(e))return[];let r=[],c=new Set;return e.forEach(s=>{if(!s||!s.id||c.has(s.id))return;let y=ln(s);y&&(r.push(y),c.add(s.id))}),r.sort((s,y)=>s.label.localeCompare(y.label,"fr",{sensitivity:"base"})),r}function un(e){if(!e||!Ge)return Je("empty"),null;bt&&bt.classList.remove("hidden"),e.setPersonDropdown(s=>Se(s),{cont:Ge,placeholder:"Rechercher (nom, date, lieu, etc.)",onSelect:s=>{var g,b;if(!s||!v)return;let y=(b=(g=v.store)==null?void 0:g.getDatum)==null?void 0:b.call(g,s);y&&v.open(y)}});let r=Ge.querySelector("input");r&&(r.setAttribute("id","builderSearchInput"),St&&r.setAttribute("aria-labelledby",St.id),Et&&r.setAttribute("aria-describedby",Et.id),r.setAttribute("autocomplete","off"),r.setAttribute("spellcheck","false"));function c(){if(!e.personSearch)return;let s=Te();Le=cn(s),e.personSearch.setOptionsGetter(()=>Le),Je(Le.length?"ready":"empty"),Ve=!0}return c(),{refreshSearchOptions:c}}var A=Object.freeze({transitionTime:200,cardXSpacing:240,cardYSpacing:140,orientation:"vertical",showSiblingsOfMain:!0,singleParentEmptyCard:!0,singleParentEmptyCardLabel:"Inconnu",ancestryDepth:4,progenyDepth:4,miniTree:!0,duplicateBranchToggle:!0,editableFields:[...pe],cardDisplay:qe.map(e=>[...e]),mainId:null});function dn(e){let c=(Array.isArray(e)?e:[]).slice(0,2).map(s=>ie(Array.isArray(s)?s:[]));for(;c.length<2;)c.push([]);return c}function Fe(e,r=qe){var y,g,b,q,R,m,E,k,I,x,O,_,B,P;let c=e;return e&&!Array.isArray(e)&&typeof e=="object"&&(c=[(E=(m=(R=(q=(b=(g=(y=e[0])!=null?y:e[0])!=null?g:e.row1)!=null?b:e.row_1)!=null?q:e.ligne1)!=null?R:e.line1)!=null?m:e.first)!=null?E:[],(P=(B=(_=(O=(x=(I=(k=e[1])!=null?k:e[1])!=null?I:e.row2)!=null?x:e.row_2)!=null?O:e.ligne2)!=null?_:e.line2)!=null?B:e.second)!=null?P:[]]),Array.isArray(c)?dn(c).map((F,G)=>{if(F.length)return[...F];let j=r[G];return Array.isArray(j)?[...j]:[]}):r.map(F=>[...F])}function Tt(e={}){let r={transitionTime:A.transitionTime,cardXSpacing:A.cardXSpacing,cardYSpacing:A.cardYSpacing,orientation:A.orientation,showSiblingsOfMain:A.showSiblingsOfMain,singleParentEmptyCard:A.singleParentEmptyCard,singleParentEmptyCardLabel:A.singleParentEmptyCardLabel,ancestryDepth:A.ancestryDepth,progenyDepth:A.progenyDepth,miniTree:A.miniTree,duplicateBranchToggle:A.duplicateBranchToggle,editableFields:[...pe],cardDisplay:Fe(qe),mainId:A.mainId};if(typeof e.transitionTime=="number"&&Number.isFinite(e.transitionTime)&&(r.transitionTime=e.transitionTime),typeof e.cardXSpacing=="number"&&Number.isFinite(e.cardXSpacing)&&(r.cardXSpacing=e.cardXSpacing),typeof e.cardYSpacing=="number"&&Number.isFinite(e.cardYSpacing)&&(r.cardYSpacing=e.cardYSpacing),(e.orientation==="horizontal"||e.orientation==="vertical")&&(r.orientation=e.orientation),typeof e.showSiblingsOfMain=="boolean"&&(r.showSiblingsOfMain=e.showSiblingsOfMain),typeof e.singleParentEmptyCard=="boolean"&&(r.singleParentEmptyCard=e.singleParentEmptyCard),typeof e.singleParentEmptyCardLabel=="string"){let c=e.singleParentEmptyCardLabel.trim();c&&(r.singleParentEmptyCardLabel=c)}if(e.ancestryDepth===null?r.ancestryDepth=null:typeof e.ancestryDepth=="number"&&Number.isFinite(e.ancestryDepth)&&e.ancestryDepth>=0&&(r.ancestryDepth=Math.floor(e.ancestryDepth)),e.progenyDepth===null?r.progenyDepth=null:typeof e.progenyDepth=="number"&&Number.isFinite(e.progenyDepth)&&e.progenyDepth>=0&&(r.progenyDepth=Math.floor(e.progenyDepth)),typeof e.miniTree=="boolean"&&(r.miniTree=e.miniTree),typeof e.duplicateBranchToggle=="boolean"&&(r.duplicateBranchToggle=e.duplicateBranchToggle),Array.isArray(e.editableFields)){let c=ie(e.editableFields);c.length&&(r.editableFields=c)}if((Array.isArray(e.cardDisplay)||e.cardDisplay&&typeof e.cardDisplay=="object")&&(r.cardDisplay=Fe(e.cardDisplay,[[],[]])),typeof e.mainId=="string"){let c=e.mainId.trim();c&&(r.mainId=c)}return r}var v=null,Ae=null,V=null,He=!1,ke=null,o=Tt(),M=!1,ne=[...pe],ge=null;function Y(e,r="info"){ze&&(ze.textContent=e,ze.dataset.status=r)}function fn(e){if(Array.isArray(e))return{data:e,config:{}};if(e&&typeof e=="object"){if(Array.isArray(e.data)){let r=e.config||e.settings||e.meta||{};return{data:e.data,config:r}}if(Array.isArray(e.tree)){let r=e.config||e.settings||e.meta||{};return{data:e.tree,config:r}}}return{data:[],config:{}}}function pn(e={}){var B,P,F,G,j,U,K,W,Z,ce,ue,Q,D,le,f,de,re,H,J;if(!e||typeof e!="object")return{};let r={},c=(B=e.transitionTime)!=null?B:e.transition_time;typeof c=="number"&&Number.isFinite(c)&&(r.transitionTime=c);let s=(F=(P=e.cardXSpacing)!=null?P:e.card_x_spacing)!=null?F:e.node_separation;typeof s=="number"&&Number.isFinite(s)&&(r.cardXSpacing=s);let y=(j=(G=e.cardYSpacing)!=null?G:e.card_y_spacing)!=null?j:e.level_separation;typeof y=="number"&&Number.isFinite(y)&&(r.cardYSpacing=y);let g=e.orientation;g==="horizontal"||g==="vertical"?r.orientation=g:typeof e.is_horizontal=="boolean"&&(r.orientation=e.is_horizontal?"horizontal":"vertical");let b=(U=e.showSiblingsOfMain)!=null?U:e.show_siblings_of_main;typeof b=="boolean"&&(r.showSiblingsOfMain=b);let q=(K=e.singleParentEmptyCard)!=null?K:e.single_parent_empty_card;typeof q=="boolean"&&(r.singleParentEmptyCard=q);let R=(W=e.singleParentEmptyCardLabel)!=null?W:e.single_parent_empty_card_label;typeof R=="string"&&R.trim().length>0&&(r.singleParentEmptyCardLabel=R.trim());let m=(ue=(ce=(Z=e.editableFields)!=null?Z:e.edit_fields)!=null?ce:e.fields)!=null?ue:e.editable_fields;Array.isArray(m)&&(r.editableFields=ie(m));let E=(Q=e.cardDisplay)!=null?Q:e.card_display;(Array.isArray(E)||E&&typeof E=="object")&&(r.cardDisplay=Fe(E,[[],[]]));let k=(f=(le=(D=e.mainId)!=null?D:e.main_id)!=null?le:e.mainPersonId)!=null?f:e.main_person_id;typeof k=="string"&&k.trim().length>0&&(r.mainId=k.trim());let I=(de=e.ancestryDepth)!=null?de:e.ancestry_depth;if(I===null)r.ancestryDepth=null;else if(I!==void 0){let $=Number(I);Number.isFinite($)&&$>=0&&(r.ancestryDepth=Math.floor($))}let x=(re=e.progenyDepth)!=null?re:e.progeny_depth;if(x===null)r.progenyDepth=null;else if(x!==void 0){let $=Number(x);Number.isFinite($)&&$>=0&&(r.progenyDepth=Math.floor($))}let O=(H=e.miniTree)!=null?H:e.mini_tree;typeof O=="boolean"&&(r.miniTree=O);let _=(J=e.duplicateBranchToggle)!=null?J:e.duplicate_branch_toggle;return typeof _=="boolean"&&(r.duplicateBranchToggle=_),r}function At(e){e.setTransitionTime(o.transitionTime),e.setCardXSpacing(o.cardXSpacing),e.setCardYSpacing(o.cardYSpacing),e.setShowSiblingsOfMain(o.showSiblingsOfMain),o.orientation==="horizontal"?e.setOrientationHorizontal():e.setOrientationVertical(),e.setSingleParentEmptyCard(o.singleParentEmptyCard,{label:o.singleParentEmptyCardLabel}),typeof o.ancestryDepth=="number"&&Number.isFinite(o.ancestryDepth)?e.setAncestryDepth(o.ancestryDepth):e.setAncestryDepth(null),typeof o.progenyDepth=="number"&&Number.isFinite(o.progenyDepth)?e.setProgenyDepth(o.progenyDepth):e.setProgenyDepth(null),e.setDuplicateBranchToggle(o.duplicateBranchToggle!==!1)}async function mn(){Y("Chargement des donn\xE9es\u2026");let e=await fetch("/api/tree",{cache:"no-store"});if(!e.ok)throw new Error(`\xC9chec du chargement (${e.status})`);return e.json()}function et(){Ae&&(clearTimeout(Ae),Ae=null)}async function tt(e,{immediate:r=!1}={}){if(!e)return;et();let c=Pt(e);if(He){ke={snapshot:c,immediate:r},Y("Sauvegarde d\xE9j\xE0 en cours\u2026","saving");return}try{He=!0,Y(r?"Enregistrement en cours\u2026":"Sauvegarde automatique\u2026","saving");let s=await fetch("/api/tree",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(c,null,2)});if(!s.ok&&s.status!==204)throw new Error(`Serveur a retourn\xE9 ${s.status}`);V=JSON.stringify(c),Y("Modifications enregistr\xE9es \u2705","success")}catch(s){console.error(s),Y(`Erreur d'enregistrement: ${s.message}`,"error")}finally{if(He=!1,ke){let s=ke;ke=null,await tt(s.snapshot,{immediate:s.immediate})}}}function Pt(e){return typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e))}function we(){if(!v)return null;let e=v.exportData();return e?{data:e,config:Pt(o)}:null}function se(){et(),Y("Modification d\xE9tect\xE9e\u2026 sauvegarde automatique imminente","saving"),Ae=setTimeout(()=>{let e=we();e&&tt(e)},1500)}function hn(e){let r=document.querySelector(gt);if(!r)throw new Error("Conteneur du graphique introuvable");r.innerHTML="",Ve=!1,Le=[],Je("loading"),typeof ge=="function"&&(ge(),ge=null);let{data:c,config:s}=fn(e);o=Tt(pn(s)),ne=[...o.editableFields],ne.length||(ne=[...pe]),ne=Me(ne);let y=[...ne],g=sn(y),b=vt.createChart(gt,c);At(b);let q=o.cardDisplay&&o.cardDisplay.length?o.cardDisplay.map(P=>[...P]):Fe(qe),R=b.setCardHtml().setCardDisplay(q).setCardImageField("avatar").setMiniTree(o.miniTree!==!1),m=null,E=null,k=Array.isArray(c)?c:[];v=b.editTree().setFields(g).setEditFirst(!0).setCardClickOpen(R).setOnChange(()=>{V=null,m&&(m.refreshMainProfileOptions({keepSelection:!0}),m.syncMainProfileSelection({scheduleSaveIfChanged:!1})),E&&E.refreshSearchOptions(),se()}),m=yn({chart:b,card:R})||{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}},E=un(b),typeof m.teardown=="function"?ge=m.teardown:ge=null,typeof m.handleFormCreation=="function"&&v.setOnFormCreation(m.handleFormCreation);let I=B(k,b);I&&b.updateMainId(I),b.setAfterUpdate(()=>{if(!b.store||typeof b.store.getMainId!="function")return;!b.store.getMainId()&&o.mainId&&(o={...o,mainId:null},V=null,M||se()),m&&m.syncMainProfileSelection({scheduleSaveIfChanged:!1}),!Ve&&E&&E.refreshSearchOptions()}),m&&(m.refreshMainProfileOptions({keepSelection:!1}),m.syncMainProfileSelection({scheduleSaveIfChanged:!1})),b.updateTree({initial:!0,tree_position:"fit"});let x=b.getMainDatum();x&&v.open(x);let O=we();V=O?JSON.stringify(O):null;let _=k.length;Y(_>0?`\xC9diteur pr\xEAt \u2705 \u2013 ${_} personne(s) charg\xE9e(s)`:"Fichier de donn\xE9es vide",_>0?"success":"error");function B(P,F){var W;if(!Array.isArray(P)||P.length===0)return o={...o,mainId:null},null;let G=new Set(P.map(Z=>Z&&Z.id).filter(Boolean)),j=typeof o.mainId=="string"?o.mainId.trim():"";if(j&&G.has(j))return j;let U=F!=null&&F.store&&typeof F.store.getMainId=="function"?F.store.getMainId():null;if(U&&G.has(U))return o.mainId!==U&&(o={...o,mainId:U}),U;let K=((W=P[0])==null?void 0:W.id)||null;return K&&o.mainId!==K&&(o={...o,mainId:K}),K}}function yn({chart:e,card:r}){if(!T)return{refreshMainProfileOptions:()=>{},syncMainProfileSelection:()=>{},handleFormCreation:()=>{},teardown:()=>{}};let c=T.querySelector('[data-role="editable-fields"]'),s=c==null?void 0:c.querySelector(".editable-list"),y=c==null?void 0:c.querySelector('[data-action="add-editable"]'),g=[...T.querySelectorAll("[data-display-row]")],b=new Map(g.map(t=>[t.dataset.displayRow,t])),q=We(),R=new Map(Object.entries(Ct).map(([t,n])=>[t,new Map(n.map(i=>[C(i.value),i.checked]))])),m=T.querySelector("#imageField"),E=T.querySelector("#cardStyle"),k=T.querySelector("#transitionInput"),I=T.querySelector("#cardYSpacing"),x=T.querySelector("#cardXSpacing"),O=T.querySelector("#emptyLabel"),_=T.querySelector("#ancestryDepth"),B=T.querySelector("#progenyDepth"),P=T.querySelector("#miniTreeToggle"),F=T.querySelector("#duplicateToggle"),G=T.querySelectorAll("[data-orientation]"),j=T.querySelector("#cardWidth"),U=T.querySelector("#cardHeight"),K=T.querySelector("#imgWidth"),W=T.querySelector("#imgHeight"),Z=T.querySelector("#imgX"),ce=T.querySelector("#imgY"),ue=T.querySelector("#resetDimensions"),Q=T.querySelector('[data-role="main-profile"]'),D=Q==null?void 0:Q.querySelector("#mainProfileSelect"),le=Q==null?void 0:Q.querySelector('[data-role="main-profile-name"]');D&&(D.disabled=!0);let f=T.querySelector('[data-role="image-uploader"]'),de=f==null?void 0:f.querySelector("#assetUpload"),re=f==null?void 0:f.querySelector('[data-role="upload-feedback"]'),H=f==null?void 0:f.querySelector('[data-role="upload-result"]'),J=f==null?void 0:f.querySelector('[data-role="upload-url"]'),$=f==null?void 0:f.querySelector('[data-role="open-upload"]'),xe=f==null?void 0:f.querySelector('[data-action="copy-upload-url"]'),X=f==null?void 0:f.querySelector("#assetUrl"),_e=f==null?void 0:f.querySelector('[data-action="copy-manual-url"]'),ae=f?{parent:f.parentElement,nextSibling:f.nextSibling}:null,fe=null,Ee=null;function nt(){var n;return((n=m==null?void 0:m.value)==null?void 0:n.trim())||"avatar"}function it(){var t;if(!Ee||!((t=v==null?void 0:v.store)!=null&&t.getDatum))return null;try{return v.store.getDatum(Ee)||null}catch(n){return console.error("Impossible de r\xE9cup\xE9rer le profil actif pour le t\xE9l\xE9versement",n),null}}function rt(t){if(!t)return"";try{return new URL(t,window.location.origin).toString()}catch{return String(t)}}function Ne(t,{origin:n="manual",sizeBytes:i}={}){let a=rt(t);if(!a)return;let l=nt(),u=l.replace(/"/g,'\\"'),p=!1,d=!1;if(fe){let h=fe.querySelector(`[name="${u}"]`);h&&h instanceof HTMLInputElement?(h.value!==a&&(h.value=a,h.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0):h&&h instanceof HTMLTextAreaElement&&(h.value!==a&&(h.value=a,h.dispatchEvent(new Event("input",{bubbles:!0}))),p=!0)}let S=it();if(S&&(S.data||(S.data={}),S.data[l]!==a&&(S.data[l]=a,d=!0)),d){try{e.updateTree({initial:!1,tree_position:"inherit"})}catch(h){console.error("Impossible de rafra\xEEchir le graphique apr\xE8s mise \xE0 jour de l\u2019image",h)}se()}X&&(X.value=a);let L=p||d;if(n==="upload")if(L){let h=i?` (${Oe(i)})`:"";N(`Image t\xE9l\xE9vers\xE9e${h} et appliqu\xE9e au profil.`,"success"),Y("Image appliqu\xE9e au profil \u2705","success")}else{let h=i?` (${Oe(i)})`:"";N(`Image t\xE9l\xE9vers\xE9e${h}. S\xE9lectionnez un profil \xE9ditable pour l\u2019appliquer.`,"info")}else L?(N("Image appliqu\xE9e au profil.","success"),Y("Image appliqu\xE9e au profil \u2705","success")):N("S\xE9lectionnez un profil \xE9ditable pour appliquer l\u2019image.","info")}function at(){var l;let t=nt(),n=it(),i=((l=n==null?void 0:n.data)==null?void 0:l[t])||"";if(!i){he(),X&&(X.value=""),N("Formats recommand\xE9s : JPG, PNG, WebP.","info");return}let a=ot(i,{silent:!0});X&&(X.value=a),N("Image actuelle du profil charg\xE9e.","info")}function me(){if(!f||!(ae!=null&&ae.parent))return;fe&&(fe=null),Ee=null;let{parent:t,nextSibling:n}=ae;n&&t.contains(n)?t.insertBefore(f,n):t.appendChild(f),f.classList.remove("is-modal-context"),he(),X&&(X.value=""),N("Importez une image ou collez une URL publique. Formats recommand\xE9s : JPG, PNG, WebP.","info")}function Mt(t){if(!f||!t||fe===t)return;me();let n=t.querySelector(".f3-form-buttons");n&&n.parentNode?n.parentNode.insertBefore(f,n):t.appendChild(f),f.classList.add("is-modal-context"),fe=t}function qt({cont:t,form_creator:n}){var l;if(!f)return;let i=(l=t==null?void 0:t.querySelector)==null?void 0:l.call(t,"form");if(!i){me();return}if(!((n==null?void 0:n.editable)!==!1&&!(n!=null&&n.no_edit))){i.contains(f)&&me();return}Mt(i),Ee=(n==null?void 0:n.datum_id)||null,at()}function wt(){me()}f&&(ae!=null&&ae.parent)&&f.parentElement!==ae.parent&&me();let xt=5*1024*1024;function Oe(t){return Number.isFinite(t)?t<1024?`${t} o`:t<1024*1024?`${(t/1024).toFixed(1)} Ko`:`${(t/(1024*1024)).toFixed(2)} Mo`:""}function N(t,n="info"){re&&(re.textContent=t,re.dataset.status=n)}function he(){H&&(H.classList.add("hidden"),H.dataset.url="",J&&(J.textContent=""),$&&($.href="#",$.classList.add("hidden")))}function ot(t,{silent:n=!1}={}){if(!H)return"";let i=rt(t);return H.dataset.url=i,J&&(J.textContent=i),$&&($.href=i,$.classList.remove("hidden")),H.classList.remove("hidden"),X&&(X.value=i),n||N("Image pr\xEAte \xE0 \xEAtre appliqu\xE9e.","info"),i}async function st(t,{successMessage:n="Copi\xE9 dans le presse-papiers \u2705",errorMessage:i="Impossible de copier."}={}){var a;if(!t){N("Aucune URL \xE0 copier.","error");return}try{if((a=navigator.clipboard)!=null&&a.writeText)await navigator.clipboard.writeText(t);else{let l=document.createElement("textarea");l.value=t,l.setAttribute("readonly",""),l.style.position="absolute",l.style.left="-9999px",document.body.append(l),l.select(),document.execCommand("copy"),l.remove()}Y(n,"success"),N(n,"success")}catch(l){console.error(l),Y(i,"error"),N(i,"error")}}async function _t(t){if(!t)return;if(he(),!t.type||!t.type.startsWith("image/")){N("Format non pris en charge. S\xE9lectionnez une image (JPEG, PNG, WebP\u2026).","error");return}if(t.size>xt){N(`Fichier trop volumineux (${Oe(t.size)}). Limite 5 Mo.`,"error");return}N("T\xE9l\xE9versement en cours\u2026","saving"),Y("T\xE9l\xE9versement de l\u2019image\u2026","saving");let n=new FormData;n.append("file",t,t.name);try{let i=await fetch("/api/uploads",{method:"POST",body:n});if(!i.ok){let p=`Erreur serveur (${i.status})`;try{let d=await i.json();d!=null&&d.message&&(p=d.message)}catch{}throw new Error(p)}let a=await i.json(),l=a==null?void 0:a.url;if(!l)throw new Error("R\xE9ponse du serveur invalide (URL manquante).");let u=ot(l);Ne(u,{origin:"upload",sizeBytes:t.size})}catch(i){console.error(i),N(i.message||"\xC9chec du t\xE9l\xE9versement.","error"),Y(`T\xE9l\xE9versement \xE9chou\xE9: ${i.message||"Erreur inconnue"}`,"error"),he()}}he(),re&&N(re.textContent||"Formats recommand\xE9s : JPG, PNG, WebP.","info");function Nt(t){G.forEach(n=>{let i=n.dataset.orientation===t;n.classList.toggle("active",i)})}function lt(){var t,n,i,a,l,u,p;if(k&&(k.value=(n=(t=o.transitionTime)==null?void 0:t.toString())!=null?n:""),x&&(x.value=(a=(i=o.cardXSpacing)==null?void 0:i.toString())!=null?a:""),I&&(I.value=(u=(l=o.cardYSpacing)==null?void 0:l.toString())!=null?u:""),O){let d=(p=o.singleParentEmptyCardLabel)!=null?p:A.singleParentEmptyCardLabel;O.value=d}_&&(_.value=ct(o.ancestryDepth,A.ancestryDepth)),B&&(B.value=ct(o.progenyDepth,A.progenyDepth)),P&&(P.checked=o.miniTree!==!1),F&&(F.checked=o.duplicateBranchToggle!==!1),Nt(o.orientation||A.orientation)}function ee(t={},{treePosition:n="inherit",refresh:i=!0}={}){if(o={...o,...t},At(e),r&&typeof r.setMiniTree=="function"&&r.setMiniTree(o.miniTree!==!1),i){let a=M;M=!0,lt(),M=a}e.updateTree({initial:!1,tree_position:n}),V=null,M||se()}function Re(t,n){if(!t)return n;let i=Number(t.value);return Number.isFinite(i)?i:n}function ct(t,n){return t===null?"":typeof t=="number"&&Number.isFinite(t)&&t>=0?String(Math.floor(t)):typeof n=="number"&&Number.isFinite(n)&&n>=0?String(Math.floor(n)):""}function ut(t,n){if(!t)return n;if(t.value==="")return null;let i=Number(t.value);return Number.isFinite(i)&&i>=0?Math.floor(i):n}function ve(t,n){let i=C(t);return n?q.set(i,n.trim()||t):q.has(i)||q.set(i,t),q.get(i)||t}function Ot(t){let n=ie(t).map(i=>{let a=C(i),l=ve(i,q.get(a));return Qe(a,i,l)});return Lt(n,q)}function De(t){var i,a;if(!le)return;if(!t){le.textContent="\u2014";return}let n=(a=(i=v==null?void 0:v.store)==null?void 0:i.getDatum)==null?void 0:a.call(i,t);if(!n){le.textContent="\u2014";return}le.textContent=Se(n)}function Ie({keepSelection:t=!0}={}){var L;if(!D)return;let n=Te(),i=t?D.value:"";if(D.innerHTML="",!n.length){let h=document.createElement("option");h.value="",h.textContent="Aucune personne disponible",D.append(h),D.disabled=!0,De(null);return}let a=document.createDocumentFragment();n.forEach(h=>{if(!h||!h.id)return;let w=document.createElement("option");w.value=h.id,w.textContent=Se(h),a.append(w)}),D.append(a),D.disabled=!1;let l=new Set(n.map(h=>h.id)),u=[];t&&i&&l.has(i)&&u.push(i);let p=typeof o.mainId=="string"?o.mainId:"";p&&l.has(p)&&u.push(p);let d=e.store&&typeof e.store.getMainId=="function"?e.store.getMainId():"";d&&l.has(d)&&u.push(d),(L=n[0])!=null&&L.id&&u.push(n[0].id);let S=u.find(Boolean)||"";S?D.value=S:D.selectedIndex=0,De(D.value||null)}function Rt({scheduleSaveIfChanged:t=!1}={}){var p;if(!e.store||typeof e.store.getMainId!="function")return;let n=e.store.getMainId(),i=Te(),a=new Set(i.map(d=>d&&d.id).filter(Boolean)),l=typeof o.mainId=="string"&&o.mainId.trim()?o.mainId.trim():null,u=l;if(u&&!a.has(u)&&(u=null),!u&&n&&a.has(n)&&(u=n),!u&&i.length){let d=((p=i[0])==null?void 0:p.id)||null;d&&a.has(d)&&(u=d)}u!==l&&(o={...o,mainId:u},V=null,t&&!M&&se()),D&&(u&&![...D.options].some(d=>d.value===u)&&Ie({keepSelection:!1}),!u&&!D.options.length&&Ie({keepSelection:!1}),u&&(D.value=u,D.disabled=!1)),De(u||null)}function Bt(t,{openEditor:n=!0,suppressSave:i=!1}={}){var p,d;if(!t)return;if(!Te().some(S=>S.id===t)){Ie({keepSelection:!1});return}let l=o.mainId!==t;l&&(o={...o,mainId:t}),l&&!i&&(V=null,M||se());let u=e.store&&typeof e.store.getMainId=="function"?e.store.getMainId():null;if(e&&typeof e.updateMainId=="function"&&u!==t&&(e.updateMainId(t),e.updateTree({initial:!1,tree_position:"main_to_middle"})),D&&D.value!==t&&(D.value=t,D.disabled=!1),De(t),n&&v){let S=(d=(p=v.store)==null?void 0:p.getDatum)==null?void 0:d.call(p,t);S&&v.open(S)}}D&&D.addEventListener("change",t=>{let{value:n}=t.target;n&&Bt(n)});function ye(t){var n;return(n=window.CSS)!=null&&n.escape?window.CSS.escape(t):t.replace(/[^a-zA-Z0-9_-]/g,i=>`\\${i}`)}function dt(t){if(t.querySelector(".remove-field"))return;let n=document.createElement("button");n.type="button",n.className="remove-field",n.textContent="Retirer",n.addEventListener("click",()=>{t.remove(),$e()}),t.append(n)}function $t(t){g.forEach(n=>{let i=n.querySelector(".field-list");if(!i)return;let a=`[data-field-key="${ye(t)}"]`,l=i.querySelector(a);if(l)if(l.dataset.custom==="true")l.remove();else{let u=R.get(n.dataset.displayRow),p=u==null?void 0:u.get(t),d=l.querySelector('input[type="checkbox"]');d&&typeof p=="boolean"&&(d.checked=p)}})}function zt(t){if(!o.cardDisplay)return[];let n=C(t),i=[];return o.cardDisplay.forEach((a,l)=>{a.some(u=>C(u)===n)&&i.push(String(l+1))}),i}function Yt(){Array.isArray(o.editableFields)&&o.editableFields.forEach(t=>{let n=C(t);if(Ze.has(n)||n===kt||!n)return;let i=ve(t,q.get(n)),a=`[data-field-key="${ye(n)}"]`;s!=null&&s.querySelector(a)||Be({value:t,label:i,checked:!0,removable:!0,selectRows:zt(t)})})}function jt(){if(!s)return;let t=new Set((o.editableFields||[]).map(C));s.querySelectorAll('input[type="checkbox"]').forEach(n=>{let i=C(n.value);n.checked=t.has(i)})}function Xt(){g.forEach((t,n)=>{let i=o.cardDisplay&&o.cardDisplay[n]||[],a=new Set(i.map(C));t.querySelectorAll('input[type="checkbox"]').forEach(l=>{let u=C(l.value);l.checked=a.has(u)})})}function Gt(t,{value:n,label:i,defaultChecked:a=!1,removable:l=!1}){let u=t.querySelector(".field-list");if(!u)return{item:null,isNew:!1};let p=C(n),d=`[data-field-key="${ye(p)}"]`,S=ve(n,i),L=u.querySelector(d);if(L){let te=L.querySelector("label span");return te&&(te.textContent=S),l&&(L.dataset.custom="true",dt(L)),{item:L,isNew:!1}}L=document.createElement("div"),L.className="display-item",L.dataset.fieldKey=p,l&&(L.dataset.custom="true");let h=document.createElement("label"),w=document.createElement("input");w.type="checkbox",w.value=n,w.checked=a;let z=document.createElement("span");return z.textContent=S,h.append(w,z),L.append(h),l&&dt(L),u.append(L),{item:L,isNew:!0}}function Be({value:t,label:n,checked:i=!0,removable:a=!1,selectRows:l=[]}){if(!s)return;let u=C(t),p=ve(t,n),d=`[data-field-key="${ye(u)}"]`,S=s.querySelector(d),L=!S;if(S){let w=S.querySelector('input[type="checkbox"]');w&&typeof i=="boolean"&&(w.checked=i);let z=S.querySelector("label span");z&&(z.textContent=p),a&&(S.dataset.custom="true")}else{S=document.createElement("div"),S.className="editable-item",S.dataset.fieldKey=u,a&&(S.dataset.custom="true");let w=document.createElement("label"),z=document.createElement("input");z.type="checkbox",z.value=t,z.checked=i;let te=document.createElement("span");if(te.textContent=p,w.append(z,te),S.append(w),a){let oe=document.createElement("button");oe.type="button",oe.className="remove-field",oe.textContent="Retirer",oe.addEventListener("click",()=>{S.remove(),$t(u),Ce()}),S.append(oe)}s.append(S)}let h=new Set((l||[]).map(String));g.forEach(w=>{let z=w.dataset.displayRow,te=R.get(z),oe=te==null?void 0:te.get(u),Wt=oe!==void 0?oe:h.has(z),Zt=a,{item:ht,isNew:Qt}=Gt(w,{value:t,label:p,defaultChecked:Wt,removable:Zt});if(ht&&!Qt&&h.has(z)){let yt=ht.querySelector('input[type="checkbox"]');yt&&(yt.checked=!0)}})}function ft(t){return t?[...t.querySelectorAll('input[type="checkbox"]')].filter(n=>n.checked).map(n=>n.value):[]}function pt(t=[],n=[]){return t.length!==n.length?!1:t.every((i,a)=>C(i)===C(n[a]))}function Ut(t=[],n=[]){return t.length!==n.length?!1:t.every((i,a)=>pt(i,n[a]))}function Ht(t){g.forEach(n=>{n.querySelectorAll(".display-item").forEach(a=>{let l=a.dataset.fieldKey,u=a.querySelector('input[type="checkbox"]'),p=t.has(l);a.classList.toggle("is-disabled",!p),u&&(u.disabled=!p,!p&&u.checked&&(u.checked=!1))})})}function $e({suppressSave:t=!1}={}){let n=b.get("1"),i=b.get("2"),a=ie(ft(n)),l=ie(ft(i)),u=a[0]||(ne.length?ne[0]:pe[0]||"first name"),d=[a.length?a:[u],l];r.setCardDisplay(d),e.updateTree({initial:!1,tree_position:"inherit"}),!Ut(o.cardDisplay,d)&&(o={...o,cardDisplay:d.map(L=>[...L])},t||(V=null,M||se()))}function Ce({suppressSave:t=!1}={}){if(!v||!s)return;let n=[...s.querySelectorAll('input[type="checkbox"]')].filter(d=>d.checked).map(d=>d.value),i=n.length?n:o.editableFields.length?[...o.editableFields]:["first name"];if(i=Me(ie(i)),!i.length){let d=pe[0]||"first name";if(i=[d],s){let S=C(d),L=`[data-field-key="${ye(S)}"] input[type="checkbox"]`,h=s.querySelector(L);h&&(h.checked=!0)}}ne=Me([...i]);let a=Ot(i);v.setFields(a);let l=new Set(i.map(C));Ht(l),!pt(o.editableFields,i)&&(o={...o,editableFields:[...i]},t||(V=null,M||se())),$e({suppressSave:t});let p=v.store.getMainDatum();p&&v.open(p)}function Kt(){let t=prompt("Nom du champ (cl\xE9 dans vos donn\xE9es) ?");if(!t)return null;let n=t.trim();if(!n)return null;let i=C(n),a=q.get(i)||n,l=prompt("Libell\xE9 affich\xE9 pour ce champ ?",a),u=(l!=null?l:a).trim()||n;return{value:n,label:u,key:i}}function Vt({selectRows:t=[]}={}){let n=Kt();if(!n)return;let{value:i,label:a,key:l}=n,u=Pe.some(p=>C(p.value)===l);Be({value:i,label:a,checked:!0,removable:!u,selectRows:t}),Ce()}Pe.forEach(t=>{Be({value:t.value,label:t.label,checked:t.checked!==!1,removable:!1})}),s==null||s.addEventListener("change",t=>{t.target.matches('input[type="checkbox"]')&&Ce()}),y==null||y.addEventListener("click",()=>Vt()),g.forEach(t=>{t.addEventListener("change",n=>{n.target.matches('input[type="checkbox"]')&&$e()})}),m==null||m.addEventListener("change",()=>{r.setCardImageField(m.value),e.updateTree({initial:!1,tree_position:"inherit"}),at()}),E==null||E.addEventListener("change",()=>{r.setStyle(E.value),e.updateTree({initial:!1,tree_position:"inherit"})}),k==null||k.addEventListener("change",()=>{var a;if(M)return;let t=(a=o.transitionTime)!=null?a:A.transitionTime,n=Re(k,t),i=Math.max(0,n);i!==o.transitionTime&&ee({transitionTime:i})}),I==null||I.addEventListener("change",()=>{var a;if(M)return;let t=(a=o.cardYSpacing)!=null?a:A.cardYSpacing,n=Re(I,t),i=n>0?n:t;i!==o.cardYSpacing&&ee({cardYSpacing:i})}),x==null||x.addEventListener("change",()=>{var a;if(M)return;let t=(a=o.cardXSpacing)!=null?a:A.cardXSpacing,n=Re(x,t),i=n>0?n:t;i!==o.cardXSpacing&&ee({cardXSpacing:i})}),_==null||_.addEventListener("change",()=>{var i,a;if(M)return;let t=(a=(i=o.ancestryDepth)!=null?i:A.ancestryDepth)!=null?a:null,n=ut(_,t);n!==o.ancestryDepth&&ee({ancestryDepth:n},{treePosition:"main_to_middle"})}),B==null||B.addEventListener("change",()=>{var i,a;if(M)return;let t=(a=(i=o.progenyDepth)!=null?i:A.progenyDepth)!=null?a:null,n=ut(B,t);n!==o.progenyDepth&&ee({progenyDepth:n},{treePosition:"main_to_middle"})}),P==null||P.addEventListener("change",()=>{if(M)return;let t=P.checked,n=o.miniTree!==!1;t!==n&&ee({miniTree:t})}),F==null||F.addEventListener("change",()=>{if(M)return;let t=F.checked,n=o.duplicateBranchToggle!==!1;t!==n&&ee({duplicateBranchToggle:t},{treePosition:"inherit"})}),O==null||O.addEventListener("change",()=>{if(M)return;let t=(O.value||"").trim()||A.singleParentEmptyCardLabel;t!==o.singleParentEmptyCardLabel&&ee({singleParentEmptyCardLabel:t,singleParentEmptyCard:!0})}),G==null||G.forEach(t=>{t.addEventListener("click",()=>{let i=t.dataset.orientation==="horizontal"?"horizontal":"vertical";o.orientation!==i&&ee({orientation:i},{treePosition:"fit"})})});function mt(){let t={};n("width",j),n("height",U),n("img_w",K),n("img_h",W),n("img_x",Z),n("img_y",ce),r.resetCardDim(),Object.keys(t).length>0&&r.setCardDim(t),e.updateTree({initial:!1,tree_position:"inherit"});function n(i,a){if(!a)return;let l=Number(a.value);Number.isFinite(l)&&(t[i]=l)}}[j,U,K,W,Z,ce].forEach(t=>t==null?void 0:t.addEventListener("change",mt)),ue==null||ue.addEventListener("click",()=>{[[j,240],[U,150],[K,80],[W,80],[Z,16],[ce,16]].forEach(([t,n])=>{t&&(t.value=n)}),mt()}),de==null||de.addEventListener("change",t=>{let n=t.target.files&&t.target.files[0];n&&_t(n),t.target.value=""}),xe==null||xe.addEventListener("click",()=>{var n,i;let t=((n=H==null?void 0:H.dataset)==null?void 0:n.url)||((i=J==null?void 0:J.textContent)==null?void 0:i.trim());t&&Ne(t,{origin:"manual"}),st(t,{successMessage:"URL du t\xE9l\xE9versement copi\xE9e \u2705",errorMessage:"Impossible de copier l\u2019URL du t\xE9l\xE9versement."})}),_e==null||_e.addEventListener("click",()=>{var n;let t=(n=X==null?void 0:X.value)==null?void 0:n.trim();t&&Ne(t,{origin:"manual"}),st(t,{successMessage:"Image appliqu\xE9e et URL copi\xE9e \u2705",errorMessage:"Impossible de copier ce lien."})});let Jt=M;return M=!0,Yt(),lt(),jt(),Xt(),M=Jt,Ce({suppressSave:!0}),{refreshMainProfileOptions:Ie,syncMainProfileSelection:Rt,handleFormCreation:qt,teardown:wt}}function Me(e=[]){return e.filter(r=>C(r)!==kt)}async function Ft(){et(),v=null,V=null;try{let e=await mn();hn(e)}catch(e){console.error(e),Y(`Erreur: ${e.message}`,"error")}}Ye==null||Ye.addEventListener("click",()=>{let e=we();e&&tt(e,{immediate:!0})});je==null||je.addEventListener("click",()=>{Ft()});function gn(){let e=we();return e?JSON.stringify(e)!==V:!1}window.addEventListener("beforeunload",e=>{gn()&&(e.preventDefault(),e.returnValue="")});Ft();
//# sourceMappingURL=builder.bundle.js.map
