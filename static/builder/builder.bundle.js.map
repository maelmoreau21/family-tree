{
  "version": 3,
  "sources": ["builder.js"],
  "sourcesContent": ["import * as f3 from '/lib/family-tree.esm.js'\r\n\r\nconst statusEl = document.getElementById('status')\r\nconst saveBtn = document.getElementById('save')\r\nconst reloadBtn = document.getElementById('reload')\r\nconst panel = document.getElementById('controlPanel')\r\nconst chartSelector = '#FamilyChart'\r\nconst searchRoot = document.querySelector('[data-role=\"builder-search\"]')\r\nconst searchTarget = document.querySelector('[data-role=\"builder-search-target\"]')\r\nconst searchEmptyEl = document.querySelector('[data-role=\"builder-search-empty\"]')\r\nconst searchLabel = document.getElementById('builderSearchLabel')\r\nconst searchHint = document.getElementById('builderSearchHint')\r\nconst panelToggleBtn = document.querySelector('[data-action=\"toggle-panel\"]')\r\n\r\nconst CONTROL_PANEL_STATE_KEY = 'family-tree:builder:controlsCollapsed'\r\nlet builderSearchOptions = []\r\nlet builderSearchReady = false\r\n\r\nfunction setBuilderSearchState(state) {\r\n  if (!searchRoot) return\r\n  if (!state) {\r\n    delete searchRoot.dataset.state\r\n    return\r\n  }\r\n  searchRoot.dataset.state = state\r\n}\r\n\r\nfunction normalizeFieldKey(value) {\r\n  if (value === undefined || value === null) return ''\r\n  return String(value).trim().toLowerCase()\r\n}\r\n\r\nfunction sanitizeFieldValues(values) {\r\n  if (!Array.isArray(values)) return []\r\n  const seen = new Set()\r\n  const result = []\r\n  values.forEach(rawValue => {\r\n    if (typeof rawValue !== 'string') return\r\n    const trimmed = rawValue.trim()\r\n    if (!trimmed) return\r\n    const key = normalizeFieldKey(trimmed)\r\n    if (seen.has(key)) return\r\n    seen.add(key)\r\n    result.push(trimmed)\r\n  })\r\n  return result\r\n}\r\n\r\nfunction getStorageSafe() {\r\n  try {\r\n    return window.localStorage\r\n  } catch (error) {\r\n    return null\r\n  }\r\n}\r\n\r\nfunction readCollapsedState() {\r\n  const storage = getStorageSafe()\r\n  if (!storage) return false\r\n  try {\r\n    return storage.getItem(CONTROL_PANEL_STATE_KEY) === '1'\r\n  } catch (error) {\r\n    return false\r\n  }\r\n}\r\n\r\nfunction writeCollapsedState(collapsed) {\r\n  const storage = getStorageSafe()\r\n  if (!storage) return\r\n  try {\r\n    if (collapsed) {\r\n      storage.setItem(CONTROL_PANEL_STATE_KEY, '1')\r\n    } else {\r\n      storage.removeItem(CONTROL_PANEL_STATE_KEY)\r\n    }\r\n  } catch (error) {\r\n    // storage errors can be ignored silently\r\n  }\r\n}\r\n\r\nfunction applyControlsCollapsedState(collapsed) {\r\n  if (collapsed) {\r\n    document.body.classList.add('controls-collapsed')\r\n  } else {\r\n    document.body.classList.remove('controls-collapsed')\r\n  }\r\n\r\n  if (panelToggleBtn) {\r\n    panelToggleBtn.setAttribute('aria-expanded', String(!collapsed))\r\n    panelToggleBtn.textContent = collapsed ? 'Afficher le panneau' : 'Replier le panneau'\r\n  }\r\n}\r\n\r\nfunction toggleControlsCollapsed(force) {\r\n  const next = typeof force === 'boolean' ? force : !document.body.classList.contains('controls-collapsed')\r\n  applyControlsCollapsedState(next)\r\n  writeCollapsedState(next)\r\n}\r\n\r\nconst initialPanelCollapsed = readCollapsedState()\r\napplyControlsCollapsedState(initialPanelCollapsed)\r\nif (panelToggleBtn) {\r\n  panelToggleBtn.addEventListener('click', () => {\r\n    toggleControlsCollapsed()\r\n  })\r\n}\r\n\r\nconst DISPLAY_FIELD_LABELS = new Map([\r\n  ['first name', 'Pr\u00E9nom'],\r\n  ['last name', 'Nom'],\r\n  ['birthday', 'Date de naissance'],\r\n  ['death', 'Date de D\u00E9c\u00E8s'],\r\n  ['gender', 'Genre'],\r\n  ['avatar', 'Photo de profil'],\r\n  ['photo', 'Photo'],\r\n  ['picture', 'Portrait'],\r\n  ['bio', 'Biographie'],\r\n  ['occupation', 'Profession'],\r\n  ['location', 'Lieu de r\u00E9sidence'],\r\n  ['birthplace', 'Lieu de naissance'],\r\n  ['deathplace', 'Lieu de d\u00E9c\u00E8s'],\r\n  ['union date', \"Date d'union\"],\r\n  ['union place', \"Lieu d'union\"],\r\n  ['union paragraph', \"Paragraphe d'union\"],\r\n  ['notes', 'Notes'],\r\n  ['nickname', 'Surnom'],\r\n  ['maiden name', 'Nom de naissance']\r\n])\r\n\r\nconst DISPLAY_DEFAULTS = {\r\n  1: [\r\n    { value: 'first name', checked: true },\r\n    { value: 'last name', checked: true },\r\n    { value: 'birthday', checked: false },\r\n    { value: 'avatar', checked: false },\r\n    { value: 'gender', checked: false }\r\n  ],\r\n  2: [\r\n    { value: 'birthday', checked: true },\r\n    { value: 'death', label: 'Date de D\u00E9c\u00E8s', checked: false },\r\n    { value: 'avatar', checked: false },\r\n    { value: 'gender', checked: false }\r\n  ]\r\n}\r\n\r\nconst EDITABLE_DEFAULTS = [\r\n  { value: 'first name', label: 'Pr\u00E9nom', checked: true },\r\n  { value: 'last name', label: 'Nom', checked: true },\r\n  { value: 'maiden name', label: 'Nom de naissance', checked: false },\r\n  { value: 'birthday', label: 'Date de naissance', checked: true },\r\n  { value: 'death', label: 'Date de D\u00E9c\u00E8s', checked: false },\r\n  { value: 'avatar', label: 'Avatar', checked: true },\r\n  { value: 'gender', label: 'Genre', checked: true },\r\n  { value: 'birthplace', label: 'Lieu de naissance', checked: false },\r\n  { value: 'deathplace', label: 'Lieu de D\u00E9c\u00E8s', checked: false },\r\n  { value: 'bio', label: 'Biographie', checked: false }\r\n]\r\n\r\nconst DEFAULT_CARD_DISPLAY = [\r\n  ['first name', 'last name'],\r\n  ['birthday']\r\n]\r\n\r\nconst UNION_PARAGRAPH_KEY = 'union paragraph'\r\n\r\nconst DEFAULT_EDITABLE_FIELDS = removeUnionParagraphField(\r\n  sanitizeFieldValues(\r\n    EDITABLE_DEFAULTS\r\n      .filter(def => def.checked !== false)\r\n      .map(def => def.value)\r\n  )\r\n)\r\n\r\nconst TEXTAREA_FIELD_KEYS = new Set(['bio', 'notes', 'biographie', 'description', 'union paragraph'])\r\nconst REL_REFERENCE_FIELD_KEYS = new Set(['union date', 'union place'])\r\n\r\nfunction createFieldDescriptor(key, value, label) {\r\n  if (REL_REFERENCE_FIELD_KEYS.has(key)) {\r\n    return {\r\n      id: value,\r\n      label,\r\n      type: 'rel_reference',\r\n      rel_type: 'spouse',\r\n      getRelLabel: buildPersonLabel\r\n    }\r\n  }\r\n  const type = TEXTAREA_FIELD_KEYS.has(key) ? 'textarea' : 'text'\r\n  return { id: value, label, type }\r\n}\r\n\r\nfunction appendUnionFieldDescriptors(descriptors, labelLookup) {\r\n  const getLabel = (key) => {\r\n    if (!labelLookup) return key\r\n    if (typeof labelLookup.get === 'function') {\r\n      return labelLookup.get(key) || key\r\n    }\r\n    if (labelLookup instanceof Map) {\r\n      return labelLookup.get(key) || key\r\n    }\r\n    return labelLookup[key] || key\r\n  }\r\n\r\n  REL_REFERENCE_FIELD_KEYS.forEach(key => {\r\n    const exists = descriptors.some(descriptor => normalizeFieldKey(descriptor.id) === key)\r\n    if (exists) return\r\n    const label = getLabel(key)\r\n    descriptors.push(createFieldDescriptor(key, key, label))\r\n  })\r\n\r\n  return descriptors\r\n}\r\n\r\nfunction createBaseFieldLabelStore() {\r\n  const store = new Map(DISPLAY_FIELD_LABELS)\r\n  EDITABLE_DEFAULTS.forEach(def => {\r\n    store.set(normalizeFieldKey(def.value), def.label)\r\n  })\r\n  Object.values(DISPLAY_DEFAULTS).forEach(defs => {\r\n    defs.forEach(def => {\r\n      if (def.label) {\r\n        store.set(normalizeFieldKey(def.value), def.label)\r\n      }\r\n    })\r\n  })\r\n  return store\r\n}\r\n\r\nfunction buildFieldDescriptors(fields, labelStore = createBaseFieldLabelStore()) {\r\n  const store = labelStore || createBaseFieldLabelStore()\r\n  const descriptors = sanitizeFieldValues(fields).map(value => {\r\n    const key = normalizeFieldKey(value)\r\n    const label = store.get(key) || value\r\n    return createFieldDescriptor(key, value, label)\r\n  })\r\n  return appendUnionFieldDescriptors(descriptors, store)\r\n}\r\n\r\nfunction safeTrim(value) {\r\n  return typeof value === 'string' ? value.trim() : ''\r\n}\r\n\r\nfunction getAllPersons() {\r\n  if (!editTreeInstance || !editTreeInstance.store || typeof editTreeInstance.store.getData !== 'function') {\r\n    return []\r\n  }\r\n  const persons = editTreeInstance.store.getData()\r\n  return Array.isArray(persons) ? persons : []\r\n}\r\n\r\nfunction buildPersonLabel(datum) {\r\n  if (!datum) return 'Profil sans nom'\r\n  const person = datum.data || {}\r\n  const first = safeTrim(person['first name'])\r\n  const last = safeTrim(person['last name'])\r\n  const base = (first || last) ? [first, last].filter(Boolean).join(' ').trim() : `Profil ${datum.id}`\r\n  const birth = safeTrim(person['birthday'])\r\n  return birth ? `${base} (${birth})` : base\r\n}\r\n\r\nfunction createSearchOptionFromDatum(datum) {\r\n  if (!datum || typeof datum.id !== 'string' || !datum.id.trim()) return null\r\n  const label = buildPersonLabel(datum)\r\n  const tokens = new Set()\r\n  const metaParts = []\r\n  const metaSeen = new Set()\r\n\r\n  const addToken = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed) return\r\n    tokens.add(trimmed)\r\n  }\r\n\r\n  const addMeta = (value) => {\r\n    if (typeof value !== 'string') return\r\n    const trimmed = value.trim()\r\n    if (!trimmed || metaSeen.has(trimmed)) return\r\n    metaSeen.add(trimmed)\r\n    metaParts.push(trimmed)\r\n  }\r\n\r\n  addToken(label)\r\n  addToken(String(datum.id))\r\n\r\n  const person = datum.data && typeof datum.data === 'object' ? datum.data : {}\r\n  Object.entries(person).forEach(([rawKey, rawValue]) => {\r\n    if (typeof rawValue !== 'string') return\r\n    const trimmed = rawValue.trim()\r\n    if (!trimmed) return\r\n    addToken(trimmed)\r\n    const key = normalizeFieldKey(rawKey)\r\n    if (key === 'birthday') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n    if (key === 'death') {\r\n      addMeta(`\u271D ${trimmed}`)\r\n      return\r\n    }\r\n    if (key === 'maiden name') {\r\n      addMeta(`(${trimmed})`)\r\n      return\r\n    }\r\n    if (key === 'occupation') {\r\n      addMeta(trimmed)\r\n      return\r\n    }\r\n    if (key === 'location' || key === 'residence' || key === 'birthplace' || key === 'deathplace') {\r\n      addMeta(trimmed)\r\n    }\r\n  })\r\n\r\n  const searchText = Array.from(tokens)\r\n    .map(value => value.replace(/\\s+/g, ' ').trim())\r\n    .filter(Boolean)\r\n    .join(' | ')\r\n\r\n  return {\r\n    label,\r\n    value: datum.id,\r\n    searchText,\r\n    optionHtml: (option) => {\r\n      const meta = metaParts.length ? `<small>${metaParts.join(' \u00B7 ')}</small>` : ''\r\n      return `<div>${option.label_html || option.label}${meta ? `<div class=\"f3-autocomplete-meta\">${meta}</div>` : ''}</div>`\r\n    }\r\n  }\r\n}\r\n\r\nfunction buildSearchOptionsFromPersons(persons) {\r\n  if (!Array.isArray(persons)) return []\r\n  const options = []\r\n  const seen = new Set()\r\n  persons.forEach(datum => {\r\n    if (!datum || !datum.id || seen.has(datum.id)) return\r\n    const option = createSearchOptionFromDatum(datum)\r\n    if (!option) return\r\n    options.push(option)\r\n    seen.add(datum.id)\r\n  })\r\n  options.sort((a, b) => a.label.localeCompare(b.label, 'fr', { sensitivity: 'base' }))\r\n  return options\r\n}\r\n\r\nfunction initBuilderSearch(chart) {\r\n  if (!chart || !searchTarget) {\r\n    setBuilderSearchState('empty')\r\n    return null\r\n  }\r\n\r\n  if (searchEmptyEl) {\r\n    searchEmptyEl.classList.remove('hidden')\r\n  }\r\n\r\n  chart.setPersonDropdown(\r\n    (datum) => buildPersonLabel(datum),\r\n    {\r\n      cont: searchTarget,\r\n  placeholder: 'Rechercher (nom, date, lieu, etc.)',\r\n      onSelect: (id) => {\r\n        if (!id || !editTreeInstance) return\r\n        const datum = editTreeInstance.store?.getDatum?.(id)\r\n        if (datum) {\r\n          editTreeInstance.open(datum)\r\n        }\r\n      }\r\n    }\r\n  )\r\n\r\n  const input = searchTarget.querySelector('input')\r\n  if (input) {\r\n    input.setAttribute('id', 'builderSearchInput')\r\n    if (searchLabel) input.setAttribute('aria-labelledby', searchLabel.id)\r\n    if (searchHint) input.setAttribute('aria-describedby', searchHint.id)\r\n    input.setAttribute('autocomplete', 'off')\r\n    input.setAttribute('spellcheck', 'false')\r\n  }\r\n\r\n  function refreshSearchOptions() {\r\n    if (!chart.personSearch) return\r\n    const persons = getAllPersons()\r\n    builderSearchOptions = buildSearchOptionsFromPersons(persons)\r\n    chart.personSearch.setOptionsGetter(() => builderSearchOptions)\r\n    setBuilderSearchState(builderSearchOptions.length ? 'ready' : 'empty')\r\n    builderSearchReady = true\r\n  }\r\n\r\n  refreshSearchOptions()\r\n\r\n  return {\r\n    refreshSearchOptions\r\n  }\r\n}\r\n\r\nconst DEFAULT_CHART_CONFIG = Object.freeze({\r\n  transitionTime: 200,\r\n  cardXSpacing: 240,\r\n  cardYSpacing: 140,\r\n  orientation: 'vertical',\r\n  showSiblingsOfMain: true,\r\n  singleParentEmptyCard: true,\r\n  singleParentEmptyCardLabel: 'Inconnu',\r\n  ancestryDepth: 4,\r\n  progenyDepth: 4,\r\n  miniTree: true,\r\n  duplicateBranchToggle: true,\r\n  editableFields: [...DEFAULT_EDITABLE_FIELDS],\r\n  cardDisplay: DEFAULT_CARD_DISPLAY.map(row => [...row]),\r\n  mainId: null\r\n})\r\n\r\nfunction normalizeCardDisplay(rows) {\r\n  const safeRows = Array.isArray(rows) ? rows : []\r\n  const normalized = safeRows.slice(0, 2).map(row => sanitizeFieldValues(Array.isArray(row) ? row : []))\r\n  while (normalized.length < 2) normalized.push([])\r\n  return normalized\r\n}\r\n\r\nfunction cloneCardDisplay(cardDisplay, fallbackRows = DEFAULT_CARD_DISPLAY) {\r\n  let source = cardDisplay\r\n  if (cardDisplay && !Array.isArray(cardDisplay) && typeof cardDisplay === 'object') {\r\n    source = [\r\n      cardDisplay[0] ?? cardDisplay['0'] ?? cardDisplay.row1 ?? cardDisplay.row_1 ?? cardDisplay.ligne1 ?? cardDisplay.line1 ?? cardDisplay.first ?? [],\r\n      cardDisplay[1] ?? cardDisplay['1'] ?? cardDisplay.row2 ?? cardDisplay.row_2 ?? cardDisplay.ligne2 ?? cardDisplay.line2 ?? cardDisplay.second ?? []\r\n    ]\r\n  }\r\n\r\n  if (!Array.isArray(source)) {\r\n    return fallbackRows.map(row => [...row])\r\n  }\r\n\r\n  const normalized = normalizeCardDisplay(source)\r\n  return normalized.map((row, index) => {\r\n    if (row.length) return [...row]\r\n    const fallback = fallbackRows[index]\r\n    return Array.isArray(fallback) ? [...fallback] : []\r\n  })\r\n}\r\n\r\nfunction buildChartConfig(overrides = {}) {\r\n  const base = {\r\n    transitionTime: DEFAULT_CHART_CONFIG.transitionTime,\r\n    cardXSpacing: DEFAULT_CHART_CONFIG.cardXSpacing,\r\n    cardYSpacing: DEFAULT_CHART_CONFIG.cardYSpacing,\r\n    orientation: DEFAULT_CHART_CONFIG.orientation,\r\n    showSiblingsOfMain: DEFAULT_CHART_CONFIG.showSiblingsOfMain,\r\n    singleParentEmptyCard: DEFAULT_CHART_CONFIG.singleParentEmptyCard,\r\n    singleParentEmptyCardLabel: DEFAULT_CHART_CONFIG.singleParentEmptyCardLabel,\r\n    ancestryDepth: DEFAULT_CHART_CONFIG.ancestryDepth,\r\n    progenyDepth: DEFAULT_CHART_CONFIG.progenyDepth,\r\n    miniTree: DEFAULT_CHART_CONFIG.miniTree,\r\n    duplicateBranchToggle: DEFAULT_CHART_CONFIG.duplicateBranchToggle,\r\n    editableFields: [...DEFAULT_EDITABLE_FIELDS],\r\n    cardDisplay: cloneCardDisplay(DEFAULT_CARD_DISPLAY),\r\n    mainId: DEFAULT_CHART_CONFIG.mainId\r\n  }\r\n\r\n  if (typeof overrides.transitionTime === 'number' && Number.isFinite(overrides.transitionTime)) {\r\n    base.transitionTime = overrides.transitionTime\r\n  }\r\n\r\n  if (typeof overrides.cardXSpacing === 'number' && Number.isFinite(overrides.cardXSpacing)) {\r\n    base.cardXSpacing = overrides.cardXSpacing\r\n  }\r\n\r\n  if (typeof overrides.cardYSpacing === 'number' && Number.isFinite(overrides.cardYSpacing)) {\r\n    base.cardYSpacing = overrides.cardYSpacing\r\n  }\r\n\r\n  if (overrides.orientation === 'horizontal' || overrides.orientation === 'vertical') {\r\n    base.orientation = overrides.orientation\r\n  }\r\n\r\n  if (typeof overrides.showSiblingsOfMain === 'boolean') {\r\n    base.showSiblingsOfMain = overrides.showSiblingsOfMain\r\n  }\r\n\r\n  if (typeof overrides.singleParentEmptyCard === 'boolean') {\r\n    base.singleParentEmptyCard = overrides.singleParentEmptyCard\r\n  }\r\n\r\n  if (typeof overrides.singleParentEmptyCardLabel === 'string') {\r\n    const trimmed = overrides.singleParentEmptyCardLabel.trim()\r\n    if (trimmed) base.singleParentEmptyCardLabel = trimmed\r\n  }\r\n\r\n  if (overrides.ancestryDepth === null) {\r\n    base.ancestryDepth = null\r\n  } else if (typeof overrides.ancestryDepth === 'number' && Number.isFinite(overrides.ancestryDepth) && overrides.ancestryDepth >= 0) {\r\n    base.ancestryDepth = Math.floor(overrides.ancestryDepth)\r\n  }\r\n\r\n  if (overrides.progenyDepth === null) {\r\n    base.progenyDepth = null\r\n  } else if (typeof overrides.progenyDepth === 'number' && Number.isFinite(overrides.progenyDepth) && overrides.progenyDepth >= 0) {\r\n    base.progenyDepth = Math.floor(overrides.progenyDepth)\r\n  }\r\n\r\n  if (typeof overrides.miniTree === 'boolean') {\r\n    base.miniTree = overrides.miniTree\r\n  }\r\n\r\n  if (typeof overrides.duplicateBranchToggle === 'boolean') {\r\n    base.duplicateBranchToggle = overrides.duplicateBranchToggle\r\n  }\r\n\r\n  if (Array.isArray(overrides.editableFields)) {\r\n    const sanitizedEditable = sanitizeFieldValues(overrides.editableFields)\r\n    if (sanitizedEditable.length) {\r\n      base.editableFields = sanitizedEditable\r\n    }\r\n  }\r\n\r\n  if (Array.isArray(overrides.cardDisplay) || (overrides.cardDisplay && typeof overrides.cardDisplay === 'object')) {\r\n    base.cardDisplay = cloneCardDisplay(overrides.cardDisplay, [[], []])\r\n  }\r\n\r\n  if (typeof overrides.mainId === 'string') {\r\n    const trimmed = overrides.mainId.trim()\r\n    if (trimmed) base.mainId = trimmed\r\n  }\r\n\r\n  return base\r\n}\r\n\r\nlet editTreeInstance = null\r\nlet autoSaveTimer = null\r\nlet lastSnapshotString = null\r\nlet isSaving = false\r\nlet queuedSave = null\r\nlet chartConfig = buildChartConfig()\r\nlet isApplyingConfig = false\r\nlet currentEditableFields = [...DEFAULT_EDITABLE_FIELDS]\r\nlet activePanelTeardown = null\r\n\r\nfunction setStatus(message, type = 'info') {\r\n  if (!statusEl) return\r\n  statusEl.textContent = message\r\n  statusEl.dataset.status = type\r\n}\r\n\r\nfunction normaliseTreePayload(payload) {\r\n  if (Array.isArray(payload)) {\r\n    return { data: payload, config: {} }\r\n  }\r\n\r\n  if (payload && typeof payload === 'object') {\r\n    if (Array.isArray(payload.data)) {\r\n      const candidateConfig = payload.config || payload.settings || payload.meta || {}\r\n      return { data: payload.data, config: candidateConfig }\r\n    }\r\n\r\n    if (Array.isArray(payload.tree)) {\r\n      const candidateConfig = payload.config || payload.settings || payload.meta || {}\r\n      return { data: payload.tree, config: candidateConfig }\r\n    }\r\n  }\r\n\r\n  return { data: [], config: {} }\r\n}\r\n\r\nfunction normaliseChartConfig(rawConfig = {}) {\r\n  if (!rawConfig || typeof rawConfig !== 'object') return {}\r\n\r\n  const config = {}\r\n\r\n  const transition = rawConfig.transitionTime ?? rawConfig.transition_time\r\n  if (typeof transition === 'number' && Number.isFinite(transition)) {\r\n    config.transitionTime = transition\r\n  }\r\n\r\n  const cardX = rawConfig.cardXSpacing ?? rawConfig.card_x_spacing ?? rawConfig.node_separation\r\n  if (typeof cardX === 'number' && Number.isFinite(cardX)) {\r\n    config.cardXSpacing = cardX\r\n  }\r\n\r\n  const cardY = rawConfig.cardYSpacing ?? rawConfig.card_y_spacing ?? rawConfig.level_separation\r\n  if (typeof cardY === 'number' && Number.isFinite(cardY)) {\r\n    config.cardYSpacing = cardY\r\n  }\r\n\r\n  const orientation = rawConfig.orientation\r\n  if (orientation === 'horizontal' || orientation === 'vertical') {\r\n    config.orientation = orientation\r\n  } else if (typeof rawConfig.is_horizontal === 'boolean') {\r\n    config.orientation = rawConfig.is_horizontal ? 'horizontal' : 'vertical'\r\n  }\r\n\r\n  const showSiblings = rawConfig.showSiblingsOfMain ?? rawConfig.show_siblings_of_main\r\n  if (typeof showSiblings === 'boolean') {\r\n    config.showSiblingsOfMain = showSiblings\r\n  }\r\n\r\n  const singleParentEnabled = rawConfig.singleParentEmptyCard ?? rawConfig.single_parent_empty_card\r\n  if (typeof singleParentEnabled === 'boolean') {\r\n    config.singleParentEmptyCard = singleParentEnabled\r\n  }\r\n\r\n  const emptyLabel = rawConfig.singleParentEmptyCardLabel ?? rawConfig.single_parent_empty_card_label\r\n  if (typeof emptyLabel === 'string' && emptyLabel.trim().length > 0) {\r\n    config.singleParentEmptyCardLabel = emptyLabel.trim()\r\n  }\r\n\r\n  const editableFields = rawConfig.editableFields ?? rawConfig.edit_fields ?? rawConfig.fields ?? rawConfig.editable_fields\r\n  if (Array.isArray(editableFields)) {\r\n    config.editableFields = sanitizeFieldValues(editableFields)\r\n  }\r\n\r\n  const rawCardDisplay = rawConfig.cardDisplay ?? rawConfig.card_display\r\n  if (Array.isArray(rawCardDisplay) || (rawCardDisplay && typeof rawCardDisplay === 'object')) {\r\n    config.cardDisplay = cloneCardDisplay(rawCardDisplay, [[], []])\r\n  }\r\n\r\n  const rawMainId = rawConfig.mainId ?? rawConfig.main_id ?? rawConfig.mainPersonId ?? rawConfig.main_person_id\r\n  if (typeof rawMainId === 'string' && rawMainId.trim().length > 0) {\r\n    config.mainId = rawMainId.trim()\r\n  }\r\n\r\n  const rawAncestryDepth = rawConfig.ancestryDepth ?? rawConfig.ancestry_depth\r\n  if (rawAncestryDepth === null) {\r\n    config.ancestryDepth = null\r\n  } else if (rawAncestryDepth !== undefined) {\r\n    const value = Number(rawAncestryDepth)\r\n    if (Number.isFinite(value) && value >= 0) {\r\n      config.ancestryDepth = Math.floor(value)\r\n    }\r\n  }\r\n\r\n  const rawProgenyDepth = rawConfig.progenyDepth ?? rawConfig.progeny_depth\r\n  if (rawProgenyDepth === null) {\r\n    config.progenyDepth = null\r\n  } else if (rawProgenyDepth !== undefined) {\r\n    const value = Number(rawProgenyDepth)\r\n    if (Number.isFinite(value) && value >= 0) {\r\n      config.progenyDepth = Math.floor(value)\r\n    }\r\n  }\r\n\r\n  const rawMiniTree = rawConfig.miniTree ?? rawConfig.mini_tree\r\n  if (typeof rawMiniTree === 'boolean') {\r\n    config.miniTree = rawMiniTree\r\n  }\r\n\r\n  const rawDuplicateToggle = rawConfig.duplicateBranchToggle ?? rawConfig.duplicate_branch_toggle\r\n  if (typeof rawDuplicateToggle === 'boolean') {\r\n    config.duplicateBranchToggle = rawDuplicateToggle\r\n  }\r\n\r\n  return config\r\n}\r\n\r\nfunction applyChartConfigToChart(chart) {\r\n  chart.setTransitionTime(chartConfig.transitionTime)\r\n  chart.setCardXSpacing(chartConfig.cardXSpacing)\r\n  chart.setCardYSpacing(chartConfig.cardYSpacing)\r\n  chart.setShowSiblingsOfMain(chartConfig.showSiblingsOfMain)\r\n\r\n  if (chartConfig.orientation === 'horizontal') {\r\n    chart.setOrientationHorizontal()\r\n  } else {\r\n    chart.setOrientationVertical()\r\n  }\r\n\r\n  chart.setSingleParentEmptyCard(chartConfig.singleParentEmptyCard, {\r\n    label: chartConfig.singleParentEmptyCardLabel\r\n  })\r\n\r\n  if (typeof chartConfig.ancestryDepth === 'number' && Number.isFinite(chartConfig.ancestryDepth)) {\r\n    chart.setAncestryDepth(chartConfig.ancestryDepth)\r\n  } else {\r\n    chart.setAncestryDepth(null)\r\n  }\r\n\r\n  if (typeof chartConfig.progenyDepth === 'number' && Number.isFinite(chartConfig.progenyDepth)) {\r\n    chart.setProgenyDepth(chartConfig.progenyDepth)\r\n  } else {\r\n    chart.setProgenyDepth(null)\r\n  }\r\n\r\n  chart.setDuplicateBranchToggle(chartConfig.duplicateBranchToggle !== false)\r\n}\r\n\r\nasync function loadTree() {\r\n  setStatus('Chargement des donn\u00E9es\u2026')\r\n  const response = await fetch('/api/tree', { cache: 'no-store' })\r\n  if (!response.ok) {\r\n    throw new Error(`\u00C9chec du chargement (${response.status})`)\r\n  }\r\n  return response.json()\r\n}\r\n\r\nfunction destroyTimer() {\r\n  if (autoSaveTimer) {\r\n    clearTimeout(autoSaveTimer)\r\n    autoSaveTimer = null\r\n  }\r\n}\r\n\r\nasync function persistChanges(snapshot, { immediate = false } = {}) {\r\n  if (!snapshot) return\r\n  destroyTimer()\r\n\r\n  const payload = structuredCloneSafe(snapshot)\r\n\r\n  if (isSaving) {\r\n    queuedSave = { snapshot: payload, immediate }\r\n    setStatus('Sauvegarde d\u00E9j\u00E0 en cours\u2026', 'saving')\r\n    return\r\n  }\r\n\r\n  try {\r\n    isSaving = true\r\n    setStatus(immediate ? 'Enregistrement en cours\u2026' : 'Sauvegarde automatique\u2026', 'saving')\r\n\r\n    const response = await fetch('/api/tree', {\r\n      method: 'PUT',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(payload, null, 2)\r\n    })\r\n\r\n    if (!response.ok && response.status !== 204) {\r\n      throw new Error(`Serveur a retourn\u00E9 ${response.status}`)\r\n    }\r\n\r\n    lastSnapshotString = JSON.stringify(payload)\r\n    setStatus('Modifications enregistr\u00E9es \u2705', 'success')\r\n  } catch (error) {\r\n    console.error(error)\r\n    setStatus(`Erreur d'enregistrement: ${error.message}`, 'error')\r\n  } finally {\r\n    isSaving = false\r\n    if (queuedSave) {\r\n      const next = queuedSave\r\n      queuedSave = null\r\n      await persistChanges(next.snapshot, { immediate: next.immediate })\r\n    }\r\n  }\r\n}\r\n\r\nfunction structuredCloneSafe(value) {\r\n  if (typeof structuredClone === 'function') {\r\n    return structuredClone(value)\r\n  }\r\n  return JSON.parse(JSON.stringify(value))\r\n}\r\n\r\nfunction getSnapshot() {\r\n  if (!editTreeInstance) return null\r\n  const data = editTreeInstance.exportData()\r\n  if (!data) return null\r\n  return {\r\n    data,\r\n    config: structuredCloneSafe(chartConfig)\r\n  }\r\n}\r\n\r\nfunction scheduleAutoSave() {\r\n  destroyTimer()\r\n  setStatus('Modification d\u00E9tect\u00E9e\u2026 sauvegarde automatique imminente', 'saving')\r\n  autoSaveTimer = setTimeout(() => {\r\n    const snapshot = getSnapshot()\r\n    if (!snapshot) return\r\n    persistChanges(snapshot)\r\n  }, 1500)\r\n}\r\n\r\nfunction setupChart(payload) {\r\n  const container = document.querySelector(chartSelector)\r\n  if (!container) {\r\n    throw new Error('Conteneur du graphique introuvable')\r\n  }\r\n\r\n  container.innerHTML = ''\r\n  builderSearchReady = false\r\n  builderSearchOptions = []\r\n  setBuilderSearchState('loading')\r\n\r\n  if (typeof activePanelTeardown === 'function') {\r\n    activePanelTeardown()\r\n    activePanelTeardown = null\r\n  }\r\n\r\n  const { data, config } = normaliseTreePayload(payload)\r\n  chartConfig = buildChartConfig(normaliseChartConfig(config))\r\n  currentEditableFields = [...chartConfig.editableFields]\r\n  if (!currentEditableFields.length) {\r\n    currentEditableFields = [...DEFAULT_EDITABLE_FIELDS]\r\n  }\r\n  currentEditableFields = removeUnionParagraphField(currentEditableFields)\r\n\r\n  const initialEditableFields = [...currentEditableFields]\r\n  const initialFieldDescriptors = buildFieldDescriptors(initialEditableFields)\r\n\r\n  const chart = f3.createChart(chartSelector, data)\r\n  applyChartConfigToChart(chart)\r\n\r\n  const initialCardDisplay = chartConfig.cardDisplay && chartConfig.cardDisplay.length\r\n    ? chartConfig.cardDisplay.map(row => [...row])\r\n    : cloneCardDisplay(DEFAULT_CARD_DISPLAY)\r\n\r\n  const card = chart.setCardHtml()\r\n    .setCardDisplay(initialCardDisplay)\r\n    .setCardImageField('avatar')\r\n    .setMiniTree(chartConfig.miniTree !== false)\r\n\r\n  let panelControlAPI = null\r\n  let searchControlAPI = null\r\n  const dataArray = Array.isArray(data) ? data : []\r\n\r\n  editTreeInstance = chart.editTree()\r\n    .setFields(initialFieldDescriptors)\r\n    .setEditFirst(true)\r\n    .setCardClickOpen(card)\r\n    .setOnChange(() => {\r\n      lastSnapshotString = null\r\n      if (panelControlAPI) {\r\n        panelControlAPI.refreshMainProfileOptions({ keepSelection: true })\r\n        panelControlAPI.syncMainProfileSelection({ scheduleSaveIfChanged: false })\r\n      }\r\n      if (searchControlAPI) {\r\n        searchControlAPI.refreshSearchOptions()\r\n      }\r\n      scheduleAutoSave()\r\n    })\r\n\r\n  panelControlAPI = attachPanelControls({ chart, card }) || {\r\n    refreshMainProfileOptions: () => {},\r\n    syncMainProfileSelection: () => {},\r\n    handleFormCreation: () => {},\r\n    teardown: () => {}\r\n  }\r\n\r\n  searchControlAPI = initBuilderSearch(chart)\r\n\r\n  if (typeof panelControlAPI.teardown === 'function') {\r\n    activePanelTeardown = panelControlAPI.teardown\r\n  } else {\r\n    activePanelTeardown = null\r\n  }\r\n\r\n  if (typeof panelControlAPI.handleFormCreation === 'function') {\r\n    editTreeInstance.setOnFormCreation(panelControlAPI.handleFormCreation)\r\n  }\r\n\r\n  const initialMainId = resolveInitialMainId(dataArray, chart)\r\n  if (initialMainId) {\r\n    chart.updateMainId(initialMainId)\r\n  }\r\n\r\n  chart.setAfterUpdate(() => {\r\n    if (!chart.store || typeof chart.store.getMainId !== 'function') return\r\n    const storeMainId = chart.store.getMainId()\r\n    if (!storeMainId && chartConfig.mainId) {\r\n      chartConfig = { ...chartConfig, mainId: null }\r\n      lastSnapshotString = null\r\n      if (!isApplyingConfig) {\r\n        scheduleAutoSave()\r\n      }\r\n    }\r\n    if (panelControlAPI) {\r\n      panelControlAPI.syncMainProfileSelection({ scheduleSaveIfChanged: false })\r\n    }\r\n    if (!builderSearchReady && searchControlAPI) {\r\n      searchControlAPI.refreshSearchOptions()\r\n    }\r\n  })\r\n\r\n  if (panelControlAPI) {\r\n    panelControlAPI.refreshMainProfileOptions({ keepSelection: false })\r\n    panelControlAPI.syncMainProfileSelection({ scheduleSaveIfChanged: false })\r\n  }\r\n\r\n  chart.updateTree({ initial: true, tree_position: 'fit' })\r\n\r\n  const mainDatum = chart.getMainDatum()\r\n  if (mainDatum) {\r\n    editTreeInstance.open(mainDatum)\r\n  }\r\n\r\n  const initialSnapshot = getSnapshot()\r\n  lastSnapshotString = initialSnapshot ? JSON.stringify(initialSnapshot) : null\r\n  const totalPersons = dataArray.length\r\n  setStatus(totalPersons > 0 ? `\u00C9diteur pr\u00EAt \u2705 \u2013 ${totalPersons} personne(s) charg\u00E9e(s)` : 'Fichier de donn\u00E9es vide', totalPersons > 0 ? 'success' : 'error')\r\n\r\n  function resolveInitialMainId(persons, chartInstance) {\r\n    if (!Array.isArray(persons) || persons.length === 0) {\r\n      chartConfig = { ...chartConfig, mainId: null }\r\n      return null\r\n    }\r\n\r\n    const availableIds = new Set(persons.map(person => person && person.id).filter(Boolean))\r\n    const desiredId = typeof chartConfig.mainId === 'string' ? chartConfig.mainId.trim() : ''\r\n    if (desiredId && availableIds.has(desiredId)) {\r\n      return desiredId\r\n    }\r\n\r\n    const storeMainId = chartInstance?.store && typeof chartInstance.store.getMainId === 'function'\r\n      ? chartInstance.store.getMainId()\r\n      : null\r\n\r\n    if (storeMainId && availableIds.has(storeMainId)) {\r\n      if (chartConfig.mainId !== storeMainId) {\r\n        chartConfig = { ...chartConfig, mainId: storeMainId }\r\n      }\r\n      return storeMainId\r\n    }\r\n\r\n    const fallbackId = persons[0]?.id || null\r\n    if (fallbackId && chartConfig.mainId !== fallbackId) {\r\n      chartConfig = { ...chartConfig, mainId: fallbackId }\r\n    }\r\n    return fallbackId\r\n  }\r\n}\r\n\r\nfunction attachPanelControls({ chart, card }) {\r\n  if (!panel) {\r\n    return {\r\n      refreshMainProfileOptions: () => {},\r\n      syncMainProfileSelection: () => {},\r\n      handleFormCreation: () => {},\r\n      teardown: () => {}\r\n    }\r\n  }\r\n\r\n  const editableFieldset = panel.querySelector('[data-role=\"editable-fields\"]')\r\n  const editableList = editableFieldset?.querySelector('.editable-list')\r\n  const addEditableBtn = editableFieldset?.querySelector('[data-action=\"add-editable\"]')\r\n  const displayGroups = [...panel.querySelectorAll('[data-display-row]')]\r\n  const displayGroupMap = new Map(displayGroups.map(group => [group.dataset.displayRow, group]))\r\n  const fieldLabelStore = createBaseFieldLabelStore()\r\n\r\n  const displayDefaultsByRow = new Map(\r\n    Object.entries(DISPLAY_DEFAULTS).map(([row, defs]) => [\r\n      row,\r\n      new Map(defs.map(def => [normalizeFieldKey(def.value), def.checked]))\r\n    ])\r\n  )\r\n\r\n  const imageField = panel.querySelector('#imageField')\r\n  const cardStyle = panel.querySelector('#cardStyle')\r\n  const transitionInput = panel.querySelector('#transitionInput')\r\n  const cardYSpacing = panel.querySelector('#cardYSpacing')\r\n  const cardXSpacing = panel.querySelector('#cardXSpacing')\r\n  const emptyLabel = panel.querySelector('#emptyLabel')\r\n  const ancestryDepthSelect = panel.querySelector('#ancestryDepth')\r\n  const progenyDepthSelect = panel.querySelector('#progenyDepth')\r\n  const miniTreeToggle = panel.querySelector('#miniTreeToggle')\r\n  const duplicateToggle = panel.querySelector('#duplicateToggle')\r\n  const orientationButtons = panel.querySelectorAll('[data-orientation]')\r\n  const cardWidth = panel.querySelector('#cardWidth')\r\n  const cardHeight = panel.querySelector('#cardHeight')\r\n  const imgWidth = panel.querySelector('#imgWidth')\r\n  const imgHeight = panel.querySelector('#imgHeight')\r\n  const imgX = panel.querySelector('#imgX')\r\n  const imgY = panel.querySelector('#imgY')\r\n  const resetDimensions = panel.querySelector('#resetDimensions')\r\n  const mainProfileFieldset = panel.querySelector('[data-role=\"main-profile\"]')\r\n  const mainProfileSelect = mainProfileFieldset?.querySelector('#mainProfileSelect')\r\n  const mainProfileName = mainProfileFieldset?.querySelector('[data-role=\"main-profile-name\"]')\r\n  if (mainProfileSelect) mainProfileSelect.disabled = true\r\n  const imageUploader = panel.querySelector('[data-role=\"image-uploader\"]')\r\n  const assetUploadInput = imageUploader?.querySelector('#assetUpload')\r\n  const assetUploadFeedback = imageUploader?.querySelector('[data-role=\"upload-feedback\"]')\r\n  const assetUploadResult = imageUploader?.querySelector('[data-role=\"upload-result\"]')\r\n  const assetUploadUrlOutput = imageUploader?.querySelector('[data-role=\"upload-url\"]')\r\n  const assetUploadOpenLink = imageUploader?.querySelector('[data-role=\"open-upload\"]')\r\n  const copyUploadUrlBtn = imageUploader?.querySelector('[data-action=\"copy-upload-url\"]')\r\n  const manualUrlInput = imageUploader?.querySelector('#assetUrl')\r\n  const copyManualUrlBtn = imageUploader?.querySelector('[data-action=\"copy-manual-url\"]')\r\n\r\n  const imageUploaderHome = imageUploader ? {\r\n    parent: imageUploader.parentElement,\r\n    nextSibling: imageUploader.nextSibling\r\n  } : null\r\n\r\n  let imageUploaderCurrentForm = null\r\n  let imageUploaderCurrentDatumId = null\r\n\r\n  function getActiveImageFieldId() {\r\n    const value = imageField?.value?.trim()\r\n    return value || 'avatar'\r\n  }\r\n\r\n  function getActiveDatum() {\r\n    if (!imageUploaderCurrentDatumId || !editTreeInstance?.store?.getDatum) return null\r\n    try {\r\n      return editTreeInstance.store.getDatum(imageUploaderCurrentDatumId) || null\r\n    } catch (error) {\r\n      console.error('Impossible de r\u00E9cup\u00E9rer le profil actif pour le t\u00E9l\u00E9versement', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  function normaliseUrl(rawUrl) {\r\n    if (!rawUrl) return ''\r\n    try {\r\n      return new URL(rawUrl, window.location.origin).toString()\r\n    } catch (error) {\r\n      return String(rawUrl)\r\n    }\r\n  }\r\n\r\n  function applyImageToActiveProfile(rawUrl, { origin = 'manual', sizeBytes } = {}) {\r\n    const absoluteUrl = normaliseUrl(rawUrl)\r\n    if (!absoluteUrl) return\r\n\r\n    const targetFieldId = getActiveImageFieldId()\r\n    const escapedFieldId = targetFieldId.replace(/\"/g, '\\\\\"')\r\n    let formUpdated = false\r\n    let datumUpdated = false\r\n\r\n    if (imageUploaderCurrentForm) {\r\n      const targetInput = imageUploaderCurrentForm.querySelector(`[name=\"${escapedFieldId}\"]`)\r\n      if (targetInput && targetInput instanceof HTMLInputElement) {\r\n        if (targetInput.value !== absoluteUrl) {\r\n          targetInput.value = absoluteUrl\r\n          targetInput.dispatchEvent(new Event('input', { bubbles: true }))\r\n        }\r\n        formUpdated = true\r\n      } else if (targetInput && targetInput instanceof HTMLTextAreaElement) {\r\n        if (targetInput.value !== absoluteUrl) {\r\n          targetInput.value = absoluteUrl\r\n          targetInput.dispatchEvent(new Event('input', { bubbles: true }))\r\n        }\r\n        formUpdated = true\r\n      }\r\n    }\r\n\r\n    const activeDatum = getActiveDatum()\r\n    if (activeDatum) {\r\n      if (!activeDatum.data) activeDatum.data = {}\r\n      if (activeDatum.data[targetFieldId] !== absoluteUrl) {\r\n        activeDatum.data[targetFieldId] = absoluteUrl\r\n        datumUpdated = true\r\n      }\r\n    }\r\n\r\n    if (datumUpdated) {\r\n      try {\r\n        chart.updateTree({ initial: false, tree_position: 'inherit' })\r\n      } catch (error) {\r\n        console.error('Impossible de rafra\u00EEchir le graphique apr\u00E8s mise \u00E0 jour de l\u2019image', error)\r\n      }\r\n      scheduleAutoSave()\r\n    }\r\n\r\n    if (manualUrlInput) manualUrlInput.value = absoluteUrl\r\n\r\n    const appliedSomewhere = formUpdated || datumUpdated\r\n    if (origin === 'upload') {\r\n      if (appliedSomewhere) {\r\n        const sizeMessage = sizeBytes ? ` (${formatBytes(sizeBytes)})` : ''\r\n        setUploadFeedback(`Image t\u00E9l\u00E9vers\u00E9e${sizeMessage} et appliqu\u00E9e au profil.`, 'success')\r\n        setStatus('Image appliqu\u00E9e au profil \u2705', 'success')\r\n      } else {\r\n        const sizeMessage = sizeBytes ? ` (${formatBytes(sizeBytes)})` : ''\r\n        setUploadFeedback(`Image t\u00E9l\u00E9vers\u00E9e${sizeMessage}. S\u00E9lectionnez un profil \u00E9ditable pour l\u2019appliquer.`, 'info')\r\n      }\r\n    } else if (appliedSomewhere) {\r\n      setUploadFeedback('Image appliqu\u00E9e au profil.', 'success')\r\n      setStatus('Image appliqu\u00E9e au profil \u2705', 'success')\r\n    } else {\r\n      setUploadFeedback('S\u00E9lectionnez un profil \u00E9ditable pour appliquer l\u2019image.', 'info')\r\n    }\r\n  }\r\n\r\n  function populateUploaderFromDatum() {\r\n    const targetFieldId = getActiveImageFieldId()\r\n    const activeDatum = getActiveDatum()\r\n    const existingValue = activeDatum?.data?.[targetFieldId] || ''\r\n\r\n    if (!existingValue) {\r\n      clearUploadResult()\r\n      if (manualUrlInput) manualUrlInput.value = ''\r\n      setUploadFeedback('Formats recommand\u00E9s : JPG, PNG, WebP.', 'info')\r\n      return\r\n    }\r\n\r\n    const absoluteUrl = showUploadResult(existingValue, { silent: true })\r\n    if (manualUrlInput) manualUrlInput.value = absoluteUrl\r\n    setUploadFeedback('Image actuelle du profil charg\u00E9e.', 'info')\r\n  }\r\n\r\n  function restoreImageUploaderToPanel() {\r\n    if (!imageUploader || !imageUploaderHome?.parent) return\r\n    if (imageUploaderCurrentForm) {\r\n      imageUploaderCurrentForm = null\r\n    }\r\n    imageUploaderCurrentDatumId = null\r\n    const { parent, nextSibling } = imageUploaderHome\r\n    if (nextSibling && parent.contains(nextSibling)) {\r\n      parent.insertBefore(imageUploader, nextSibling)\r\n    } else {\r\n      parent.appendChild(imageUploader)\r\n    }\r\n    imageUploader.classList.remove('is-modal-context')\r\n    clearUploadResult()\r\n    if (manualUrlInput) manualUrlInput.value = ''\r\n    setUploadFeedback('Importez une image ou collez une URL publique. Formats recommand\u00E9s : JPG, PNG, WebP.', 'info')\r\n  }\r\n\r\n  function injectImageUploaderIntoForm(form) {\r\n    if (!imageUploader || !form) return\r\n    if (imageUploaderCurrentForm === form) return\r\n\r\n    restoreImageUploaderToPanel()\r\n\r\n    const buttons = form.querySelector('.f3-form-buttons')\r\n    if (buttons && buttons.parentNode) {\r\n      buttons.parentNode.insertBefore(imageUploader, buttons)\r\n    } else {\r\n      form.appendChild(imageUploader)\r\n    }\r\n    imageUploader.classList.add('is-modal-context')\r\n    imageUploaderCurrentForm = form\r\n  }\r\n\r\n  function handleFormCreation({ cont, form_creator }) {\r\n    if (!imageUploader) return\r\n    const form = cont?.querySelector?.('form')\r\n    if (!form) {\r\n      restoreImageUploaderToPanel()\r\n      return\r\n    }\r\n\r\n    const isEditable = form_creator?.editable !== false && !form_creator?.no_edit\r\n    if (!isEditable) {\r\n      if (form.contains(imageUploader)) {\r\n        restoreImageUploaderToPanel()\r\n      }\r\n      return\r\n    }\r\n\r\n    injectImageUploaderIntoForm(form)\r\n    imageUploaderCurrentDatumId = form_creator?.datum_id || null\r\n    populateUploaderFromDatum()\r\n  }\r\n\r\n  function teardownImageUploader() {\r\n    restoreImageUploaderToPanel()\r\n  }\r\n\r\n  if (imageUploader && imageUploaderHome?.parent && imageUploader.parentElement !== imageUploaderHome.parent) {\r\n    restoreImageUploaderToPanel()\r\n  }\r\n\r\n  const MAX_UPLOAD_SIZE = 5 * 1024 * 1024\r\n\r\n  function formatBytes(bytes) {\r\n    if (!Number.isFinite(bytes)) return ''\r\n    if (bytes < 1024) return `${bytes} o`\r\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} Ko`\r\n    return `${(bytes / (1024 * 1024)).toFixed(2)} Mo`\r\n  }\r\n\r\n  function setUploadFeedback(message, status = 'info') {\r\n    if (!assetUploadFeedback) return\r\n    assetUploadFeedback.textContent = message\r\n    assetUploadFeedback.dataset.status = status\r\n  }\r\n\r\n  function clearUploadResult() {\r\n    if (!assetUploadResult) return\r\n    assetUploadResult.classList.add('hidden')\r\n    assetUploadResult.dataset.url = ''\r\n    if (assetUploadUrlOutput) assetUploadUrlOutput.textContent = ''\r\n    if (assetUploadOpenLink) {\r\n      assetUploadOpenLink.href = '#'\r\n      assetUploadOpenLink.classList.add('hidden')\r\n    }\r\n  }\r\n\r\n  function showUploadResult(url, { silent = false } = {}) {\r\n    if (!assetUploadResult) return ''\r\n    const absoluteUrl = normaliseUrl(url)\r\n\r\n    assetUploadResult.dataset.url = absoluteUrl\r\n    if (assetUploadUrlOutput) assetUploadUrlOutput.textContent = absoluteUrl\r\n    if (assetUploadOpenLink) {\r\n      assetUploadOpenLink.href = absoluteUrl\r\n      assetUploadOpenLink.classList.remove('hidden')\r\n    }\r\n    assetUploadResult.classList.remove('hidden')\r\n    if (manualUrlInput) manualUrlInput.value = absoluteUrl\r\n    if (!silent) setUploadFeedback('Image pr\u00EAte \u00E0 \u00EAtre appliqu\u00E9e.', 'info')\r\n\r\n    return absoluteUrl\r\n  }\r\n\r\n  async function copyToClipboard(value, { successMessage = 'Copi\u00E9 dans le presse-papiers \u2705', errorMessage = 'Impossible de copier.' } = {}) {\r\n    if (!value) {\r\n      setUploadFeedback('Aucune URL \u00E0 copier.', 'error')\r\n      return\r\n    }\r\n    try {\r\n      if (navigator.clipboard?.writeText) {\r\n        await navigator.clipboard.writeText(value)\r\n      } else {\r\n        const temp = document.createElement('textarea')\r\n        temp.value = value\r\n        temp.setAttribute('readonly', '')\r\n        temp.style.position = 'absolute'\r\n        temp.style.left = '-9999px'\r\n        document.body.append(temp)\r\n        temp.select()\r\n        document.execCommand('copy')\r\n        temp.remove()\r\n      }\r\n      setStatus(successMessage, 'success')\r\n      setUploadFeedback(successMessage, 'success')\r\n    } catch (error) {\r\n      console.error(error)\r\n      setStatus(errorMessage, 'error')\r\n      setUploadFeedback(errorMessage, 'error')\r\n    }\r\n  }\r\n\r\n  async function handleFileUpload(file) {\r\n    if (!file) return\r\n    clearUploadResult()\r\n\r\n    if (!file.type || !file.type.startsWith('image/')) {\r\n      setUploadFeedback('Format non pris en charge. S\u00E9lectionnez une image (JPEG, PNG, WebP\u2026).', 'error')\r\n      return\r\n    }\r\n\r\n    if (file.size > MAX_UPLOAD_SIZE) {\r\n      setUploadFeedback(`Fichier trop volumineux (${formatBytes(file.size)}). Limite 5 Mo.`, 'error')\r\n      return\r\n    }\r\n\r\n    setUploadFeedback('T\u00E9l\u00E9versement en cours\u2026', 'saving')\r\n    setStatus('T\u00E9l\u00E9versement de l\u2019image\u2026', 'saving')\r\n\r\n    const formData = new FormData()\r\n    formData.append('file', file, file.name)\r\n\r\n    try {\r\n      const response = await fetch('/api/uploads', {\r\n        method: 'POST',\r\n        body: formData\r\n      })\r\n\r\n      if (!response.ok) {\r\n        let message = `Erreur serveur (${response.status})`\r\n        try {\r\n          const payload = await response.json()\r\n          if (payload?.message) message = payload.message\r\n        } catch (error) {\r\n          // ignore JSON parse errors\r\n        }\r\n        throw new Error(message)\r\n      }\r\n\r\n      const payload = await response.json()\r\n      const uploadedUrl = payload?.url\r\n      if (!uploadedUrl) {\r\n        throw new Error('R\u00E9ponse du serveur invalide (URL manquante).')\r\n      }\r\n\r\n      const absoluteUrl = showUploadResult(uploadedUrl)\r\n      applyImageToActiveProfile(absoluteUrl, { origin: 'upload', sizeBytes: file.size })\r\n    } catch (error) {\r\n      console.error(error)\r\n      setUploadFeedback(error.message || '\u00C9chec du t\u00E9l\u00E9versement.', 'error')\r\n      setStatus(`T\u00E9l\u00E9versement \u00E9chou\u00E9: ${error.message || 'Erreur inconnue'}`, 'error')\r\n      clearUploadResult()\r\n    }\r\n  }\r\n\r\n  clearUploadResult()\r\n  if (assetUploadFeedback) {\r\n    setUploadFeedback(assetUploadFeedback.textContent || 'Formats recommand\u00E9s : JPG, PNG, WebP.', 'info')\r\n  }\r\n\r\n  function setOrientationButtonsState(orientation) {\r\n    orientationButtons.forEach(button => {\r\n      const isActive = button.dataset.orientation === orientation\r\n      button.classList.toggle('active', isActive)\r\n    })\r\n  }\r\n\r\n  function refreshConfigControls() {\r\n    if (transitionInput) transitionInput.value = chartConfig.transitionTime?.toString() ?? ''\r\n    if (cardXSpacing) cardXSpacing.value = chartConfig.cardXSpacing?.toString() ?? ''\r\n    if (cardYSpacing) cardYSpacing.value = chartConfig.cardYSpacing?.toString() ?? ''\r\n    if (emptyLabel) {\r\n      const label = chartConfig.singleParentEmptyCardLabel ?? DEFAULT_CHART_CONFIG.singleParentEmptyCardLabel\r\n      emptyLabel.value = label\r\n    }\r\n    if (ancestryDepthSelect) ancestryDepthSelect.value = depthToSelectValue(chartConfig.ancestryDepth, DEFAULT_CHART_CONFIG.ancestryDepth)\r\n    if (progenyDepthSelect) progenyDepthSelect.value = depthToSelectValue(chartConfig.progenyDepth, DEFAULT_CHART_CONFIG.progenyDepth)\r\n    if (miniTreeToggle) miniTreeToggle.checked = chartConfig.miniTree !== false\r\n    if (duplicateToggle) duplicateToggle.checked = chartConfig.duplicateBranchToggle !== false\r\n    setOrientationButtonsState(chartConfig.orientation || DEFAULT_CHART_CONFIG.orientation)\r\n  }\r\n\r\n  function commitConfigUpdate(partialConfig = {}, { treePosition = 'inherit', refresh = true } = {}) {\r\n    chartConfig = { ...chartConfig, ...partialConfig }\r\n    applyChartConfigToChart(chart)\r\n    if (card && typeof card.setMiniTree === 'function') {\r\n      card.setMiniTree(chartConfig.miniTree !== false)\r\n    }\r\n    if (refresh) {\r\n      const prevState = isApplyingConfig\r\n      isApplyingConfig = true\r\n      refreshConfigControls()\r\n      isApplyingConfig = prevState\r\n    }\r\n    chart.updateTree({ initial: false, tree_position: treePosition })\r\n    lastSnapshotString = null\r\n    if (!isApplyingConfig) {\r\n      scheduleAutoSave()\r\n    }\r\n  }\r\n\r\n  function parseNumberInput(input, fallback) {\r\n    if (!input) return fallback\r\n    const value = Number(input.value)\r\n    return Number.isFinite(value) ? value : fallback\r\n  }\r\n\r\n  function depthToSelectValue(value, fallback) {\r\n    if (value === null) return ''\r\n    if (typeof value === 'number' && Number.isFinite(value) && value >= 0) {\r\n      return String(Math.floor(value))\r\n    }\r\n    if (typeof fallback === 'number' && Number.isFinite(fallback) && fallback >= 0) {\r\n      return String(Math.floor(fallback))\r\n    }\r\n    return ''\r\n  }\r\n\r\n  function parseDepthSelectValue(select, fallback) {\r\n    if (!select) return fallback\r\n    if (select.value === '') return null\r\n    const value = Number(select.value)\r\n    if (Number.isFinite(value) && value >= 0) {\r\n      return Math.floor(value)\r\n    }\r\n    return fallback\r\n  }\r\n\r\n  function ensureFieldLabel(value, label) {\r\n    const key = normalizeFieldKey(value)\r\n    if (label) {\r\n      fieldLabelStore.set(key, label.trim() || value)\r\n    } else if (!fieldLabelStore.has(key)) {\r\n      fieldLabelStore.set(key, value)\r\n    }\r\n    return fieldLabelStore.get(key) || value\r\n  }\r\n\r\n  function createFieldDescriptors(fieldValues) {\r\n    const descriptors = sanitizeFieldValues(fieldValues).map(value => {\r\n      const key = normalizeFieldKey(value)\r\n      const label = ensureFieldLabel(value, fieldLabelStore.get(key))\r\n      return createFieldDescriptor(key, value, label)\r\n    })\r\n    return appendUnionFieldDescriptors(descriptors, fieldLabelStore)\r\n  }\r\n\r\n  function updateMainProfileDisplay(id) {\r\n    if (!mainProfileName) return\r\n    if (!id) {\r\n      mainProfileName.textContent = '\u2014'\r\n      return\r\n    }\r\n    const datum = editTreeInstance?.store?.getDatum?.(id)\r\n    if (!datum) {\r\n      mainProfileName.textContent = '\u2014'\r\n      return\r\n    }\r\n    mainProfileName.textContent = buildPersonLabel(datum)\r\n  }\r\n\r\n  function refreshMainProfileOptions({ keepSelection = true } = {}) {\r\n    if (!mainProfileSelect) return\r\n    const persons = getAllPersons()\r\n    const previousValue = keepSelection ? mainProfileSelect.value : ''\r\n    mainProfileSelect.innerHTML = ''\r\n\r\n    if (!persons.length) {\r\n      const placeholder = document.createElement('option')\r\n      placeholder.value = ''\r\n      placeholder.textContent = 'Aucune personne disponible'\r\n      mainProfileSelect.append(placeholder)\r\n      mainProfileSelect.disabled = true\r\n      updateMainProfileDisplay(null)\r\n      return\r\n    }\r\n\r\n    const fragment = document.createDocumentFragment()\r\n    persons.forEach(datum => {\r\n      if (!datum || !datum.id) return\r\n      const option = document.createElement('option')\r\n      option.value = datum.id\r\n      option.textContent = buildPersonLabel(datum)\r\n      fragment.append(option)\r\n    })\r\n    mainProfileSelect.append(fragment)\r\n    mainProfileSelect.disabled = false\r\n\r\n    const availableIds = new Set(persons.map(d => d.id))\r\n    const preferred = []\r\n    if (keepSelection && previousValue && availableIds.has(previousValue)) preferred.push(previousValue)\r\n\r\n    const configMain = typeof chartConfig.mainId === 'string' ? chartConfig.mainId : ''\r\n    if (configMain && availableIds.has(configMain)) preferred.push(configMain)\r\n\r\n    const storeMainId = chart.store && typeof chart.store.getMainId === 'function' ? chart.store.getMainId() : ''\r\n    if (storeMainId && availableIds.has(storeMainId)) preferred.push(storeMainId)\r\n\r\n    if (persons[0]?.id) preferred.push(persons[0].id)\r\n\r\n    const targetValue = preferred.find(Boolean) || ''\r\n    if (targetValue) {\r\n      mainProfileSelect.value = targetValue\r\n    } else {\r\n      mainProfileSelect.selectedIndex = 0\r\n    }\r\n\r\n    updateMainProfileDisplay(mainProfileSelect.value || null)\r\n  }\r\n\r\n  function syncMainProfileSelection({ scheduleSaveIfChanged = false } = {}) {\r\n    if (!chart.store || typeof chart.store.getMainId !== 'function') {\r\n      return\r\n    }\r\n\r\n    const storeMainId = chart.store.getMainId()\r\n    const persons = getAllPersons()\r\n    const availableIds = new Set(persons.map(d => d && d.id).filter(Boolean))\r\n    const currentConfigMain = typeof chartConfig.mainId === 'string' && chartConfig.mainId.trim() ? chartConfig.mainId.trim() : null\r\n\r\n    let nextConfigMain = currentConfigMain\r\n\r\n    if (nextConfigMain && !availableIds.has(nextConfigMain)) {\r\n      nextConfigMain = null\r\n    }\r\n\r\n    if (!nextConfigMain && storeMainId && availableIds.has(storeMainId)) {\r\n      nextConfigMain = storeMainId\r\n    }\r\n\r\n    if (!nextConfigMain && persons.length) {\r\n      const fallbackId = persons[0]?.id || null\r\n      if (fallbackId && availableIds.has(fallbackId)) {\r\n        nextConfigMain = fallbackId\r\n      }\r\n    }\r\n\r\n    if (nextConfigMain !== currentConfigMain) {\r\n      chartConfig = { ...chartConfig, mainId: nextConfigMain }\r\n      lastSnapshotString = null\r\n      if (scheduleSaveIfChanged && !isApplyingConfig) {\r\n        scheduleAutoSave()\r\n      }\r\n    }\r\n\r\n    if (mainProfileSelect) {\r\n      if (nextConfigMain && ![...mainProfileSelect.options].some(option => option.value === nextConfigMain)) {\r\n        refreshMainProfileOptions({ keepSelection: false })\r\n      }\r\n\r\n      if (!nextConfigMain && !mainProfileSelect.options.length) {\r\n        refreshMainProfileOptions({ keepSelection: false })\r\n      }\r\n\r\n      if (nextConfigMain) {\r\n        mainProfileSelect.value = nextConfigMain\r\n        mainProfileSelect.disabled = false\r\n      }\r\n    }\r\n\r\n    updateMainProfileDisplay(nextConfigMain || null)\r\n  }\r\n\r\n  function setMainProfile(id, { openEditor = true, suppressSave = false } = {}) {\r\n    if (!id) return\r\n    const persons = getAllPersons()\r\n    if (!persons.some(person => person.id === id)) {\r\n      refreshMainProfileOptions({ keepSelection: false })\r\n      return\r\n    }\r\n\r\n    const configChanged = chartConfig.mainId !== id\r\n    if (configChanged) {\r\n      chartConfig = { ...chartConfig, mainId: id }\r\n    }\r\n\r\n    if (configChanged && !suppressSave) {\r\n      lastSnapshotString = null\r\n      if (!isApplyingConfig) {\r\n        scheduleAutoSave()\r\n      }\r\n    }\r\n\r\n    const storeMainBefore = chart.store && typeof chart.store.getMainId === 'function'\r\n      ? chart.store.getMainId()\r\n      : null\r\n\r\n    if (chart && typeof chart.updateMainId === 'function' && storeMainBefore !== id) {\r\n      chart.updateMainId(id)\r\n      chart.updateTree({ initial: false, tree_position: 'main_to_middle' })\r\n    }\r\n\r\n    if (mainProfileSelect && mainProfileSelect.value !== id) {\r\n      mainProfileSelect.value = id\r\n      mainProfileSelect.disabled = false\r\n    }\r\n\r\n    updateMainProfileDisplay(id)\r\n\r\n    if (openEditor && editTreeInstance) {\r\n      const datum = editTreeInstance.store?.getDatum?.(id)\r\n      if (datum) editTreeInstance.open(datum)\r\n    }\r\n  }\r\n\r\n  if (mainProfileSelect) {\r\n    mainProfileSelect.addEventListener('change', event => {\r\n      const { value } = event.target\r\n      if (!value) return\r\n      setMainProfile(value)\r\n    })\r\n  }\r\n\r\n  function escapeSelector(value) {\r\n    if (window.CSS?.escape) return window.CSS.escape(value)\r\n    return value.replace(/[^a-zA-Z0-9_-]/g, char => `\\\\${char}`)\r\n  }\r\n\r\n  function addRemoveButton(item) {\r\n    if (item.querySelector('.remove-field')) return\r\n    const removeBtn = document.createElement('button')\r\n    removeBtn.type = 'button'\r\n    removeBtn.className = 'remove-field'\r\n    removeBtn.textContent = 'Retirer'\r\n    removeBtn.addEventListener('click', () => {\r\n      item.remove()\r\n      updateCardDisplay()\r\n    })\r\n    item.append(removeBtn)\r\n  }\r\n\r\n  function removeDisplayFieldEntries(fieldKey) {\r\n    displayGroups.forEach(group => {\r\n      const list = group.querySelector('.field-list')\r\n      if (!list) return\r\n      const selector = `[data-field-key=\"${escapeSelector(fieldKey)}\"]`\r\n      const item = list.querySelector(selector)\r\n      if (!item) return\r\n\r\n      if (item.dataset.custom === 'true') {\r\n        item.remove()\r\n      } else {\r\n        const defaults = displayDefaultsByRow.get(group.dataset.displayRow)\r\n        const defaultChecked = defaults?.get(fieldKey)\r\n        const checkbox = item.querySelector('input[type=\"checkbox\"]')\r\n        if (checkbox && typeof defaultChecked === 'boolean') {\r\n          checkbox.checked = defaultChecked\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  function getDisplayRowsForField(field) {\r\n    if (!chartConfig.cardDisplay) return []\r\n    const key = normalizeFieldKey(field)\r\n    const rows = []\r\n    chartConfig.cardDisplay.forEach((row, index) => {\r\n      if (row.some(value => normalizeFieldKey(value) === key)) {\r\n        rows.push(String(index + 1))\r\n      }\r\n    })\r\n    return rows\r\n  }\r\n\r\n  function ensureConfigEditableItems() {\r\n    if (!Array.isArray(chartConfig.editableFields)) return\r\n    chartConfig.editableFields.forEach(field => {\r\n      const key = normalizeFieldKey(field)\r\n      if (REL_REFERENCE_FIELD_KEYS.has(key) || key === UNION_PARAGRAPH_KEY) return\r\n      if (!key) return\r\n      const label = ensureFieldLabel(field, fieldLabelStore.get(key))\r\n      const selector = `[data-field-key=\"${escapeSelector(key)}\"]`\r\n      if (editableList?.querySelector(selector)) return\r\n      createEditableItem({\r\n        value: field,\r\n        label,\r\n        checked: true,\r\n        removable: true,\r\n        selectRows: getDisplayRowsForField(field)\r\n      })\r\n    })\r\n  }\r\n\r\n  function applyConfigToEditableControls() {\r\n    if (!editableList) return\r\n    const desired = new Set((chartConfig.editableFields || []).map(normalizeFieldKey))\r\n    editableList.querySelectorAll('input[type=\"checkbox\"]').forEach(input => {\r\n      const key = normalizeFieldKey(input.value)\r\n      input.checked = desired.has(key)\r\n    })\r\n  }\r\n\r\n  function applyConfigToDisplayControls() {\r\n    displayGroups.forEach((group, index) => {\r\n      const desiredRow = (chartConfig.cardDisplay && chartConfig.cardDisplay[index]) || []\r\n      const desiredSet = new Set(desiredRow.map(normalizeFieldKey))\r\n      group.querySelectorAll('input[type=\"checkbox\"]').forEach(input => {\r\n        const key = normalizeFieldKey(input.value)\r\n        input.checked = desiredSet.has(key)\r\n      })\r\n    })\r\n  }\r\n\r\n  function createDisplayItem(group, { value, label, defaultChecked = false, removable = false }) {\r\n    const list = group.querySelector('.field-list')\r\n    if (!list) return { item: null, isNew: false }\r\n\r\n  const key = normalizeFieldKey(value)\r\n    const selector = `[data-field-key=\"${escapeSelector(key)}\"]`\r\n    const displayLabel = ensureFieldLabel(value, label)\r\n    let item = list.querySelector(selector)\r\n\r\n    if (item) {\r\n      const textEl = item.querySelector('label span')\r\n      if (textEl) textEl.textContent = displayLabel\r\n      if (removable) {\r\n        item.dataset.custom = 'true'\r\n        addRemoveButton(item)\r\n      }\r\n      return { item, isNew: false }\r\n    }\r\n\r\n    item = document.createElement('div')\r\n    item.className = 'display-item'\r\n    item.dataset.fieldKey = key\r\n    if (removable) item.dataset.custom = 'true'\r\n\r\n    const labelEl = document.createElement('label')\r\n    const checkbox = document.createElement('input')\r\n    checkbox.type = 'checkbox'\r\n    checkbox.value = value\r\n    checkbox.checked = defaultChecked\r\n\r\n    const textEl = document.createElement('span')\r\n    textEl.textContent = displayLabel\r\n\r\n    labelEl.append(checkbox, textEl)\r\n    item.append(labelEl)\r\n\r\n    if (removable) {\r\n      addRemoveButton(item)\r\n    }\r\n\r\n    list.append(item)\r\n    return { item, isNew: true }\r\n  }\r\n\r\n  function createEditableItem({ value, label, checked = true, removable = false, selectRows = [] }) {\r\n    if (!editableList) return\r\n\r\n    const key = normalizeFieldKey(value)\r\n    const displayLabel = ensureFieldLabel(value, label)\r\n    const selector = `[data-field-key=\"${escapeSelector(key)}\"]`\r\n    let item = editableList.querySelector(selector)\r\n    const isNew = !item\r\n\r\n    if (!item) {\r\n      item = document.createElement('div')\r\n      item.className = 'editable-item'\r\n      item.dataset.fieldKey = key\r\n      if (removable) item.dataset.custom = 'true'\r\n\r\n      const labelEl = document.createElement('label')\r\n      const checkbox = document.createElement('input')\r\n      checkbox.type = 'checkbox'\r\n      checkbox.value = value\r\n      checkbox.checked = checked\r\n\r\n      const textEl = document.createElement('span')\r\n      textEl.textContent = displayLabel\r\n\r\n      labelEl.append(checkbox, textEl)\r\n      item.append(labelEl)\r\n\r\n      if (removable) {\r\n        const removeBtn = document.createElement('button')\r\n        removeBtn.type = 'button'\r\n        removeBtn.className = 'remove-field'\r\n        removeBtn.textContent = 'Retirer'\r\n        removeBtn.addEventListener('click', () => {\r\n          item.remove()\r\n          removeDisplayFieldEntries(key)\r\n          applyEditableFields()\r\n        })\r\n        item.append(removeBtn)\r\n      }\r\n\r\n      editableList.append(item)\r\n    } else {\r\n      const checkbox = item.querySelector('input[type=\"checkbox\"]')\r\n      if (checkbox && typeof checked === 'boolean') checkbox.checked = checked\r\n      const textEl = item.querySelector('label span')\r\n      if (textEl) textEl.textContent = displayLabel\r\n      if (removable) item.dataset.custom = 'true'\r\n    }\r\n\r\n    const selectRowSet = new Set((selectRows || []).map(String))\r\n\r\n    displayGroups.forEach(group => {\r\n      const rowKey = group.dataset.displayRow\r\n      const defaults = displayDefaultsByRow.get(rowKey)\r\n      const defaultChecked = defaults?.get(key)\r\n      const shouldCheck = defaultChecked !== undefined ? defaultChecked : selectRowSet.has(rowKey)\r\n      const removableForGroup = removable\r\n      const { item: displayItem, isNew: created } = createDisplayItem(group, {\r\n        value,\r\n        label: displayLabel,\r\n        defaultChecked: shouldCheck,\r\n        removable: removableForGroup\r\n      })\r\n\r\n      if (!displayItem) return\r\n      if (!created && selectRowSet.has(rowKey)) {\r\n        const checkbox = displayItem.querySelector('input[type=\"checkbox\"]')\r\n        if (checkbox) checkbox.checked = true\r\n      }\r\n    })\r\n  }\r\n\r\n  function getSelectedValues(group) {\r\n    if (!group) return []\r\n    return [...group.querySelectorAll('input[type=\"checkbox\"]')]\r\n      .filter(input => input.checked)\r\n      .map(input => input.value)\r\n  }\r\n\r\n  function areFieldListsEqual(a = [], b = []) {\r\n    if (a.length !== b.length) return false\r\n    return a.every((value, index) => normalizeFieldKey(value) === normalizeFieldKey(b[index]))\r\n  }\r\n\r\n  function areCardDisplaysEqual(a = [], b = []) {\r\n    if (a.length !== b.length) return false\r\n    return a.every((row, index) => areFieldListsEqual(row, b[index]))\r\n  }\r\n\r\n  function syncDisplayItemsWithEditable(activeKeys) {\r\n    displayGroups.forEach(group => {\r\n      const items = group.querySelectorAll('.display-item')\r\n      items.forEach(item => {\r\n        const key = item.dataset.fieldKey\r\n        const checkbox = item.querySelector('input[type=\"checkbox\"]')\r\n        const isActive = activeKeys.has(key)\r\n        item.classList.toggle('is-disabled', !isActive)\r\n        if (!checkbox) return\r\n        checkbox.disabled = !isActive\r\n        if (!isActive && checkbox.checked) {\r\n          checkbox.checked = false\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  function updateCardDisplay({ suppressSave = false } = {}) {\r\n    const row1Group = displayGroupMap.get('1')\r\n    const row2Group = displayGroupMap.get('2')\r\n    const row1 = sanitizeFieldValues(getSelectedValues(row1Group))\r\n    const row2 = sanitizeFieldValues(getSelectedValues(row2Group))\r\n    const fallback = (row1[0])\r\n      || (currentEditableFields.length ? currentEditableFields[0] : (DEFAULT_EDITABLE_FIELDS[0] || 'first name'))\r\n    const appliedRow1 = row1.length ? row1 : [fallback]\r\n    const appliedRows = [appliedRow1, row2]\r\n\r\n    card.setCardDisplay(appliedRows)\r\n    chart.updateTree({ initial: false, tree_position: 'inherit' })\r\n\r\n    const displayChanged = !areCardDisplaysEqual(chartConfig.cardDisplay, appliedRows)\r\n    if (displayChanged) {\r\n      chartConfig = {\r\n        ...chartConfig,\r\n        cardDisplay: appliedRows.map(row => [...row])\r\n      }\r\n      if (!suppressSave) {\r\n        lastSnapshotString = null\r\n        if (!isApplyingConfig) scheduleAutoSave()\r\n      }\r\n    }\r\n  }\r\n\r\n  function applyEditableFields({ suppressSave = false } = {}) {\r\n    if (!editTreeInstance || !editableList) return\r\n    const values = [...editableList.querySelectorAll('input[type=\"checkbox\"]')]\r\n      .filter(input => input.checked)\r\n      .map(input => input.value)\r\n    let applied = values.length ? values : (chartConfig.editableFields.length ? [...chartConfig.editableFields] : ['first name'])\r\n    applied = removeUnionParagraphField(sanitizeFieldValues(applied))\r\n    if (!applied.length) {\r\n      const fallbackField = DEFAULT_EDITABLE_FIELDS[0] || 'first name'\r\n      applied = [fallbackField]\r\n      if (editableList) {\r\n        const fallbackKey = normalizeFieldKey(fallbackField)\r\n        const selector = `[data-field-key=\"${escapeSelector(fallbackKey)}\"] input[type=\"checkbox\"]`\r\n        const fallbackInput = editableList.querySelector(selector)\r\n        if (fallbackInput) fallbackInput.checked = true\r\n      }\r\n    }\r\n\r\n  currentEditableFields = removeUnionParagraphField([...applied])\r\n    const fieldDescriptors = createFieldDescriptors(applied)\r\n    editTreeInstance.setFields(fieldDescriptors)\r\n\r\n    const activeKeys = new Set(applied.map(normalizeFieldKey))\r\n    syncDisplayItemsWithEditable(activeKeys)\r\n\r\n    const editableChanged = !areFieldListsEqual(chartConfig.editableFields, applied)\r\n    if (editableChanged) {\r\n      chartConfig = { ...chartConfig, editableFields: [...applied] }\r\n      if (!suppressSave) {\r\n        lastSnapshotString = null\r\n        if (!isApplyingConfig) scheduleAutoSave()\r\n      }\r\n    }\r\n\r\n    updateCardDisplay({ suppressSave })\r\n\r\n    const datum = editTreeInstance.store.getMainDatum()\r\n    if (datum) editTreeInstance.open(datum)\r\n  }\r\n\r\n  function requestFieldDefinition() {\r\n    const rawValue = prompt('Nom du champ (cl\u00E9 dans vos donn\u00E9es) ?')\r\n    if (!rawValue) return null\r\n    const value = rawValue.trim()\r\n    if (!value) return null\r\n\r\n  const key = normalizeFieldKey(value)\r\n    const suggestedLabel = fieldLabelStore.get(key) || value\r\n    const labelInput = prompt('Libell\u00E9 affich\u00E9 pour ce champ ?', suggestedLabel)\r\n    const displayLabel = (labelInput ?? suggestedLabel).trim() || value\r\n\r\n    return { value, label: displayLabel, key }\r\n  }\r\n\r\n  function handleAddEditableField({ selectRows = [] } = {}) {\r\n    const definition = requestFieldDefinition()\r\n    if (!definition) return\r\n    const { value, label, key } = definition\r\n  const isDefault = EDITABLE_DEFAULTS.some(def => normalizeFieldKey(def.value) === key)\r\n\r\n    createEditableItem({\r\n      value,\r\n      label,\r\n      checked: true,\r\n      removable: !isDefault,\r\n      selectRows\r\n    })\r\n\r\n    applyEditableFields()\r\n  }\r\n\r\n  EDITABLE_DEFAULTS.forEach(def => {\r\n    createEditableItem({\r\n      value: def.value,\r\n      label: def.label,\r\n      checked: def.checked !== false,\r\n      removable: false\r\n    })\r\n  })\r\n\r\n  editableList?.addEventListener('change', (event) => {\r\n    if (event.target.matches('input[type=\"checkbox\"]')) {\r\n      applyEditableFields()\r\n    }\r\n  })\r\n\r\n  addEditableBtn?.addEventListener('click', () => handleAddEditableField())\r\n\r\n  displayGroups.forEach(group => {\r\n    group.addEventListener('change', (event) => {\r\n      if (event.target.matches('input[type=\"checkbox\"]')) {\r\n        updateCardDisplay()\r\n      }\r\n    })\r\n  })\r\n\r\n  imageField?.addEventListener('change', () => {\r\n    card.setCardImageField(imageField.value)\r\n    chart.updateTree({ initial: false, tree_position: 'inherit' })\r\n    populateUploaderFromDatum()\r\n  })\r\n\r\n  cardStyle?.addEventListener('change', () => {\r\n    card.setStyle(cardStyle.value)\r\n    chart.updateTree({ initial: false, tree_position: 'inherit' })\r\n  })\r\n\r\n  transitionInput?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const fallback = chartConfig.transitionTime ?? DEFAULT_CHART_CONFIG.transitionTime\r\n    const value = parseNumberInput(transitionInput, fallback)\r\n    const safeValue = Math.max(0, value)\r\n    if (safeValue === chartConfig.transitionTime) return\r\n    commitConfigUpdate({ transitionTime: safeValue })\r\n  })\r\n\r\n  cardYSpacing?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const fallback = chartConfig.cardYSpacing ?? DEFAULT_CHART_CONFIG.cardYSpacing\r\n    const value = parseNumberInput(cardYSpacing, fallback)\r\n    const safeValue = value > 0 ? value : fallback\r\n    if (safeValue === chartConfig.cardYSpacing) return\r\n    commitConfigUpdate({ cardYSpacing: safeValue })\r\n  })\r\n\r\n  cardXSpacing?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const fallback = chartConfig.cardXSpacing ?? DEFAULT_CHART_CONFIG.cardXSpacing\r\n    const value = parseNumberInput(cardXSpacing, fallback)\r\n    const safeValue = value > 0 ? value : fallback\r\n    if (safeValue === chartConfig.cardXSpacing) return\r\n    commitConfigUpdate({ cardXSpacing: safeValue })\r\n  })\r\n\r\n  ancestryDepthSelect?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const fallback = chartConfig.ancestryDepth ?? DEFAULT_CHART_CONFIG.ancestryDepth ?? null\r\n    const value = parseDepthSelectValue(ancestryDepthSelect, fallback)\r\n    if (value === chartConfig.ancestryDepth) return\r\n    commitConfigUpdate({ ancestryDepth: value }, { treePosition: 'main_to_middle' })\r\n  })\r\n\r\n  progenyDepthSelect?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const fallback = chartConfig.progenyDepth ?? DEFAULT_CHART_CONFIG.progenyDepth ?? null\r\n    const value = parseDepthSelectValue(progenyDepthSelect, fallback)\r\n    if (value === chartConfig.progenyDepth) return\r\n    commitConfigUpdate({ progenyDepth: value }, { treePosition: 'main_to_middle' })\r\n  })\r\n\r\n  miniTreeToggle?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const enabled = miniTreeToggle.checked\r\n    const previous = chartConfig.miniTree !== false\r\n    if (enabled === previous) return\r\n    commitConfigUpdate({ miniTree: enabled })\r\n  })\r\n\r\n  duplicateToggle?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const enabled = duplicateToggle.checked\r\n    const previous = chartConfig.duplicateBranchToggle !== false\r\n    if (enabled === previous) return\r\n    commitConfigUpdate({ duplicateBranchToggle: enabled }, { treePosition: 'inherit' })\r\n  })\r\n\r\n  emptyLabel?.addEventListener('change', () => {\r\n    if (isApplyingConfig) return\r\n    const label = (emptyLabel.value || '').trim() || DEFAULT_CHART_CONFIG.singleParentEmptyCardLabel\r\n    if (label === chartConfig.singleParentEmptyCardLabel) return\r\n    commitConfigUpdate({ singleParentEmptyCardLabel: label, singleParentEmptyCard: true })\r\n  })\r\n\r\n  orientationButtons?.forEach(button => {\r\n    button.addEventListener('click', () => {\r\n      const orientation = button.dataset.orientation\r\n      const nextOrientation = orientation === 'horizontal' ? 'horizontal' : 'vertical'\r\n      if (chartConfig.orientation === nextOrientation) return\r\n      commitConfigUpdate({ orientation: nextOrientation }, { treePosition: 'fit' })\r\n    })\r\n  })\r\n\r\n  function applyCardDimensions() {\r\n    const dims = {}\r\n    add('width', cardWidth)\r\n    add('height', cardHeight)\r\n    add('img_w', imgWidth)\r\n    add('img_h', imgHeight)\r\n    add('img_x', imgX)\r\n    add('img_y', imgY)\r\n\r\n    card.resetCardDim()\r\n    if (Object.keys(dims).length > 0) {\r\n      card.setCardDim(dims)\r\n    }\r\n    chart.updateTree({ initial: false, tree_position: 'inherit' })\r\n\r\n    function add(key, input) {\r\n      if (!input) return\r\n      const value = Number(input.value)\r\n      if (Number.isFinite(value)) dims[key] = value\r\n    }\r\n  }\r\n\r\n  ;[\r\n    cardWidth,\r\n    cardHeight,\r\n    imgWidth,\r\n    imgHeight,\r\n    imgX,\r\n    imgY\r\n  ].forEach(input => input?.addEventListener('change', applyCardDimensions))\r\n\r\n  resetDimensions?.addEventListener('click', () => {\r\n    ;[\r\n      [cardWidth, 240],\r\n      [cardHeight, 150],\r\n      [imgWidth, 80],\r\n      [imgHeight, 80],\r\n      [imgX, 16],\r\n      [imgY, 16]\r\n    ].forEach(([input, value]) => {\r\n      if (input) input.value = value\r\n    })\r\n    applyCardDimensions()\r\n  })\r\n\r\n  assetUploadInput?.addEventListener('change', (event) => {\r\n    const file = event.target.files && event.target.files[0]\r\n    if (file) handleFileUpload(file)\r\n    event.target.value = ''\r\n  })\r\n\r\n  copyUploadUrlBtn?.addEventListener('click', () => {\r\n    const storedUrl = assetUploadResult?.dataset?.url || assetUploadUrlOutput?.textContent?.trim()\r\n    if (storedUrl) applyImageToActiveProfile(storedUrl, { origin: 'manual' })\r\n    copyToClipboard(storedUrl, {\r\n      successMessage: 'URL du t\u00E9l\u00E9versement copi\u00E9e \u2705',\r\n      errorMessage: 'Impossible de copier l\u2019URL du t\u00E9l\u00E9versement.'\r\n    })\r\n  })\r\n\r\n  copyManualUrlBtn?.addEventListener('click', () => {\r\n    const value = manualUrlInput?.value?.trim()\r\n    if (value) applyImageToActiveProfile(value, { origin: 'manual' })\r\n    copyToClipboard(value, {\r\n      successMessage: 'Image appliqu\u00E9e et URL copi\u00E9e \u2705',\r\n      errorMessage: 'Impossible de copier ce lien.'\r\n    })\r\n  })\r\n\r\n  const previousApplyingState = isApplyingConfig\r\n  isApplyingConfig = true\r\n  ensureConfigEditableItems()\r\n  refreshConfigControls()\r\n  applyConfigToEditableControls()\r\n  applyConfigToDisplayControls()\r\n  isApplyingConfig = previousApplyingState\r\n\r\n  applyEditableFields({ suppressSave: true })\r\n\r\n  return {\r\n    refreshMainProfileOptions,\r\n    syncMainProfileSelection,\r\n    handleFormCreation,\r\n    teardown: teardownImageUploader\r\n  }\r\n}\r\n\r\nfunction removeUnionParagraphField(values = []) {\r\n  return values.filter(value => normalizeFieldKey(value) !== UNION_PARAGRAPH_KEY)\r\n}\r\n\r\nasync function initialise() {\r\n  destroyTimer()\r\n  editTreeInstance = null\r\n  lastSnapshotString = null\r\n\r\n  try {\r\n    const data = await loadTree()\r\n    setupChart(data)\r\n  } catch (error) {\r\n    console.error(error)\r\n    setStatus(`Erreur: ${error.message}`, 'error')\r\n  }\r\n}\r\n\r\nsaveBtn?.addEventListener('click', () => {\r\n  const snapshot = getSnapshot()\r\n  if (!snapshot) return\r\n  persistChanges(snapshot, { immediate: true })\r\n})\r\n\r\nreloadBtn?.addEventListener('click', () => {\r\n  initialise()\r\n})\r\n\r\nfunction hasUnsavedChanges() {\r\n  const snapshot = getSnapshot()\r\n  if (!snapshot) return false\r\n  const currentString = JSON.stringify(snapshot)\r\n  return currentString !== lastSnapshotString\r\n}\r\n\r\nwindow.addEventListener('beforeunload', (event) => {\r\n  if (!hasUnsavedChanges()) return\r\n  event.preventDefault()\r\n  event.returnValue = ''\r\n})\r\n\r\ninitialise()\r\n"],
  "mappings": "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",
  "names": ["f3", "statusEl", "saveBtn", "reloadBtn", "panel", "chartSelector", "searchRoot", "searchTarget", "searchEmptyEl", "searchLabel", "searchHint", "panelToggleBtn", "CONTROL_PANEL_STATE_KEY", "builderSearchOptions", "builderSearchReady", "setBuilderSearchState", "state", "normalizeFieldKey", "value", "sanitizeFieldValues", "values", "seen", "result", "rawValue", "trimmed", "key", "getStorageSafe", "readCollapsedState", "storage", "writeCollapsedState", "collapsed", "applyControlsCollapsedState", "toggleControlsCollapsed", "force", "next", "initialPanelCollapsed", "DISPLAY_FIELD_LABELS", "DISPLAY_DEFAULTS", "EDITABLE_DEFAULTS", "DEFAULT_CARD_DISPLAY", "UNION_PARAGRAPH_KEY", "DEFAULT_EDITABLE_FIELDS", "removeUnionParagraphField", "def", "TEXTAREA_FIELD_KEYS", "REL_REFERENCE_FIELD_KEYS", "createFieldDescriptor", "label", "buildPersonLabel", "type", "appendUnionFieldDescriptors", "descriptors", "labelLookup", "getLabel", "descriptor", "createBaseFieldLabelStore", "store", "defs", "buildFieldDescriptors", "fields", "labelStore", "safeTrim", "getAllPersons", "editTreeInstance", "persons", "datum", "person", "first", "last", "base", "birth", "createSearchOptionFromDatum", "tokens", "metaParts", "metaSeen", "addToken", "addMeta", "rawKey", "searchText", "option", "meta", "buildSearchOptionsFromPersons", "options", "a", "b", "initBuilderSearch", "chart", "id", "_a", "_b", "input", "refreshSearchOptions", "DEFAULT_CHART_CONFIG", "row", "normalizeCardDisplay", "rows", "normalized", "cloneCardDisplay", "cardDisplay", "fallbackRows", "_c", "_d", "_e", "_f", "_g", "_h", "_i", "_j", "_k", "_l", "_m", "_n", "source", "index", "fallback", "buildChartConfig", "overrides", "sanitizedEditable", "autoSaveTimer", "lastSnapshotString", "isSaving", "queuedSave", "chartConfig", "isApplyingConfig", "currentEditableFields", "activePanelTeardown", "setStatus", "message", "normaliseTreePayload", "payload", "candidateConfig", "normaliseChartConfig", "rawConfig", "_o", "_p", "_q", "_r", "_s", "config", "transition", "cardX", "cardY", "orientation", "showSiblings", "singleParentEnabled", "emptyLabel", "editableFields", "rawCardDisplay", "rawMainId", "rawAncestryDepth", "rawProgenyDepth", "rawMiniTree", "rawDuplicateToggle", "applyChartConfigToChart", "loadTree", "response", "destroyTimer", "persistChanges", "snapshot", "immediate", "structuredCloneSafe", "error", "getSnapshot", "data", "scheduleAutoSave", "setupChart", "container", "initialEditableFields", "initialFieldDescriptors", "initialCardDisplay", "card", "panelControlAPI", "searchControlAPI", "dataArray", "attachPanelControls", "initialMainId", "resolveInitialMainId", "mainDatum", "initialSnapshot", "totalPersons", "chartInstance", "availableIds", "desiredId", "storeMainId", "fallbackId", "editableFieldset", "editableList", "addEditableBtn", "displayGroups", "displayGroupMap", "group", "fieldLabelStore", "displayDefaultsByRow", "imageField", "cardStyle", "transitionInput", "cardYSpacing", "cardXSpacing", "ancestryDepthSelect", "progenyDepthSelect", "miniTreeToggle", "duplicateToggle", "orientationButtons", "cardWidth", "cardHeight", "imgWidth", "imgHeight", "imgX", "imgY", "resetDimensions", "mainProfileFieldset", "mainProfileSelect", "mainProfileName", "imageUploader", "assetUploadInput", "assetUploadFeedback", "assetUploadResult", "assetUploadUrlOutput", "assetUploadOpenLink", "copyUploadUrlBtn", "manualUrlInput", "copyManualUrlBtn", "imageUploaderHome", "imageUploaderCurrentForm", "imageUploaderCurrentDatumId", "getActiveImageFieldId", "getActiveDatum", "normaliseUrl", "rawUrl", "applyImageToActiveProfile", "origin", "sizeBytes", "absoluteUrl", "targetFieldId", "escapedFieldId", "formUpdated", "datumUpdated", "targetInput", "activeDatum", "appliedSomewhere", "sizeMessage", "formatBytes", "setUploadFeedback", "populateUploaderFromDatum", "existingValue", "clearUploadResult", "showUploadResult", "restoreImageUploaderToPanel", "parent", "nextSibling", "injectImageUploaderIntoForm", "form", "buttons", "handleFormCreation", "cont", "form_creator", "teardownImageUploader", "MAX_UPLOAD_SIZE", "bytes", "status", "url", "silent", "copyToClipboard", "successMessage", "errorMessage", "temp", "handleFileUpload", "file", "formData", "uploadedUrl", "setOrientationButtonsState", "button", "isActive", "refreshConfigControls", "depthToSelectValue", "commitConfigUpdate", "partialConfig", "treePosition", "refresh", "prevState", "parseNumberInput", "parseDepthSelectValue", "select", "ensureFieldLabel", "createFieldDescriptors", "fieldValues", "updateMainProfileDisplay", "refreshMainProfileOptions", "keepSelection", "previousValue", "placeholder", "fragment", "d", "preferred", "configMain", "targetValue", "syncMainProfileSelection", "scheduleSaveIfChanged", "currentConfigMain", "nextConfigMain", "setMainProfile", "openEditor", "suppressSave", "configChanged", "storeMainBefore", "event", "escapeSelector", "char", "addRemoveButton", "item", "removeBtn", "updateCardDisplay", "removeDisplayFieldEntries", "fieldKey", "list", "selector", "defaults", "defaultChecked", "checkbox", "getDisplayRowsForField", "field", "ensureConfigEditableItems", "createEditableItem", "applyConfigToEditableControls", "desired", "applyConfigToDisplayControls", "desiredRow", "desiredSet", "createDisplayItem", "removable", "displayLabel", "textEl", "labelEl", "checked", "selectRows", "isNew", "applyEditableFields", "selectRowSet", "rowKey", "shouldCheck", "removableForGroup", "displayItem", "created", "getSelectedValues", "areFieldListsEqual", "areCardDisplaysEqual", "syncDisplayItemsWithEditable", "activeKeys", "row1Group", "row2Group", "row1", "row2", "appliedRows", "applied", "fallbackField", "fallbackKey", "fallbackInput", "fieldDescriptors", "requestFieldDefinition", "suggestedLabel", "labelInput", "handleAddEditableField", "definition", "isDefault", "safeValue", "enabled", "previous", "nextOrientation", "applyCardDimensions", "dims", "add", "storedUrl", "previousApplyingState", "initialise", "hasUnsavedChanges"]
}
